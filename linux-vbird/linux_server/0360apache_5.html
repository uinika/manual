<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-TW" lang="zh-TW"><head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf8">
	<meta name="Author" content="VBird, 鳥哥">
	<meta name="Description" content="Linux + Apache + MySQL + PHP (LAMP) 架設詳解囉！">
	<title>鳥哥的 Linux 私房菜 -- WWW 伺服器 Apache</title>
    <script src="../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../script/index.js" type="text/javascript"></script>
	<link href="../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    </head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html')">

<center>
<div id="apDiv5">
<div> <LINK REL="SHORTCUT ICON" HREF="../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../linux_basic/0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="../linux_basic/Mandrake9.0/mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="../linux_basic/fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<table summary="本文内容的排版" style="width: 898px;" border="0" cellpadding="0" cellspacing="0">
<tbody><tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
<tr><td style="width: 16px; font-size: 6px;">　</td>
    <td width="866">

<!-- 本文的檔頭部分 -->
<div style="text-align:center">
    <a href="http://linux.vbird.org/linux_server/0360apache.php">
    <span class="text_head0">第二十章、<span class="text_head_en">WWW </span>伺服器</span></a><br>
</div>
    <div style="text-align:right">
        <span class="text_history">最近更新日期：2011/08/05</span>
    </div>
<!-- 本文的連結區部分 -->
<div class="block1">
<span class="text_h1">
20.5 <a href="#www_ssl">建立連線加密網站 (https) 及防砍站腳本</a><br>
	<span class="text_h2">
	　　20.5.1 <a href="#www_ssl_files">SSL 所需軟體與憑證檔案及預設的 https</a><br>
	　　20.5.2 <a href="#www_ssl_own">擁有自製憑證的 https</a><br>
	　　20.5.3 <a href="#www_ssl_virtual">將加密首頁與非加密首頁分離</a><br>
	　　20.5.4 <a href="#security_teleport">防砍站軟體</a><br>
	</span>
</span></div>
<!-- 本文的正式部分 -->
<hr><a name="www_ssl"></a><img src="../image/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">20.5 建立連線加密網站 (https) 及防砍站腳本</span><br>
<div class="block1">
	<p>從本章一開始的 20.1 就談過 http 這個通訊協定是明碼傳送資料，而那個 https 才是加密傳輸的！那加密的方法是透過
	SSL 啊，這個 SSL 就是以 openssl 軟體來提供的一個加密函式庫。更多與 https 有關的資訊，請參考
	<a href="#whatis_www_ssl">20.1.4</a> 吧！<br><br></p>

	<hr><a name="www_ssl_files"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">20.5.1 SSL 
	所需軟體與憑證檔案及預設的 https</span><br>
	<div class="block2">
		<p>要達成讓 apache 支援 https 協定的話，你必須要有 mod_ssl 這個軟體才行！請先自行使用 yum 去裝好這個軟體吧！
		並且重新啟動 httpd 喔！同時，我們的 CentOS 6.x 也已經預設提供了 SSL 
		機制所需要的私鑰與憑證檔案囉！相關軟體提供的檔案如下：</p>

		<ul>
		<li>/etc/httpd/conf.d/ssl.conf：mode_ssl 提供的 Apache 設定檔；</li>
		<li>/etc/pki/tls/private/localhost.key：系統私鑰檔，可以用來製作憑證的！</li>
		<li>/etc/pki/tls/certs/localhost.crt：就是加密過的憑證檔！(signed certificate)</li>
		</ul>

		<p>既然系統都已經幫我們搞定了，那麼就讓我們直接來瀏覽一下，看看系統預設提供的 https 是長的什麼模樣吧！
		打開你的瀏覽器，輸入 https://你的IP 來連線看看：</p>

		<center><img src="0360apache_files/centos6_ssl_firefox_1.gif" alt="在 firefox 底下看到的 SSL 安全問題圖示" title="在 firefox 底下看到的 SSL 安全問題圖示" width="600" border="1"><br>
		圖 20.5-1、在 firefox 底下看到的 SSL 安全問題圖示<br></center>

		<p>就如同本章 20.1.4 談到的，因為我們這個 Apache 網站並沒有將此憑證向 CA 註冊，因此就會出現上述的訊息了！
		這就類似 ssh 連線時，系統需要你輸入『 yes 』是一樣的啦！要接受憑證後才能夠進行加密的功能。所以，請點選上圖中的箭頭
		1，此時就會延伸出箭頭 2 的位置，按下去吧！然後就會出現如下所示：</p>

		<center><img src="0360apache_files/centos6_ssl_firefox_2.gif" alt="在 firefox 底下接受一把私有的憑證所需要的流程" title="在 firefox 底下接受一把私有的憑證所需要的流程" border="1"><br>
		圖 20.5-2、在 firefox 底下接受一把私有的憑證所需要的流程<br></center>

		<p>如果你確定這個網站是你自己的可信任網站，那就按下 1 及 2 的箭頭處！如果還想要看一下這個網站所提供的相關憑證內容，
		就按下 3 箭頭的地方：</p>

		<center><img src="0360apache_files/centos6_ssl_firefox_3.gif" alt="在 firefox 底下觀察憑證的詳細內容" title="在 firefox 底下觀察憑證的詳細內容" border="1"><br>
		圖 20.5-3、在 firefox 底下觀察憑證的詳細內容<br></center>

		<p>由於這個憑證檔案的建置是在第一次啟動 Linux 時就安裝好了憑證檔，而在 CentOS 6.x 底下，預設的憑證有效期限為 1 
		年，所以你就會看到上圖中箭頭 2 所指的，簽發日到到期日共有一年啊！當你按下關閉後，就能夠看到實際的 https://
		提供的網站內容囉！這就是預設的 SSL 網站啦！你的重要資訊可以放在這裡～讓資料在網路上傳輸更佳的安全！</p>
	</div>

	<hr><a name="www_ssl_own"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">20.5.2 擁有自製憑證的 https</span><br>
	<div class="block2">
		<ul class="list1"><li class="text_import1"><hr>建立憑證檔</li></ul>

		<p>預設的憑證雖然已經可以讓你順利的使用 https 了，不過，憑證的有效日僅有 1 年而已～實在討厭～
		所以，我們還是得要自製憑證才行～這個憑證的製作僅是私有 WWW 網站的用途，並沒有要拿去 CA 註冊喔！
		那麼自製憑證需要什麼步驟呢？基本上需要的流程是：</p>

		<ol class="text_import2">
		<li>先建立一把 private key 預備提供給 SSL 憑證簽章要求所用；</li>
		<li>最後建立 SSL 憑證 (test certificates)。</li>
		</ol>

		<p>那麼建立憑證有沒有很困難呢？沒有啦！因為 CentOS 6.x 已經幫我們寫好了 Makefile 
		了！你先到 <span class="text_import2">/etc/pki/tls/certs</span> 這個目錄下，然後直接輸入 make 
		這個指令，就能夠看到所有可行的目標動作！我們就可以很快速的建置好憑證喔！
		不過，因為預設的私鑰檔需要加上密碼才能夠進行建立，所以我們還得要額外進行一下動作就是了。好！
		現在假設我們要建立的是名為 vbird 的憑證！那麼底下流程中，所有的關鍵字就是 vbird！簡單流程如下所示：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先到 /etc/pki/tls/certs 去建立一把給 Apache 使用的私鑰檔案：</span>
[root@www ~]# <span class="term_command">cd /etc/pki/tls/certs</span>
[root@www certs]# <span class="term_command">make vbird.key</span>
umask 77 ; <u>/usr/bin/openssl genrsa -aes128 2048 &gt; vbird.key</u>  <span class="term_note">&lt;==其實是這個指令</span>
Generating RSA private key, 2048 bit long modulus
.................................................................+++
...............................+++
e is 65537 (0x10001)
Enter pass phrase:  <span class="term_note">&lt;==這裡輸入這把私鑰的密碼，需要多於四個字元！</span>
Verifying - Enter pass phrase:  <span class="term_note">&lt;==再一次！</span>

<span class="term_hd"># 2. 將剛剛建立的檔案中，裡面的密碼取消掉！不要有密碼存在啦！</span>
[root@www certs]# <span class="term_command">mv vbird.key vbird.key.raw</span>
[root@www certs]# <span class="term_command">openssl rsa -in vbird.key.raw -out vbird.key</span>
Enter pass phrase for vbird.key.raw: <span class="term_note">&lt;==輸入剛剛的密碼啦！</span>
writing RSA key
[root@www certs]# <span class="term_command">rm -f vbird.key.raw</span>  <span class="term_note">&lt;==舊的金鑰檔移除</span>
[root@www certs]# <span class="term_command">chmod 400 vbird.key</span>  <span class="term_note">&lt;==權限一定是 400 才行！</span>

<span class="term_hd"># 3. 建置所需要的最終憑證檔！</span>
[root@www certs]# <span class="term_command">make vbird.crt SERIAL=2011080801</span>
umask 77 ; <u>/usr/bin/openssl req -utf8 -new -key vbird.key -x509 <span class="term_write">-days 365</span> 
-out vbird.crt -set_serial 2011080801</u>  <span class="term_note">&lt;==可以加入日期序號</span>
You are about to be asked to enter information that will be incorporated
into your certificate request.
-----
Country Name (2 letter code) [XX]:<span class="term_command">TW</span>
State or Province Name (full name) []:<span class="term_command">Taiwan</span>
Locality Name (eg, city) [Default City]:<span class="term_command">Tainan</span>
Organization Name (eg, company) [Default Company Ltd]:<span class="term_command">KSU</span>
Organizational Unit Name (eg, section) []:<span class="term_command">DIC</span>
Common Name (eg, your name or your server's hostname) []:<span class="term_command">www.centos.vbird</span>
Email Address []:<span class="term_command">vbird@www.centos.vbird</span>

[root@www certs]# <span class="term_command">ll vbird*</span>
-rw-------. 1 root root 1419 2011-08-08 15:24 vbird.crt  <span class="term_note">&lt;==最終憑證檔！</span>
-r--------. 1 root root 1679 2011-08-08 15:22 vbird.key  <span class="term_note">&lt;==系統私鑰檔</span>
</pre></td></tr></tbody></table>

		<p>這樣就建立好憑證檔了！接下來就是得要去處理 ssl.conf 這個設定內容喔！另外，<span class="text_import2">這把憑證依舊只能使用 1 年！如果你想要建立十年的憑證，那就得要修改一下 Makefile 
		裡面的內容，將 365  改成 3650 即可！</span></p>

		<div style="padding: 10pt 0pt 10pt 0pt ;" align="right"><table width="90%"><tbody><tr><td><b>Tips:</b><br><span style="color : #009000"><font size="-1">		如果你曾經多次重複進行上述的建立憑證動作，會發現到同一個憑證內容若製作多次，則最終用戶端瀏覽器會出現一些錯誤訊息，
		導致無法連線！因此，建議多加一個序號 (SERIAL) 的參數，可以修訂這個錯誤喔！
		</font></span></td><td><img src="0360apache_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示"></td></tr></tbody></table></div>
		<ul class="list1"><li class="text_import1"><hr>修改 ssl.conf 的內容，使用自製憑證</li></ul>

		<p>修改 ssl.conf 的內容也是很簡單！只要修改兩個地方，亦即是檔案檔名的地方即可！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vim /etc/httpd/conf.d/ssl.conf</span>
SSLCertificateFile /etc/pki/tls/certs/vbird.crt    <span class="term_note">&lt;==約在 105 行</span>
SSLCertificateKeyFile /etc/pki/tls/certs/vbird.key <span class="term_note">&lt;==約在 112 行</span>

[root@www ~]# <span class="term_command">/etc/init.d/httpd restart</span>
</pre></td></tr></tbody></table>

		<p>然後再以瀏覽器去瀏覽  https:// 的網址，就能夠查閱到剛剛建立的憑證資料。不過，因為我們之前已經有瀏覽過預設的憑證，
		所以網頁以及憑證都有被快取過！因此，你可能得需要到瀏覽器的隱私保護的地方，將記錄的憑證刪除，並且將網頁快取刪除，
		這樣才能夠看到最終如下的正確憑證資料喔！</p>

		<center><img src="0360apache_files/centos6_ssl_firefox_4.gif" alt="檢查憑證的詳細內容！" title="檢查憑證的詳細內容！" border="1"><br>
		圖 20.5-4、檢查憑證的詳細內容！<br></center>
	</div>

	<hr><a name="www_ssl_virtual"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">20.5.3 將加密首頁與非加密首頁分離</span><br>
	<div class="block2">
		<p>或許你已經發現一個無俚頭的地方，就是我的 http:// 以及 https:// 首頁是一模一樣的嘛！那麼我的讀者幹嘛沒事找事幹，
		肯定不會使用 https 的嘛！那怎辦？怎麼強制使用者使用 https:// 來查閱我的重要資料？很簡單啊！
		透過虛擬主機就好了啊！因為 SSL 模組也是預設提供了這個功能的嘛！修改會不會很麻煩呢？不會啦！
		你只要將 http 及 https 的首頁分離即可！我們這麼假設好了：</p>

		<ul>
		<li>一般明碼傳輸的網頁首頁不要變更；</li>
		<li>https:// 的首頁放置到 /var/www/https/ 目錄下。</li>
		</ul>

		<p>所以我們得先要設定 /var/www/https 目錄才行！然後，只要修改 ssl.conf 檔案內容即可！整個過程可以這樣處理：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 處理目錄與預設的首頁 index.html 檔案：</span>
[root@www ~]# <span class="term_command">mkdir /var/www/https</span>
[root@www ~]# <span class="term_command">echo "This is https' home" &gt; /var/www/https/index.html</span>

<span class="term_hd"># 2. 開始處理 ssl.conf 的內容囉！</span>
[root@www ~]# <span class="term_command">vim /etc/httpd/conf.d/ssl.conf</span>
Listen 443                      <span class="term_note">&lt;==預設的監聽埠口！不建議修改！</span>
&lt;VirtualHost _default_:443&gt;     <span class="term_note">&lt;==就是虛擬主機的設定囉！</span>
<span class="term_write">DocumentRoot "/var/www/https"   <span class="term_note">&lt;==約84行，拿掉註解改掉目錄名稱</span>
ServerName *:443                <span class="term_note">&lt;==拿掉註解，並將主機名稱設定為 *</span></span>
SSLEngine on                    <span class="term_note">&lt;==有支援 SSL 的意思！</span>
SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW
SSLCertificateFile /etc/pki/tls/certs/vbird.crt
SSLCertificateKeyFile /etc/pki/tls/certs/vbird.key
&lt;/VirtualHost&gt;

[root@www ~]# <span class="term_command">/etc/init.d/httpd restart</span>
</pre></td></tr></tbody></table>

		<p>大部分都使用預設值，就是 DocumentRoot 以及 ServerName 需要留意就是了。如此一來，我們就將 https, http
		兩個完整的分開，你的重要資料需要加密的，終於有個可靠的地方擺放囉！^_^</p>
	</div>

	<hr><a name="security_teleport"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">20.5.4 防砍站軟體</span><br>
	<div class="block2">
		<p>幾個比較知名的網站管理員大概都有這樣的困擾，那就是網站常被砍站軟體所強力下載，結果造成主機的 
		CPU loading 過重，最後竟然會導致死掉～唉！真是的～人怕出名豬怕肥吶！先來解釋一下什麼是砍站吧！</p>

		<p>所謂的『砍站』，就是以類似多點連線下載的持續性訊息傳遞軟體進行網站資料的下載，而且，
		一啟用該軟體，該軟體就將『整個網站』的內容都給他 download 
		下來，很厲害吧！沒錯！是很厲害，但是卻也害死人了～怎麼說呢？</p>

		<p>因為這種軟體常常會為了加快 download 的速度，所以採用多點連線的方式，也就是會持續不斷的向 Server 
		發出要求封包，而由於這些封包並不見得能夠成功的讓 Server 把資料傳導給 Client 
		端，常常會無法投遞就是啦！這樣的結果就是...造成 Server 要一直不斷的回應，又無法正確的回應出去，
		此外，要求太過頻繁，結果主機應接不暇，最後...就當機了...真的是林老師ㄌㄟ～</p>

		<p>鳥哥的鳥站主機古早以前，就是因為這樣的原因，導致服務常常斷斷續續的，並且，由於 CPU loading 
		太高，結果讓正常連線進來看資料的網友沒有足夠的資源，因此網頁開啟的速度就變的很慢～唉～
		這些砍站的人，也太不道德啦！</p>

		<p>由於這種砍站軟體真的很麻煩，一不注意馬上就又會被砍站而當機，三天兩頭就要重新開機一次，完全讓 
		Linux 的穩定性無法發揮！真是氣死了～後來，鳥哥就自行寫了一個 scripts 來擋這樣的 
		IP ！我的作法是這樣的：</p>

		<ol>
		<li>由於砍站軟體會多點連續下載，因此，同一個 IP 在同一個時間內，會有相當多的連線發生；</li>
		<li>由於他是重複不斷的要求連線，因此剛剛建立的連線在達成下載的目的後，會立刻死掉，
		而又多生出其他的連線出來，因此，這個時候他的連線情況就變的相當的不正常了！</li>
		<li>由於某些較舊的砍站軟體並不會『欺騙』主機，所以，會在主機的登錄檔裡面記錄住 Teleport 的標記！</li>
		<li>既然如此的話，那麼我就讓我的主機每分鐘去檢查兩個東西(1)先檢查 log file 
		，如果有發現到相關的 Teleport 字詞，就將該 IP 抵擋掉；(2)使用 netstat 
		來檢查同一個 IP 的同時連線，如果該連線超過一個值(例如同時有 12 個連線)的話，那麼就將該 IP 抵擋掉！</li>
		<li>此外，由於上面的方案可能會將 Proxy 的 Client 端也同時抵擋掉，真是可憐啊！
		這個時候，這支程式就會主動的將(1)的情況的主機抵擋 3 天，至於(2)的情況則抵擋2小時！
		過了該抵擋的時限後，該 IP 即可又連上我們的主機了！</li>
		</ol>

		<p>大致上就是這樣吧！這樣的一程式需要與 iptables 相互配合，所以，請先查閱一下<a href="http://linux.vbird.org/linux_server/0250simple_firewall.php">第九章的防火牆</a>內容，然後再來下載這支程式吧！
		這支程式你可以在底下的網址下載喔！</p>

		<ul><li><a href="http://linux.vbird.org/download/index.php?action=detail&amp;fileid=47" target="_blank">http://linux.vbird.org/download/index.php?action=detail&amp;fileid=47</a></li></ul>

		<p>詳細的安裝步驟鳥哥已經以中文寫在該檔案裡面了，所以請先查看一下該檔案的前面說明部分吧！此外，
		Study Area 的 netman 大哥也已經開發了一套很棒的防砍站的程式了！
		在防堵砍站的原理上面是完全相同的，不過寫法可能不是很雷同就是了！如果有需要的話，也可以前往 
		Study-Area 搜尋一下囉！</p>

		<ul><li><a href="http://phorum.study-area.org/viewtopic.php?t=13643" target="_blank">http://phorum.study-area.org/viewtopic.php?t=13643</a></li></ul>
	</div>
</div>
<hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
</tbody></table>

<div style="padding-top: 0px; text-align: center;">
<span style="font-size: 80%;">
	<a href="http://linux.vbird.org/" target="_top" title="前往鸟哥的首页">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="联络鸟哥(我不要广告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
         ﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></div>
</div>
</center>
</body></html>
