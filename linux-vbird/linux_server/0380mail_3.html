<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-TW" lang="zh-TW"><head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf8">
	<meta name="Author" content="VBird, 鸟哥">
	<meta name="Description" content="电子邮件主机之设定，主要介绍 Postfix ，不过亦有提及 Sendmail 的相关技巧">
	<title>鸟哥的 Linux 私房菜 -- Mail Server</title>
    <script src="../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../script/index.js" type="text/javascript"></script>
	<link href="../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    </head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html')">

<center>
<div id="apDiv5">
<div> <LINK REL="SHORTCUT ICON" HREF="../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../linux_basic/0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="../linux_basic/Mandrake9.0/mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="../linux_basic/fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<table summary="本文内容的排版" style="width: 898px;" border="0" cellpadding="0" cellspacing="0">
<tbody><tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
<tr><td style="width: 16px; font-size: 6px;">　</td>
    <td width="866">

<!-- 本文的档头部分 -->
<div style="text-align:center">
    <a href="http://linux.vbird.org/linux_server/0380mail.php">
    <span class="text_head0">第二十二章、邮件服务器：<span class="text_head_en"> Postfix</span></span></a><br>
</div>
    <div style="text-align:right">
        <span class="text_history">最近更新日期：2011/08/10</span>
    </div>

<!-- 本文的连结区部分 -->
<div class="block1">
<span class="text_h1">
22.3 <a href="#mra_setup">MRA 服务器： dovecot 设定</a><br>
	<span class="text_h2">
	　　22.3.1 <a href="#mra_basic">基础的 POP3/IMAP 设定</a><br>
	　　22.3.2 <a href="#mra_ssl">加密的 POP3s/IMAPs 设定</a><br>
	　　22.3.3 <a href="#mra_firewall">防火墙设置</a><br>
	</span>
</span></div>
<!-- 本文的正式部分 -->
<hr><a name="mra_setup"></a><img src="../image/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">22.3 MRA 服务器： dovecot 设定</span><br>
<div class="block1">
	<p>除非你想要架设 webmail 在你的 MTA 上头，否则，你的 MTA 收下了信件，你总得连上 MTA 去收信吧？那么收信要用的是哪个通讯协议？
	就是 <a href="#whatmail_pop">22.1.4</a> 里面谈到的 pop3 以及 imap 啰！这就是所谓的 MRA 服务器！我们的 CentOS 6.x
	使用的是 dovecot 这个软件来达成 MRA 的相关通讯协议的！但由于 pop3/imap 还有数据加密的版本，底下我们就依据是否加密 (SSL)
	来设定 dovecot 吧！<br><br></p>

	<hr><a name="mra_basic"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">22.3.1 基础的 POP3/IMAP 设定</span><br>
	<div class="block2">
		<p>启动单纯的 pop3/imap 是很简单的啦，你得要先确定已经安装了 dovecot 这个软件。而这个软件的配置文件只有一个，就是 
		/etc/dovecot/dovecot.conf 。我们仅要启动 pop3/imap 而已，所以可以这样设定即可：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">yum install dovecot</span>
[root@www ~]# <span class="term_command">vim /etc/dovecot/dovecot.conf</span>
<span class="term_say"># 找到底下这一行，大约是在第 25 行左右的地方，复制新增一行内容如下：</span>
#protocols = imap pop3 lmtp
<span class="term_write">protocols = imap pop3</span>

[root@www ~]# <span class="term_command">vim /etc/dovecot/conf.d/10-ssl.conf</span>
<span class="term_write">ssl = no</span>   <span class="term_note">&lt;==将第 6 行改成这样！</span>
</pre></td></tr></tbody></table>

		<p>改完之后你就可以启动 dovecot 啰！并且检查看看 port 110/143 (pop3/imap) 有没有启动啊？</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">/etc/init.d/dovecot start</span>
[root@www ~]# <span class="term_command">chkconfig dovecot on</span>
[root@www ~]# <span class="term_command">netstat -tlnp | grep dovecot</span>
Proto Recv-Q Send-Q Local Address   Foreign Address   State    PID/Program name
tcp        0      0 :::<span class="term_write">110</span>          :::*              LISTEN   14343/dovecot
tcp        0      0 :::<span class="term_write">143</span>          :::*              LISTEN   14343/dovecot
</pre></td></tr></tbody></table>

		<p>耶！搞定！这样就可以提供使用者来收信件啦！真是不错啊！不过记得喔，这里只提供基本的明码 pop3/imap 传输而已，
		如果想要启动其他如 pop3s (传输加密机制) 协议时，就得要额外的设定啰！</p>
	</div>

	<hr><a name="mra_ssl"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">22.3.2 加密的 POP3s/IMAPs 设定</span><br>
	<div class="block2">
		<p>如果担心数据在传输过程会被窃取，或者是你的登入信息 (账号与密码) 在使用 pop3/imap 时会被窃听，
		那么这个 pop3s/imaps 就显的重要啦！与之前的 Apache 相似的，其实我们都是透过 openssl 这个软件提供的 SSL
		加密机制来进行数据的加密传输。方式很简单呢！预设的情况下，CentOS 已经提供了 SSL 凭证范例文件给我们使用了。
		如果你一点都不想要使用预设的凭证，那么我们就来自己建一个吧！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 建立凭证：到系统提供的 /etc/pki/tls/certs/ 目录下建立所需要的 pem 凭证档：</span>
[root@www ~]# <span class="term_command">cd /etc/pki/tls/certs/</span>
[root@www certs]# <span class="term_command">make vbirddovecot.pem</span>
<span class="term_say">....(前面省略)....</span>
Country Name (2 letter code) [XX]:<span class="term_write">TW</span>
State or Province Name (full name) []:<span class="term_write">Taiwan</span>
Locality Name (eg, city) [Default City]:<span class="term_write">Tainan</span>
Organization Name (eg, company) [Default Company Ltd]:<span class="term_write">KSU</span>
Organizational Unit Name (eg, section) []:<span class="term_write">DIC</span>
Common Name (eg, your name or your server's hostname) []:<span class="term_write">www.centos.vbird</span>
Email Address []:<span class="term_write">dmtsai@www.centos.vbird</span>

<span class="term_hd"># 2. 因为担心 SELinux 的问题，所以建议将 pem 档案放置到系统默认的目录去较佳！</span>
[root@www certs]# <span class="term_command">mv vbirddovecot.pem ../../dovecot/</span>
[root@www certs]# <span class="term_command">restorecon -Rv ../../dovecot</span>

<span class="term_hd"># 3. 开始处理 dovecot.conf，只要 pop3s, imaps 不要明码传输的咯！</span>
[root@www certs]# <span class="term_command">vim /etc/dovecot/conf.d/10-auth.conf</span>
<span class="term_write">disable_plaintext_auth = yes</span>  <span class="term_note">&lt;==第 9 行改成这样！取消批注！</span>

[root@www certs]# <span class="term_command">vim /etc/dovecot/conf.d/10-ssl.conf</span>
<span class="term_write">ssl = required                                <span class="term_note">&lt;==第 6 行改成这样</span>
ssl_cert = &lt;/etc/pki/dovecot/vbirddovecot.pem <span class="term_note">&lt;==12, 13 行变这样</span>
ssl_key =  &lt;/etc/pki/dovecot/vbirddovecot.pem</span>

[root@www certs]# <span class="term_command">vim /etc/dovecot/conf.d/10-master.conf</span>
  inet_listener imap {
    <span class="term_write">port = 0</span>     <span class="term_note">&lt;== 15 行改成这样</span>
  }
  inet_listener pop3 {
    <span class="term_write">port = 0</span>     <span class="term_note">&lt;== 36 行改成这样</span>
  }

<span class="term_hd"># 4. 处理额外的 mail_location 设定值！很重要！否则网络收信会失败：</span>
[root@www certs]# <span class="term_command">vim /etc/dovecot/conf.d/10-mail.conf</span>
<span class="term_write">mail_location = mbox:~/mail:INBOX=/var/mail/%u</span> <span class="term_note">&lt;==第 30 行改这样</span>

<span class="term_hd"># 5. 重新启动 dovecot 并且观察 port 的变化：</span>
[root@www certs]# <span class="term_command">/etc/init.d/dovecot restart</span>
[root@www certs]# <span class="term_command">netstat -tlnp | grep dovecot</span>
Proto Recv-Q Send-Q Local Address  Foreign Address   State    PID/Program name
tcp        0      0 :::<span class="term_write">993</span>         :::*              LISTEN   14527/dovecot
tcp        0      0 :::<span class="term_write">995</span>         :::*              LISTEN   14527/dovecot
</pre></td></tr></tbody></table>

		<p>最终你看到的 993 是 imaps 而 995 则是 pop3s 啰！这样一来，你收信的时候，输入的账号密码就不怕被窃听了！
		反正是加密后的资料啰！很简单吧！</p>
	</div>

	<hr><a name="mra_firewall"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">22.3.3 防火墙设置</span><br>
	<div class="block2">
		<p>因为上面的练习中，我们将 pop3/imap 关闭，转而打开 pop3s/imaps 了，因此防火墙启动的埠口会不一样！
		请依据您实际的案例来设定你所需要的防火墙才好。我们这里主要是开放 993, 995 两个埠口呦！
		处理的方法与 22.2.9 相当类似：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vim /usr/local/virus/iptables/iptables.rule</span>
<span class="term_say"># 大约在 180 行左右，新增底下两行去！</span>
<span class="term_write">iptables -A INPUT -p TCP -i $EXTIF --dport 993  --sport 1024:65534 -j ACCEPT</span>
<span class="term_write">iptables -A INPUT -p TCP -i $EXTIF --dport 995  --sport 1024:65534 -j ACCEPT</span>

[root@www ~]# <span class="term_command">/usr/local/virus/iptables/iptables.rule</span>
</pre></td></tr></tbody></table>

		<p> 如果你的 pop3/imap 还是决定不加密的话，请将上面的 993/995 改成 143/110 即可！</p>
	</div>
</div>
<hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
</tbody></table>

<div style="padding-top: 0px; text-align: center;">
<span style="font-size: 80%;">
	<a href="http://linux.vbird.org/" target="_top" title="前往鸟哥的首页">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="联络鸟哥(我不要广告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
         ﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></div>
</div>
</center>
</body></html>
