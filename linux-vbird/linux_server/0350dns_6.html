<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-TW" lang="zh-TW"><head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf8">
	<meta name="Author" content="VBird, 鸟哥">
	<meta name="Description" content="关于 domain name server 的设定方法介绍喔！">
	<title>鸟哥的 Linux 私房菜 -- DNS Server</title>
    <script src="../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../script/index.js" type="text/javascript"></script>
	<link href="../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    </head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html')">

<center>
<div id="apDiv5">
<div> <LINK REL="SHORTCUT ICON" HREF="../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../linux_basic/0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="../linux_basic/Mandrake9.0/mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="../linux_basic/fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<table summary="本文内容的排版" style="width: 898px;" border="0" cellpadding="0" cellspacing="0">
<tbody><tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
<tr><td style="width: 16px; font-size: 6px;">　</td>
    <td width="866">

<!-- 本文的档头部分 -->
<div style="text-align:center">
    <a href="http://linux.vbird.org/linux_server/0350dns.php">
    <span class="text_head0">第十九章、主机名控制者：<span class="text_head_en"> DNS </span>服务器</span></a><br>
</div>
    <div style="text-align:right">
        <span class="text_history">最近更新日期：2011/08/05</span>
    </div>
<!-- 本文的连结区部分 -->
<div class="block1">
<span class="text_h1">
19.6 <a href="#upgrade">DNS 服务器的进阶设定</a><br>
	<span class="text_h2">
	　　19.6.1 <a href="#OK_DNS">架设一个合法授权的 DNS 服务器</a><br>
	　　19.6.2 <a href="#Lame_server">LAME Server 的问题</a><br>
	　　19.6.3 <a href="#rndckey">利用 RNDC 指令管理 DNS 服务器</a><br>
	　　19.6.4 <a href="#ddns">架设动态 DNS 主机：让你成为 ISP 啦！</a><br>
	</span>
</span></div>
<!-- 本文的正式部分 -->
<hr><a name="upgrade"></a><img src="../image/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">19.6 DNS 服务器的进阶设定</span><br>
<div class="block1">
	<p>其实， DNS 服务器的运作原理与架设方式的变化，真的很高深莫测的！在这里，我们额外的提出一些比较进阶的内容给大家参考参考，
	例如架设一个合法授权的 DNS 服务器以及利用 rndc 控管 DNS 系统喔！<br><br></p>

	<hr><a name="OK_DNS"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">19.6.1 架设一个合法授权的 DNS 服务器</span><br>
	<div class="block2">
		<p>好啦！现在你应该知道什么是『<span class="text_import2">经上游授权的合法 DNS 服务器</span>』了吧？
		没错！就是上游的 DNS 服务器将子域的查核权开放给你来设定就对啦！嗯！虽然知道原理，但是那么我要如何来架设一个合法的
		DNS 服务器呢？好让我自己管理自己的 domain！举例来说，鸟哥的 vbird.idv.tw 就是鸟哥自己管理的哩～底下我们就来谈一谈，如何向
		ISP 申请一个合法授权的 DNS 服务器，或者是合法的主机名啊！<br><br></p>

		<ul class="list1"><li class="text_import1"><hr>1. 申请一个合法的 domain name ...就是要花钱！</li></ul>

		<p>既然是要建立一个合法的 DNS server，自然就要向合法的 ISP 申请授权啰！目前你可以到底下的地方去申请喔！</p>

		<ul>
		<li><a href="http://www.twnic.net/index3.php" target="_blank">http://www.twnic.net/index3.php</a></li></ul>

		<p>其实 TWNIC 已经将台湾地区的一些 domain 授权给各大 ISP 管理了，所以你连接上述的网站之后，可以点选里头相关的连结到各大
		ISP 去注册！例如鸟哥就在 Hinet 注册了 vbird.idv.tw 这个网域！现在鸟哥就以 Hinet 的注册做为说明吧：</p>

		<ol>
		<li><span class="text_import2">进入主画面：</span><br>直接连结到底下的网页去：
		<a href="http://domain.hinet.net/" target="_blank">http://domain.hinet.net</a><br><br></li>

		<li><span class="text_import2">选择需要的域名，并查询该网域是否已存在：</span><br>
		因为网域必需是独一无二的，所以你必需使用该网页当中提供的查询功能，
		去查询一下你想要的网域是否已经被注册了呢？一定要没有被注册的网域才可以喔！<br><br></li>

		<li><span class="text_import2">逐步进行注册：</span><br>
		你可以选择很多种类的领域来注册，如果想要注册个人网站，请按下图所指的 (1) 处，如果想要注册类似 vbird.tw 
		这种网域的话，则可以选择 (2) 所指的那个项目。然后以该网站提供的功能一步一步的往下去进行，
		例如以鸟哥的『个人网址』之注册为例，按下个人网址之后，会出现流程步骤为：<br>

		<center><img src="0350dns_files/hinet_reg_01.gif" alt="以 Hinet 网站为依据介绍注册 domain 的方法" title="以 Hinet 网站为依据介绍注册 domain 的方法" border="1"><br>
		图 19.6-1、以 Hinet 网站为依据介绍注册 domain 的方法<br></center>

		请依序一步一步的将他完成，最后你会得到一组账号密码，就能够修改自己的领域啦！<br><br></li>

		<li><span class="text_import2">选择网站代管或架设 DNS 模式：</span><br>
		我们可以直接请 ISP 帮我们设定好 host 对应 IP 就好(最多三部)，当然也可以自行设定一下我们所需要的 DNS 
		服务器啦！如果未来你可能会架设 mail server ，所以还是自行设定 DNS 主机好了！你可以选择图 19.6-1 在 (3) 
		所指的『DNS异动与查询』项目，会出现下面图标。记得选择『DNS』及填写你的 hostname 与正确的 IP 即可喔！注意：
		要填选这个项目，最好你的 IP 是固定制的，浮动制的 IP 不建议用这个选项！<br>

		<center><img src="0350dns_files/hinet_reg_02.gif" alt="以 Hinet 网站为依据介绍注册 domain 的方法" title="以 Hinet 网站为依据介绍注册 domain 的方法" border="1"><br>
		图 19.6-2、以 Hinet 网站为依据介绍注册 domain 的方法<br></center></li>
		</ol>

		<ul class="list1"><li class="text_import1"><hr>2. 以 <a href="#DNS_master">DNS 服务器的详细设定 (19.4)</a>
		之设定内容来设定你的主机：</li></ul>

		<p>如果你已经以 DNS 服务器的方式申请了一个 domain name ，那么你就必须要设定你的 DNS 主机了！
		请注意，这个情况之下，你只要设定你的注册的网域的正解即可！
		反解部分则先不要理会，当然，如果你有办法的话，最好还是请上层的 ISP 帮你设定啰！<br><br></p>

		<ul class="list1"><li class="text_import1"><hr>3. 测试：</li></ul>

		<p>设定一部合法的 DNS 完毕后，建议你可以到这个网站去查询一下你的设定是否妥当：</p>
		<ul><li><a href="http://thednsreport.com/" target="_blank">http://thednsreport.com/</a></li></ul>

		<p>如此一来，你的 DNS 主机上面设定的任何信息，都可以透过 Internet 
		上面的任何一部主机来查询到喔！够棒吧！心动了吗？赶快去试看看吧！ ^_^</p>
	</div>

	<hr><a name="Lame_server"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">19.6.2 LAME Server 的问题</span><br>
	<div class="block2">
		<p>或许你曾经在 /var/log/messages 里面看到类似这样的讯息：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">more /var/log/messages</span>
<span class="term_note">1</span> Oct  5 05:02:30 test named[432]: lame server resolving '68.206.244.205.
  in-addr.arpa' (in '206.244.205.in-addr.arpa'?): 205.244.200.3#53
<span class="term_note">2</span> Oct  5 05:02:31 test named[432]: lame server resolving '68.206.244.205.
  in-addr.arpa' (in '206.244.205.in-addr.arpa'?): 206.105.201.35#53
<span class="term_note">3</span> Oct  5 05:02:41 test named[432]: lame server resolving '68.206.244.205.
  in-addr.arpa' (in '206.244.205.in-addr.arpa'?): 205.244.112.20#53
</pre></td></tr></tbody></table>

		<p>这是什么东西吶？根据官方提供的文件资料来看 (<span class="text_vbird">
		在你的 CentOS 6.x 的系统下，请察看这个档案『 /usr/share/doc/bind-9.7.0/arm/Bv9ARM.ch06.html 』
		</span> )，<span class="text_import2">当我们的 DNS 服务器在向外面的 DNS 系统查询某些正反解时，可能由于
		『对方』 DNS 主机的设定错误，导致无法解析到预期的正反解结果</span>，这个时候就会发生所谓的 
		lame server 的错误！</p>

		<p>那么这个错误会让我们的 DNS 服务器发生什么严重的后果吗？既然仅是对方的设定错误，所以<span class="text_import2">自然就不会</span>影响我们的 DNS 服务器的正常作业了。
		只是我们的 DNS 主机在查询时，会发生无法正确解析的警告讯息而已，
		这个讯息虽然不会对我们的 Linux 主机发生什么困扰，不过，对于系统管理员来说，
		要天天查询的 /var/log/messages 档案竟然有这么多的登录信息，这是很讨厌的一件事！</p>

		<p>好了，我们知道 lame server 是对方主机的问题，对我们主机没有影响，但是却又不想要让该讯息出现在我们的登录档 
		/var/log/messages 当中，怎么达到这样的功能呢？呵呵！就直接利用 BIND 这个软件所提供的登录文件参数啊！
		动作很简单，在你的 /etc/named.conf 档案当中的最底下，加入这个参数即可： </p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 修改 /etc/named.conf</span>
[root@www ~]# <span class="term_command">vim /etc/named.conf</span>
<span class="term_say">// 加入底下这个参数：</span>
<span class="term_write">logging {
        category lame-servers { null; };
};</span>

<span class="term_hd"># 2. 重新启动 bind</span>
[root@www ~]# <span class="term_command">/etc/init.d/named restart</span>
</pre></td></tr></tbody></table>

		<p>基本上，那个 logging 是主机的登录文件记录的一个设定项目，因为我们不要 lame server 的信息，
		所以才将他设定为无 (null) ，这样就改完了！记得重新启动 named 之后，还是要察看一下 /var/log/messages 喔！
		以确定 named 的正确启动与否！然后，嘿嘿，以后就不会看到 lame server 咯！</p>
	</div>

	<hr><a name="rndckey"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">19.6.3 利用 RNDC 指令管理 DNS 服务器</span><br>
	<div class="block2">
		<p>不知道你会不会觉得很奇怪，那就是为啥启动 DNS 后，在 /var/log/messages 老是看到这一句话：</p>

<table class="term"><tbody><tr><td class="term"><pre>command channel listening on 127.0.0.1#953
</pre></td></tr></tbody></table>

		<p>而且在本机端的 port 953 还多了个 named 所启动的服务，那是啥？那就是所谓的 rndc 了。这个 rndc 是 
		BIND version 9 以后所提供的功能啦，他可以让你很轻松的管理你自己的 DNS 服务器喔！
		包括可以检查已经存在 DNS 快取当中的资料、重新更新某个 zone 而不需要重新启动整个 DNS ，
		以及检查 DNS 的状态与统计资料等等的，挺有趣的！</p>

		<p>不过，因为 rndc 可以很深入的管理你的 DNS 服务器，所以当然要进行一些控管啦！
		控管的方式是<span class="text_import2">经过 rndc 的设定来建立一支密钥 (rndc key)，并将这支密钥相关的信息写入你的 
		named.conf 配置文件当中</span>，重新启动 DNS 后，你的 DNS 就能够藉由 rndc 这个指令来管理啰！
		事实上，新版的 distributions 通常已经帮你主动的建立好 rndc key 了，所以你不需要忙碌～
		不过，如果你还是在登录档当中发现一些错误，例如：</p>

<table class="term"><tbody><tr><td class="term"><pre>couldn't add command channel 127.0.0.1#953: not found
</pre></td></tr></tbody></table>

		<p>那就表示你 DNS 的 rndc key  没有设定好啦！那要如何设定好？很简单～只要先建立一把 rndc key ，然后加到 
		named.conf 当中去即可！你可以使用 bind 提供的指令来进行这样的工作喔！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先建立 rndc key 的相关数据吧！</span>
[root@www ~]# <span class="term_command">rndc-confgen</span>
<span class="term_write"># Start of rndc.conf <span class="term_note">&lt;==底下没有 # 的第一部份请复制到 /etc/rndc.conf 中</span>
key "rndc-key" {
        algorithm hmac-md5;
        secret "UUqxyIwui+22CobCYFj5kg==";
};</span>

options {
        default-key "rndc-key";
        default-server 127.0.0.1;
        default-port 953;
};
# End of rndc.conf

<span class="term_say"># 至于底下的 key 与 controls 部分，则请复制到 named.conf 且解开 # 喔！</span>
# Use with the following in named.conf, adjusting the allow list as needed:
# key "rndc-key" {
#       algorithm hmac-md5;
#       secret "UUqxyIwui+22CobCYFj5kg==";
# };
#
# controls {
#       inet 127.0.0.1 port 953
#               allow { 127.0.0.1; } keys { "rndc-key"; };
# };
# End of named.conf
<span class="term_say"># 请注意，这个 rndc-confgen 是利用随机数计算出加密的那把 key ，
# 所以每次执行的结果都不一样。所以上述的数据与你的屏幕会有点不同。</span>

<span class="term_hd"># 2. 建立 rndc.key 档案</span>
[root@www ~]# <span class="term_command">vim /etc/rndc.key</span>
<span class="term_say"># 在这个档案当中将原本的数据全部删除，并将刚刚得到的结果给他贴上去</span>
<span class="term_write">key "rndc-key" {
        algorithm hmac-md5;
        secret "UUqxyIwui+22CobCYFj5kg==";
};</span>

<span class="term_hd"># 3. 修改 named.conf</span>
[root@www ~]# <span class="term_command">vim /etc/named.conf</span>
<span class="term_say"># 在某个不被影响的角落建置如下的内容：</span>
<span class="term_write">key "rndc-key" {
       algorithm hmac-md5;
       secret "UUqxyIwui+22CobCYFj5kg==";
};
controls {
       inet 127.0.0.1 port 953
               allow { 127.0.0.1; } keys { "rndc-key"; };
};</span>

[root@www ~]# <span class="term_command">/etc/init.d/named restart</span>
</pre></td></tr></tbody></table>

		<p>建立了rndc key 并且启动 DNS ，同时你的系统也已经有 port 953 之后，我们就可以在本机执行 rndc 
		这个指令了。这个指令的用法请直接输入 rndc 来查询即可：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">rndc</span>
Usage: rndc [-c config] [-s server] [-p port]
        [-k key-file ] [-y key] [-V] command

command is one of the following:

  reload        Reload configuration file and zones.
  stats         Write server statistics to the statistics file.
  dumpdb        Dump cache(s) to the dump file (named_dump.db).
  flush         Flushes all of the server's caches.
  status        Display status of the server.
<span class="term_say"># 其他就给他省略啦！请自行输入这个指令来参考啰！</span>
</pre></td></tr></tbody></table>

		<p>那如何使用呢？我们举几个小例子来说明吧！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 范例一：将目前 DNS 服务器的状态显示出来</span>
[root@www ~]# <span class="term_command">rndc status</span>
version: 9.7.0-P2-RedHat-9.7.0-5.P2.el6_0.1
CPUs found: 1
worker threads: 1
number of zones: 27         <span class="term_note">&lt;==这部 DNS 管理的 zone 数量</span>
debug level: 0              <span class="term_note">&lt;==是否具有 debug 及 debug 的等级</span>
xfers running: 0
xfers deferred: 0
soa queries in progress: 0
query logging is OFF        <span class="term_note">&lt;==是否具有 debug 及 debug 的等级</span>
recursive clients: 0/0/1000
tcp clients: 0/100
server is up and running    <span class="term_note">&lt;==是否具有 debug 及 debug 的等级</span>

<span class="term_hd"># 范例二：将目前系统的 DNS 统计数据记录下来</span>
[root@www ~]# <span class="term_command">rndc stats</span>
<span class="term_say"># 此时，预设会在 /var/named/data 内产生新档案，你可以去查阅：</span>
[root@www ~]# <span class="term_command">cat /var/named/data/named_stats.txt</span>
+++ Statistics Dump +++ (1312528012)
<span class="term_say">....(中间省略)....</span>
++ Zone Maintenance Statistics ++
                   2 IPv4 notifies sent
++ Resolver Statistics ++
<span class="term_say">....(中间省略)....</span>
++ Cache DB RRsets ++
[View: lan (Cache: lan)]
[View: wan (Cache: wan)]
[View: _bind (Cache: _bind)]
[View: _meta (Cache: _meta)]
++ Socket I/O Statistics ++
                   5 UDP/IPv4 sockets opened
                   4 TCP/IPv4 sockets opened
                   2 UDP/IPv4 sockets closed
                   1 TCP/IPv4 sockets closed
                   2 TCP/IPv4 connections accepted
++ Per Zone Query Statistics ++
--- Statistics Dump --- (1312528012)

<span class="term_hd"># 范例三：将目前高速缓存当中的数据记录下来</span>
[root@www ~]# <span class="term_command">rndc dumpdb</span>
<span class="term_say"># 与 stats 类似，会将 cache 的数据放置成为一个档案，你可以去查阅：
# /var/named/data/cache_dump.db</span>
</pre></td></tr></tbody></table>

		<p>如果你在执行 rndc 指令时老是出现如下错误：</p>

<table class="term"><tbody><tr><td class="term"><pre>rndc: connection to remote host closed
This may indicate that the remote server is using an older version of
the command protocol, this host is not authorized to connect,
or the key is invalid.
</pre></td></tr></tbody></table>

		<p>这表示你的 /etc/rndc.key 与 /etc/rndc.conf 内密钥的编码不同所致。
		请你自行以上述的 rndc-confgen 的方式自行处理你的 rndc key ，并重新启动 named 即可啊！
		用这东西管理，你就不需要每次都重新启动 named 啰！ ^_^</p>
	</div>

	<hr><a name="ddns"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">19.6.4 架设动态 DNS 服务器：
	让你成为 ISP 啦！</span><br>
	<div class="block2">
		<p>什么是动态 DNS (Dynamic DNS, DDNS) 主机呢？还记得我们在<a href="http://linux.vbird.org/linux_server/0270dynamic_dns.php">第十章</a>里面提到，
		如果我们本身是以拨接制的 ADSL 连上 Internet 时，我们的 IP 通常是 ISP 随机提供的，因此每次上网的 IP 都不固定，所以，
		我们没有办法以上面的 DNS 设定来给予这种连上 Internet 的方法一个适当的主机名。</p>

		<p>也因此，如果我们想要利用这种没有固定 IP 的联机方法架设网站时，就得要有特殊的管道了～
		其中之一的方法就是利用 Internet 上面已经提供的免费动态 IP 对应主机名的服务！
		例如： <a href="http://www.no-ip.org/" target="_blank">http://www.no-ip.org</a> 。</p>

		<p>提供这样的服务利用的是什么原理呢？基本上， DNS 主机还是得要提供 Internet 相关的 zone 
		的主机名与 IP 的对应数据才行，所以，<span class="text_import2">DDNS 主机
		就必须要提供一个机制，让客户端可以透过这个机制来修改他们在 DDNS 主机上面的
		zone file 内的资料才行</span>。</p>

		<p>那会不会很难啊？不会啊！我们的 BIND 9 就有提供类似的机制啦！那就是利用 
		update-policy 这个选项，配合认证用的 key 来进行数据文件的更新。简单的说，<span class="text_import2">
		1) 我们的 DDNS 主机先提供 Client 一把 Key (就是认证用的数据，
		你可以将他想成是账号与密码的概念)， 2) Client 端利用这把 Key ，并配合 BIND 9 的 nsupdate 指令，
		就可以连上 DDNS 主机，并且修改主机上面的 Zone file 内的对应表了。</span>感觉上很像很简单喔！
		没错啊！架设上真的很简单的～底下我们就来尝试设定一下喔：<br><br></p>

		<ul class="list1"><li class="text_import1"><hr>1. DDNS Server 端的设定：</li></ul>

		<p>假设我有一个朋友，他使用的 Linux 主机的 IP 是会随时变动的，但是他想要架设 Web 网站，
		所以他向我申请了一个领域名，那就是 web.centos.vbird ，此时我必需要给他一把密钥，
		并且设定我的 named.conf 让 centos.vbird 这个 zone 能够接受来自客户端的数据更新才行！首先来建立这把密钥吧！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">dnssec-keygen -a [算法] -b [密码长度] -n [类型] 名称</span>
<span class="term_say">选项与参数：
-a ：后面接的 [type] 为演算方式的意思，主要有 RSAMD5, RSA, DSA, DH
     与 HMAC-MD5 等。建议你可以使用常见的 HMAC-MD5 来演算密码；
-b ：你的密码长度为多少？通常给予 512 位的 HMAC-MD5；
-n ：后面接的则是客户端能够更新的类型，主要有底下两种，建议给 HOST 即可：
     ZONE：客户端可以更新任何标志及整个 ZONE；
     HOST：客户端仅可以针对他的主机名来更新。</span>

[root@www ~]# <span class="term_command">cd /etc/named</span>
[root@www named]# <span class="term_command">dnssec-keygen -a HMAC-MD5 -b 512 -n HOST web</span>
Kweb.+157+36124
[root@www named]# <span class="term_command">ls -l </span>
-rw-------. 1 root root 112 Aug  5 15:22 Kweb.+157+36124.key
-rw-------. 1 root root 229 Aug  5 15:22 Kweb.+157+36124.private
<span class="term_say"># 上面那把是公钥，下面那把则是私钥档案！</span>

[root@www named]# <span class="term_command">cat Kweb.+157+36124.key</span>  <span class="term_note">&lt;==看一下公钥！</span>
web. IN KEY 512 3 157 <u>xZmUo8ozG8f2OSg/cqH8Bqxk59Ho8....3s9IjUxpFB4Q==</u>
<span class="term_say"># 注意到最右边的那个密码长度，等一下我们要复制的仅有那个地方！</span>
</pre></td></tr></tbody></table>

		<p>接下来你必需要：<span class="text_import2">将公钥的密码复制到 /etc/named.conf 当中，将私钥传给你的
		web.centos.vbird 那部主机上！</span>好了，那就开始来修改 named.conf 内的相关设定吧！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vim /etc/named.conf</span>
<span class="term_say">// 先在任意地方加入这个 Key 的相关密码信息！</span>
<span class="term_write">key "web" {
        algorithm hmac-md5;
        secret "xZmUo8ozG8f2OSg/cqH8Bqxk59Ho8....3s9IjUxpFB4Q==";
};</span>

<span class="term_say">// 然后将你原本的 zone 加入底下这一段宣示</span>
        zone "centos.vbird" IN {
                type master;
                file "named.centos.vbird";
                allow-transfer { 192.168.100.10; };
                <span class="term_write">update-policy {
                        grant web name web.centos.vbird. A;
                };</span>
        };

[root@www ~]# <span class="term_command">chmod g+w /var/named</span>
[root@www ~]# <span class="term_command">chown named /var/named/named.centos.vbird</span>
[root@www ~]# <span class="term_command">/etc/init.d/named restart</span>
[root@www ~]# <span class="term_command">setsebool -P named_write_master_zones=1</span>
</pre></td></tr></tbody></table>

		<p>注意到上头的 <span class="text_import1">grant web name web.centos.vbird. A;</span> 那一行，
		grant 后面接的就是 key 的名称，也就是说，我这把 web 的 key 
		在这个 zone (centos.vbird) 里面可以修改主机名 web.centos.vbird
		的 A 的标志，亦即是修改主机的 IP 对应啦！语法也就是：
		<span class="text_import2">grant [key_name] name [hostname] 标签</span>
		也就是说，我的一把 key 其实可以给予多种权限喔！就看你如何规范了。</p>

		<p>设定好之后，由于未来客户端传来的信息是由我们主机的 named 所写入，
		写入的目录在 /var/named/ 当中，所以你必需要修改一下权限喔！
		给他重新启动 DNS，然后观察一下 /var/log/messages 里面有没有错误即可！
		如此一来，DDNS 主机端就设定妥当啰！<br><br></p>

		<ul class="list1"><li class="text_import1"><hr>2. Client 端的更新：</li></ul>

		<p>接下来则是 DDNS Client 端的更新了。首先，你必须要由 Server 端取得刚刚建立的那两个档案，
		请将刚刚建立的 Kweb.+157+36124.key 及 Kweb.+157+36124.private 利用 SSH 的 sftp 传送到客户端，
		亦即是那部 web.centos.vbird 主机上头，
		假设你已经将这两个档案放置到 /usr/local/ddns 里面去，然后测试看看：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@web ~]# <span class="term_command">cd /usr/local/ddns</span>
[root@web ddns]# <span class="term_command">nsupdate -k Kweb.+157+36124.key</span>
&gt; <span class="term_command">server 192.168.100.254</span>
&gt; <span class="term_command">update delete web.centos.vbird                   </span> <span class="term_note">&lt;==删除原有的</span>
&gt; <span class="term_command">update add web.centos.vbird 600 A 192.168.100.200</span> <span class="term_note">&lt;==更新到最新的</span>
&gt; <span class="term_command">send</span>
&gt; <span class="term_say">最后在此按下 [ctrl]+D 即可</span>
</pre></td></tr></tbody></table>

		<p>请注意到『 <span class="text_import2">update add web.centos.vbird 600 A 192.168.100.200</span> 』这行，
		他的意义说的是，新增一笔数据， ttl 是 600 ，给予 A 的标签，对应到 192.168.100.200 的意思～
		至于 nsupdate -k 后面加的则是我们在 Server 端产生的那个 key 档案！</p>

		<p>然后你就会发现到在 DNS 服务器端的 /var/named/ 
		里面多出一个暂存档，那就是 named.centos.vbird.jnl
		当然，/var/named/named.centos.vbird 就会随着客户端的要求而更新数据喔！</p>

		<p>由于手动更新好像挺麻烦的，我们就让 Client 自动更新吧！利用底下这个 script 即可！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@web ~]# <span class="term_command">vim /usr/local/ddns/ddns_update.sh</span>
#!/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
export PATH

# 0. keyin your parameters
<span class="term_write">basedir="/usr/local/ddns"                  # 基本工作目录
keyfile="$basedir"/"Kweb.+157+36124.key"   # 将档名填进去吧！
ttl=600                                    # 你可以指定 ttl 的时间喔！
outif="eth0"                               # 对外的联机接口！
hostname="web.centos.vbird"                # 你向 ISP 取得的那个主机名啦！
servername="192.168.100.254"               # 就是你的 ISP 啊！</span>

# Get your new IP
newip=`ifconfig "$outif" | grep 'inet addr' | \
        awk '{print $2}' | sed -e "s/addr\://"`
checkip=`echo $newip | grep "^[0-9]"`
if [ "$checkip" == "" ]; then
        echo "$0: The interface can't connect internet...."
        exit 1
fi

# create the temporal file
tmpfile=$basedir/tmp.txt
cd $basedir
echo "server $servername"                       &gt;  $tmpfile
echo "update delete $hostname A "               &gt;&gt; $tmpfile
echo "update add    $hostname $ttl A $newip"    &gt;&gt; $tmpfile
echo "send"                                     &gt;&gt; $tmpfile

# send your IP to server
nsupdate -k $keyfile -v $tmpfile
</pre></td></tr></tbody></table>

		<p>你只要将上述的程序里面，特殊字体的部分给他修改一下，就能够以 /etc/crontab 
		的方式在你的系统内自动执行了！这支程序你也可以在底下的连结下载：</p>

		<ul><li><a href="http://linux.vbird.org/linux_server/0350dns/ddns_update.sh">http://linux.vbird.org/linux_server/0350dns/ddns_update.sh</a></li></ul>

		<p>利用 BIND 9 所提供的这个服务，我们只要具有一组固定的 IP ，并向 ISP 申请一个合法授权的 domain name，
		就可以提供不论是固定或者是非固定的 IP 使用者，一个合法的主机名了！
		并且，使用者也可以自行透过 nsupdate 来修改自己的 IP 对应！以让自己的主机 IP 
		永远与主机名保持正确的对应！这对只有拨接制上网的用户来说，真是方便啊！</p>
	</div>
</div><hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
</tbody></table>

<div style="padding-top: 0px; text-align: center;">
<span style="font-size: 80%;">
	<a href="http://linux.vbird.org/" target="_top" title="前往鸟哥的首页">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="联络鸟哥(我不要广告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
         ﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></div>
</div>
</center>
</body></html>
