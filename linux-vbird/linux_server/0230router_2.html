<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-TW" lang="zh-TW"><head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf8">
	<meta name="Author" content="VBird, 鸟哥">
	<meta name="Description" content="使用 Routing 的功能，让 Linux Server 也可以当作 Router 来使用！此外，亦提到 IP aliases 这个好用的功能呢！">
	<title>鸟哥的 Linux 私房菜 -- 架设 Router</title>
    <script src="../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../script/index.js" type="text/javascript"></script>
	<link href="../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    </head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html')">

<center>
<div id="apDiv5">
<div> <LINK REL="SHORTCUT ICON" HREF="../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../linux_basic/0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="../linux_basic/Mandrake9.0/mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="../linux_basic/fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<table summary="本文内容的排版" style="width: 898px;" border="0" cellpadding="0" cellspacing="0">
<tbody><tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
<tr><td style="width: 16px; font-size: 6px;">　</td>
    <td width="866">

<!-- 本文的档头部分 -->
<div style="text-align:center">
    <a href="http://linux.vbird.org/linux_server/0230router.php">
    <span class="text_head0">第八章、路由观念与路由器设定</span></a><br>
</div>
    <div style="text-align:right">
        <span class="text_history">最近更新日期：2011/07/22</span>
    </div>
<!-- 本文的连结区部分 -->
<div class="block1">
<span class="text_h1">
8.2 <a href="#route">路由器架设</a><br>
	<span class="text_h2">
	　　8.2.1 <a href="#route_what">什么是路由器与 IP 分享器</a>： <a href="#sysctl">sysctl.conf</a><br>
	　　8.2.2 <a href="#route_when">何时需要路由器</a><br>
	　　8.2.3 <a href="#route_static">静态路由之路由器</a><br>
	</span>
</span></div>
<!-- 本文的正式部分 -->
<hr><a name="route"></a><img src="../image/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">8.2 路由器架设</span><br>
<div class="block1">
	<p>我们知道在局域网络里面的主机可以透过广播的方式来进行网络封包的传送，但在不同网段内的主机想要互相联机时，就得要透过路由器了。
	那么什么是路由器？他的主要功能是什么？底下我们就来聊一聊！<br><br></p>

	<hr><a name="route_what"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">8.2.1 什么是路由器与 IP 分享器</span><br>
	<div class="block2">
		<p>既然主机想要将数据传送到不同的网域时得透过路由器的帮忙，所以啦，路由器的主要功能就是：『<span class="text_import2">转递网络封包</span>』啰！也就是说，路由器会分析来源端封包的 IP 表头，在表头内找出要送达的目标 
		IP 后，透过路由器本身的路由表 (routing table) 来将这个封包向下一个目标 (next hop) 传送。这就是路由器的功能。
		那么路由器的功能可以如何达成呢？目前有两种方法可以达成：</p>

		<ul>
		<li>硬件功能：例如 Cisco, TP-Link, D-Link (<a href="#ps2">注2</a>) 等公司都有生产硬件路由器，
		这些路由器内有嵌入式的操作系统，可以负责不同网域间的封包转译与转递等功能；<br><br></li>
		<li>软件功能：例如 Linux 这个操作系统的核心就有提供封包转递的能力。</li>
		</ul>

		<p>高阶的路由器可以连结不同的硬设备，并且可以转译很多不同的封包格式，通常...价格也不便宜啊！
		在这个章节里面，我们并没有要探讨这么高阶的咚咚，仅讨论<span class="text_import2">在以太网络里头最简单的路由器功能：
		连接两个不同的网域</span>。嘿嘿！这个功能 Linux 个人计算机就可以达成了！那怎么达成呢？</p>

		<ul class="list1"><li class="text_import1">打开核心的封包转递 (IP forward) 功能</li></ul>

		<p>就如同路由表是由 Linux 的核心功能所提供的，这个转递封包的能力也是 Linux 核心所提供，
		那如何观察核心是否已经有启动封包转递呢？很简单啊，观察核心功能的显示档案即可，如下所示：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">cat /proc/sys/net/ipv4/ip_forward</span>
0  <span class="term_note">&lt;== 0 代表没有启动， 1 代表启动了</span>
</pre></td></tr></tbody></table>

		<a name="sysctl"></a>
		<p>要让该档案的内容变成启动值 1 最简单的方是就是使用：『echo 1 &gt; /proc/sys/net/ipv4/ip_forward』即可。
		不过，这个设定结果在下次重新启动后就会失效。因此，鸟哥建议您直接修改系统配置文件的内容，那就是
		<span class="text_import2">/etc/sysctl.conf</span> 来达成开机启动封包转递的功能喔。</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vim /etc/sysctl.conf</span>
<span class="term_say"># 将底下这个设定值修改正确即可！ (本来值为 0 ，将它改为 1 即可)</span>
<span class="term_write">net.ipv4.ip_forward = 1</span>

[root@www ~]# <span class="term_command">sysctl -p</span>  <span class="term_note">&lt;==立刻让该设定生效</span>
</pre></td></tr></tbody></table>

		<p>sysctl 这个指令是在核心工作时用来直接修改核心参数的一个指令，更多的功能可以参考 man sysctl 查询。
		不要怀疑！只要这个动作，你的 Linux 就具有最简单的路由器功能了。而由于 Linux 
		路由器的路由表设定方法的不同，通常路由器规划其路由的方式就有两种：</p>

		<ul>
		<li>静态路由：直接以类似 route 这个指令来直接设定路由表到核心功能当中，设定值只要与网域环境相符即可。
			不过，当你的网域有变化时，路由器就得要重新设定；<br><br></li>

		<li>动态路由：透过类似 Quagga 或 zebra 软件的功能，这些软件可以安装在 Linux 路由器上，
			而这些软件可以动态的侦测网域的变化，并直接修改 Linux 核心的路由表信息，
			你无须手动以 route 来修改你的路由表信息喔！</li>
		</ul>

		<p>了解了路由器之后，接下来你可能需要了解到什么是 <span class="text_import2">NAT 
		(Network Address Translation, 网络地址转换)</span> 服务器，
		NAT 是啥？其实 IP 分享器就是最简单的 NAT 服务器啦！嘿嘿，了解了吗？没错， NAT 可以达成 IP 分享的功能，
		而 NAT 本身就是一个路由器，只是 NAT 比路由器多了一个『 IP 转换』的功能。怎么说呢？</p>

		<ul>
		<li>一般来说，路由器会有两个网络接口，透过路由器本身的 IP 转递功能让两个网域可以互相沟通网络封包。
			那如果两个接口一边是公共 IP (public IP) 但一边是私有 IP (private IP) 呢？
			由于私有 IP 不能直接与公共 IP 沟通其路由信息，此时就得要额外的『 IP 转译』功能了；<br><br></li>

		<li>Linux 的 NAT 服务器可以透过修改封包的 IP 表头数据之来源或目标 IP ，让来自私有 IP 
			的封包可以转成 NAT 服务器的公共 IP ，就可以连上 Internet ！</li>

		</ul>
		<p>所以说，<span class="text_import2">当路由器两端的网域分别是 Public 与 Private IP 时，才需要 NAT 的功能</span>！
		NAT 功能我们会在下一章<a href="http://linux.vbird.org/linux_server/0250simple_firewall.php">防火墙</a>时谈及，
		这个章节仅谈论一下路由器而已啊！ ^_^</p>
	</div>

	<hr><a name="route_when"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">8.2.2 何时需要路由器</span><br>
	<div class="block2">
		<p>一般来说，计算机数量小于数十部的小型企业是无须路由器的，只需要利用 hub/switch 串接各部计算机，
		然后透过单一线路连接到 Internet 上即可。不过，如果是超过数百部计算机的大型企业环境，
		由于他们的环境通常需要考虑如下的状况，因此才需要路由器的架设：</p>

		<ul style="padding-left: 20px">
		<li><span class="text_import2">实体线路之布线及效能的考虑</span>：<br><br>

		在一栋大楼的不同楼层要串接所有的计算机可能有点难度，那可以透过每个楼层架设一部路由器，
		并将每个楼层路由器相连接，就能够简单的管理各楼层的网络；
		此外，如果各楼层不想架设路由器，而是直接以网络线串接各楼层的 hub/switch 时，
		那由于同一网域的数据是透过广播来传递的，那当整个大楼的某一部计算机在广播时，
		所有的计算机将会予以回应，哇！会造成大楼内网络效能的问题；所以架设路由器将实体线路分隔，
		就有助于这方面的网络效能；<br><br></li>

		<li><span class="text_import2">部门独立与保护数据的考虑</span>：<br><br>

		在阅读过<a href="http://linux.vbird.org/linux_server/0110network_basic.php">第二章网络基础</a>后，你就会晓得，
		只要实体线路是连接在一起的，那么<span class="text_import2">当数据透过广播时，你就可以透过类似
		<a href="http://linux.vbird.org/linux_server/0140networkcommand.php#tcpdump">tcpdump</a> 的指令来监听封包数据，
		并且予以窃取</span>～所以，如果你的部门之间的数据可能需要独立，
		或者是某些重要的资料必须要在公司内部也予以保护时，可以将那些重要的计算机放到一个独立的实体网域，
		并额外加设防火墙、路由器等连接上公司内部的网域。</li>
		</ul>

		<p>路由器就只是一个设备，要如何使用端看你的网络环境的规划！上面仅是举出一些应用案例。
		底下我们先就架设一个静态路由的路由器来玩一玩吧！</p>
	</div>

	<hr><a name="route_static"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">8.2.3 静态路由之路由器</span><br>
	<div class="block2">
		<p>假设在贵公司的网络环境当中，除了一般职员的工作用计算机是直接连接到对外的路由器来连结因特网，
		在内部其实还有一个部门需要较安全的独立环境，因此这部份的网络规划可能是这样的情况 (参考<a href="http://linux.vbird.org/linux_server/0120intranet.php#fig3.2-1">图 3.2-1</a> 内容延伸而来)：</p>

		<a name="fig8.2-1"></a>
		<center><img src="0230router_files/centos6_router_static.gif" alt="静态路由之路由器架构示意图" title="静态路由之路由器架构示意图" border="0"><br>
		图 8.2-1、静态路由之路由器架构示意图<br></center>

		<p>以上图的架构来说，这家公司主要有两个 class C 的网段，分别是：</p>

		<ul>
		<li>一般区网(192.168.1.0/24) ：包括 Router A, workstation 以及 Linux Router 三部主机所构成；</li>
		<li>保护内网(192.168.100.0/24)：包括 Linux Router, clientlinux, winxp, win7 等主机所构成。</li>
		</ul>

		<p>其中 192.168.1.0/24 是用来做为一般员工连接因特网用的，至于 192.168.100.0/24 
		则是给特殊的部门用的。workstation 代表的是一般员工的计算机，clientlinux 及 winxp, win7 则是特殊部门的工作用计算机，
		Linux Router 则是这个特殊部门用来连接到公司内部网域的路由器。在这样的架构下，
		该特殊部门的封包就能够与公司其他部门作实体的分隔了。</p>

		<p>由上图你也不难发现，只要是具有路由器功能的设备 (Router A, Linux Router) 都会具有两个以上的接口，
		分别用来沟通不同的网域，同时该路由器也都会具有一个预设路由啊！ ^_^！
		另外，你还可以加上一些防火墙的软件在 Linux Router 上，以保护 clientlinux, winxp, win7 呢！</p>

		<p>那我们先来探讨一下联机的机制好了，先从 clientlinux 这部计算机谈起。如果 clientlinux 想要连上 
		Internet，那么他的联机情况会是如何？</p>

		<ul>
		<li>发起联机需求：clientlinux --&gt; Linux Router --&gt; Router A --&gt; Internet</li>
		<li>响应联机需求：Internet --&gt; Router A --&gt; Linux Router --&gt; clientlinux</li>
		</ul>

		<p>观察一下两部 Router 的设定，要达到上述功能，则 Router A 必须要有两个接口，一个是对外的 Public IP 一个则是对内的
		Private IP ，因为 IP 的类别不同，因此 Router A 还需要额外增加 NAT 这个机制才行，这个机制我们在后续章节会继续谈到。
		除此之外，Router A 并不需要什么额外的设定。至于 Linux Router 就更简单了！什么事都不用作，将两个网络适配器设定两个 IP ，
		并且启动核心的封包转递功能，立刻就架设完毕了！非常简单！我们就来谈一谈这几个机器的设定吧！<br><br></p>

		<hr><ul class="list1"><li><span class="text_import1">Linux Router</span></li></ul>

		<p>在这部主机内需要有两张网卡，鸟哥在这里将他定义为 (假设你已经将刚刚实作的 eth0:0 取消掉了)：</p>
		<ul style="font-family: '细明体'"><li>eth0: 192.168.1.100/24</li>
		<li>eth1: 192.168.100.254/24</li></ul>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 再看看 eth0 的设定吧！虽然我们已经在第四章就搞定了：</span>
[root@www ~]# <span class="term_command">vim /etc/sysconfig/network-scripts/ifcfg-eth0</span>
<span class="term_write">DEVICE="eth0"
HWADDR="08:00:27:71:85:BD"
NM_CONTROLLED="no"
ONBOOT="yes"
BOOTPROTO=none
IPADDR=192.168.1.100
NETMASK=255.255.255.0
GATEWAY=192.168.1.254   <span class="term_note">&lt;==最重要的设定啊！透过这部主机连出去的！</span></span>

<span class="term_hd"># 2. 再处理 eth1 这张之前一直都没有驱动的网络卡吧！</span>
[root@www ~]# <span class="term_command">vim /etc/sysconfig/network-scripts/ifcfg-eth1</span>
<span class="term_write">DEVICE="eth1"
HWADDR="08:00:27:2A:30:14"
NM_CONTROLLED="no"
ONBOOT="yes"
BOOTPROTO="none"
IPADDR=192.168.100.254
NETMASK=255.255.255.0</span>

<span class="term_hd"># 3. 启动 IP 转递，真的来实作成功才行！</span>
[root@www ~]# <span class="term_command">vim /etc/sysctl.conf</span>
<span class="term_write">net.ipv4.ip_forward = 1</span>
<span class="term_say"># 找到上述的设定值，将默认值 0 改为上述的 1 即可！储存后离开去！</span>
[root@www ~]# <span class="term_command">sysctl -p</span>
[root@www ~]# <span class="term_command">cat /proc/sys/net/ipv4/ip_forward</span>
1   <span class="term_note">&lt;==这就是重点！要是 1 才可以呦！</span>

<span class="term_hd"># 4. 重新启动网络，并且观察路由与 ping Router A</span>
[root@www ~]# <span class="term_command">/etc/init.d/network restart</span>
[root@www ~]# <span class="term_command">route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.100.0   0.0.0.0         255.255.255.0   U     0      0        0 eth1
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
<u>0.0.0.0         192.168.1.254   0.0.0.0</u>         UG    0      0        0 eth0
<span class="term_say"># 上面的重点在于最后面那个路由器的设定是否正确呦！</span>

[root@www ~]# <span class="term_command">ping -c 2 192.168.1.254</span>
PING 192.168.1.254 (192.168.1.254) 56(84) bytes of data.
64 bytes from 192.168.1.254: icmp_seq=1 ttl=64 <u>time=0.294 ms</u>
64 bytes from 192.168.1.254: icmp_seq=2 ttl=64 <u>time=0.119 ms</u> <span class="term_note">&lt;==有回应即可</span>

<span class="term_hd"># 5. 暂时关闭防火墙！这一步也很重要喔！</span>
[root@www ~]# <span class="term_command">/etc/init.d/iptables stop</span>
</pre></td></tr></tbody></table>

		<p>有够简单吧！而且透过最后的 ping 我们也知道 Linux Router 可以连上 Router A 啰！这样你的 Linux Router 就 OK 
		了吶！此外，CentOS 6.x 默认的防火墙规则会将来自不同网卡的沟通封包剔除，所以还得要暂时关闭防火墙才行。
		接下来则是要设定 clientlinux 这个被保护的内部主机网络啰。<br><br></p>

		<hr><ul class="list1"><li><span class="text_import1">受保护的网域，以 clientlinux 为例</span></li></ul>

		<p>不论你的 clientlinux 是哪一种操作系统，你的环境都应该是这样的 (<a href="#fig8.2-1">图 8.2-1</a>)：</p>

		<ul style="font-family: '细明体'">
		<li>IP: 192.168.100.10</li>
		<li>netmask: 255.255.255.0</li>
		<li>gateway: 192.168.100.254</li>
		<li>hostname: clientlinux.centos.vbird</li>
		<li>DNS: 168.95.1.1</li>
		</ul>
		<p>以 Linux 操作系统为例，并且 clientlinux 仅有 eth0 一张网卡时，他的设定是这样的：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@clientlinux ~]# <span class="term_command">vim /etc/sysconfig/network-scripts/ifcfg-eth0</span>
<span class="term_write">DEVICE="eth0"
NM_CONTROLLED="no"
ONBOOT="yes"
BOOTPROTO=none
IPADDR=192.168.100.10
NETMASK=255.255.255.0
GATEWAY=192.168.100.254  <span class="term_note">&lt;==这个设定最重要啦！</span>
DNS1=168.95.1.1          <span class="term_note">&lt;==有这个就不用自己改 /etc/resolv.conf</span></span>

[root@clientlinux ~]# <span class="term_command">/etc/init.d/network restart</span>
[root@clientlinux ~]# <span class="term_command">route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.100.0   0.0.0.0         255.255.255.0   U     1      0        0 eth0
169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 eth0
<u>0.0.0.0         192.168.100.254 0.0.0.0</u>         UG    0      0        0 eth0

[root@clientlinux ~]# <span class="term_command">ping -c 2 192.168.100.254</span> <span class="term_note">&lt;==ping自己的gateway(会成功)</span>
[root@clientlinux ~]# <span class="term_command">ping -c 2 192.168.1.254  </span> <span class="term_note">&lt;==ping外部的gateway(会失败)</span>
</pre></td></tr></tbody></table>

		<p>最后一个动作有问题呦！怎么会连 ping 都没有办法 ping 到 Router A 的 IP 呢？如果连 ping 都没有办法给予回应的话，
		那么表示我们的联机是有问题的！再从刚刚的响应联机需求流程来看一下吧！</p>

		<ul>
		<li>发起联机：clientlinux --&gt; Linux Router (OK) --&gt; Router A (OK)</li>
		<li class="text_import2">回应联机：Router A (此时 router A 要响应的目标是 192.168.100.10)，Router A 仅有 public 
		与 192.168.1.0/24 的路由，所以该封包会由 public 界面再传出去，因此封包就回不来了...</li>
		</ul>

		<p>发现了吗？网络是双向的，此时封包出的去，但是非常可怜的，封包回不来～那怎办呢？只好告知 Router A 当路由规则碰到 
		192.168.100.0/24 时，要将该封包传 192.168.1.100 就是了！所以你要这样进行。<br><br></p>

		<hr><ul class="list1"><li><span class="text_import1">特别的路由规则： Router A 所需路由</span></li></ul>

		<p>假设我的 Router A 对外的网卡为 eth1 ，而内部的 192.168.1.254 则是设定在 eth0 上头。
		那怎么在 Router A 增加一条路由规则呢？很简单啊！直接使用 route add 去增加即可！如下所示的情况：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@routera ~]# <span class="term_command">route add -net 192.168.100.0 netmask 255.255.255.0 \</span>
&gt;  <span class="term_command">gw 192.168.1.100</span>
</pre></td></tr></tbody></table>

		<p>不过这个规则并不会写入到配置文件，因此下次重新启动这个规则就不见了！所以，你应该要建立一个路由配置文件。
		由于这个路由是依附在 eth0 网卡上的，所以配置文件的档名应该要是 route-eth0 喔！这个配置文件的内容当中，我们要设定
		192.168.100.0/24 这个网域的 gateway 是 192.168.1.100，且是透过 eth0 ，那么写法就会变成：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@routera ~]# <span class="term_command">vim /etc/sysconfig/network-scripts/route-eth0</span>
<span class="term_write">192.168.100.0/24 via 192.168.1.100 dev eth0</span>
目标网域             透过的gateway     装置

[root@routera ~]# <span class="term_command">route -n</span>
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
120.114.142.0   0.0.0.0         255.255.255.0   U     0      0        0 eth1
<u>192.168.100.0   192.168.1.100   255.255.255.0   UG    0      0        0 eth0</u>
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
169.254.0.0     0.0.0.0         255.255.0.0     U     0      0        0 eth1
0.0.0.0         120.114.142.254 0.0.0.0         UG    0      0        0 eth1
</pre></td></tr></tbody></table>

		<p>上述观察的重点在于有没有出现 192.168.100.0 那行路由！如果有的话，请 ping 192.168.100.10 看看能不能有回应？
		然后再到 clientlinux 上面去 ping 192.168.1.254 看看有没有响应，你就知道设定成功啰！好了，既然内部保护网络已经可以连上 
		Internet 了，那么是否代表 clientlinux 可以直接与一般员工的网域，例如 workstation 
		进行联机呢？我们依旧透过路由规则来探讨一下，当 clientlinux 要直接联机到 workstation 
		时，他的联机方向是这样的 (参考<a href="#fig8.2-1">图 8.2-1</a>)：</p>

		<ul>
		<li>联机发起： clientlinux --&gt; Linux Router (OK) --&gt; workstation (OK)</li>
		<li class="text_import2">回应联机： workstation (联机目标为 192.168.100.10，因为并没有该路由规则，因此联机丢给 
		default gateway，亦即是 Router A) --&gt; Router A (OK) --&gt; Linux Router (OK) --&gt; clientlinux</li>
		</ul>

		<p>有没有发现一个很可爱的传输流程？联机发起是没有问题啦，不过呢，响应联机竟然会偷偷透过 Router A 来帮忙呦！
		这是因为 workstation 与当初的 Router A 一样，并不知道 192.168.100.0/24 在 192.168.1.100 里面啦！不过，反正 
		Router A 已经知道了该网域在 Linux Router 内，所以，该封包还是可以顺利的回到 clientlinux 就是了。<br><br></p>

		<hr><ul class="list1"><li><span class="text_import1">让 workstation 与 clientlinux 不透过 Router A 
		的沟通方式</span></li></ul>

		<p>如果你不想要让 workstation 得要透过 Router A 才能够联机到 clientlinux 的话，那么就得要与 Router A 
		相同，增加那一条路由规则啰！如果是 Linux 的系统，那么如同 Router A 一样的设定如下：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@workstation ~]# <span class="term_command">vim /etc/sysconfig/network-scripts/route-eth0</span>
<span class="term_write">192.168.100.0/24 via 192.168.1.100 dev eth0</span>

[root@workstation ~]# <span class="term_command">/etc/init.d/network restart</span>
[root@www ~]# <span class="term_command">route -n</span>
Kernel IP routing table
Destination    Gateway        Genmask         Flags Metric Ref  Use Iface
192.168.1.0    0.0.0.0        255.255.255.0   U     0      0      0 eth0
<u>192.168.100.0  192.168.1.100  255.255.255.0</u>   UG    0      0      0 eth0
169.254.0.0    0.0.0.0        255.255.0.0     U     0      0      0 eth0
0.0.0.0        192.168.1.254  0.0.0.0         UG    0      0      0 eth0
</pre></td></tr></tbody></table>

		<p>最后只要 clientlinux 使用 ping 可以连到 workstation，同样的，workstation 也可以 ping 到 clientlinux
		的话，就表示你的设定是 OK 的啦！搞定！而透过这样的设定方式，你也可以发现到一件事，那就是：『<span class="text_import2">路由是双向的，你必须要了解出去的路由与回来时的规则</span>』。
		举例来说，在预设的情况下 (Router A 与 workstation 都没有额外的路由设定时)，其实封包是可以由 clientlinux
		联机到 workstation 的，但是 workstation 却没有相关的路由可以响应到 clientlinux ～所以上头才会要你在 Router A
		或者是 workstation 上面设定额外的路由规则啊！这样说，瞭了吧？ ^_^</p>

		<p>用 Linux 作一个静态路由的 Router 很简单吧！以上面的案例来说，你在 Linux Router 
		上面几乎没有作什么额外的工作，只要将网络 IP 与网络接口对应好启动，然后加上 IP Forward 的功能，
		让你的 Linux 核心支持封包转递，然后其他的工作咱们的 Linux kernel 就主动帮你搞定了！真是好简单！</p>

		<p>不过这里必须要提醒的是，<span class="text_import2">如果你的 Linux Router 有设定防火墙的话，
		而且还有设定类似 NAT 主机的 IP 伪装技术，那可得特别留意，因为还可能会造成路由误判的问题</span>～
		上述的 Linux Router 当中『并没有使用到任何 NAT 的功能』喔！特别给他留意到！</p>
	</div>
</div><hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
</tbody></table>

<div style="padding-top: 0px; text-align: center;">
<span style="font-size: 80%;">
	<a href="http://linux.vbird.org/" target="_top" title="前往鸟哥的首页">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="联络鸟哥(我不要广告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
         ﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></div>
</div>
</center>
</body></html>
