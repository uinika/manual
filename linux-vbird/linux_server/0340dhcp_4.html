<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-TW" lang="zh-TW"><head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf8">
	<meta name="Author" content="VBird, 鸟哥">
	<meta name="Description" content="Dynamic Host Configuration Protocol 主机的设定问题(类似 IP 分享器的后端功能)">
	<title>鸟哥的 Linux 私房菜 -- DHCP 服务器</title>
    <script src="../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../script/index.js" type="text/javascript"></script>
	<link href="../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    </head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html')">

<center>
<div id="apDiv5">
<div> <LINK REL="SHORTCUT ICON" HREF="../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../linux_basic/0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="../linux_basic/Mandrake9.0/mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="../linux_basic/fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<table summary="本文内容的排版" style="width: 898px;" border="0" cellpadding="0" cellspacing="0">
<tbody><tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
<tr><td style="width: 16px; font-size: 6px;">　</td>
    <td width="866">

<!-- 本文的档头部分 -->
<div style="text-align:center">
    <a href="http://linux.vbird.org/linux_server/0340dhcp.php">
    <span class="text_head0">第十二章、网络参数控管者：<span class="text_head_en"> DHCP </span>服务器</span></a><br>
</div>
    <div style="text-align:right">
        <span class="text_history">最近更新日期：2011/07/27</span>
    </div>
<!-- 本文的连结区部分 -->
<div class="block1">
<span class="text_h1">
12.4 <a href="#other">DHCP 服务器端进阶观察与使用</a><br>
	<span class="text_h2">
	　　12.4.1 <a href="#other_lease">检查租约档案</a><br>
	　　12.4.2 <a href="#other_amount">让大量 PC 都具有固定 IP 的脚本</a><br>
	　　12.4.3 <a href="#other_remote">使用 ether-wake 实行远程自动开机 (remote boot)</a><br>
	　　12.4.4 <a href="#other_dns">DHCP 与 DNS 的关系</a><br>
	</span>
</span></div>
<!-- 本文的正式部分 -->
<hr><a name="other"></a><img src="../image/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">12.4 DHCP 服务器端进阶观察与使用</span><br>
<div class="block1">
	<p>如果你要管理的是几十部甚至是几百部的计算机时，你总是希望能够根据座位来进行 IP 的给予吧？因此，固定 IP 配合 MAC
	就显的很重要啦！那么如何取得每部主机的 IP 呢？还有，你怎么查询到相关的租约呢？以及，如果你还想要进行远程开机，
	帮使用者在固定的时间就开机呢？那就来看看底下的其他用途吧！<br><br></p>

	<hr><a name="other_lease"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">12.4.1 检查租约档案</span><br>
	<div class="block2">
		<p>客户端会主动的纪录租约信息，那服务器端更不能忘记记录啰！服务器端是记录在这个地方：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">cat /var/lib/dhcpd/dhcpd.leases</span>
lease 192.168.100.101 {
  starts 2 2011/07/26 18:06:36;  <span class="term_note">&lt;==租约开始日期</span>
  ends 5 2011/07/29 18:06:36;    <span class="term_note">&lt;==租约结束日期</span>
  tstp 5 2011/07/29 18:06:36;
  cltt 2 2011/07/26 18:06:36;
  binding state active;
  next binding state free;
  hardware ethernet 08:00:27:34:4e:44; <span class="term_note">&lt;==客户端网卡</span>
}
</pre></td></tr></tbody></table>

		<p>从这个档案里面我们就知道有多少客户端已经向我们申请了 DHCP 的 IP 使用了呢！很容易了解吧！</p>
	</div>

	<hr><a name="other_amount"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">12.4.2 让大量 PC 都具有固定 IP 
	的脚本</span><br>
	<div class="block2">
		<p>想一想，如果你有一百台计算机要管理，每部计算机都希望是固定 IP 的情况下，那你要如何处置？
		很简单，透过 DHCP 的 fixed-address 就行啦！但是，这一百台计算机的 MAC 如何取得？你要怎么改啦？
		难道每部计算机都去抄写，然后再回来设定 dhcpd.conf 吗？这也太可怕了吧？既然每部计算机最终都得要开机，
		那么你在开机之后，利用手动的方法来设定好每部主机的 IP 后，在根据底下的脚本来处理好你的 dhcpd.conf 啰！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vim setup_dhcpd.conf</span>
#!/bin/bash
read -p "Do you finished the IP's settings in every client (y/n)? " yn
read -p "How many PC's in this class (ex&gt; 60)? " num
if [ "$yn" = "y" ]; then
        for site in $(seq 1 ${num})
        do
                siteip="192.168.100.${site}"
                allip="$allip $siteip"
                ping -c 1 -w 1 $siteip &gt; /dev/null 2&gt;&amp;1
                if [ "$?" == "0" ]; then
                        okip="$okip $siteip"
                else
                        errorip="$errorip $siteip"
                        echo "$siteip is DOWN"
                fi
        done
        [ -f dhcpd.conf ] &amp;&amp; rm dhcpd.conf
        for site in $allip
        do
                pcname=pc$(echo $site | cut -d '.' -f 4)
                mac=$(arp -n | grep "$site " | awk '{print $3}')
                echo "  host $pcname {"
                echo "          hardware ethernet ${mac};"
                echo "          fixed-address     ${site};"
                echo "  }"
                echo "  host $pcname {"                         &gt;&gt; dhcpd.conf
                echo "          hardware ethernet ${mac};"      &gt;&gt; dhcpd.conf
                echo "          fixed-address     ${site};"     &gt;&gt; dhcpd.conf
                echo "  }"                                      &gt;&gt; dhcpd.conf
        done
fi
echo "You can use dhcpd.conf (this directory) to modified your /etc/dhcp/dhcpd.conf"
echo "Finished."
</pre></td></tr></tbody></table>

		<p>这个脚本的想法很简单，如果你管理的计算机都是 Linux 的话，那么先开机后使用『 ifconfig eth0 YOURIP 』
		来设定对应的 IP ，在鸟哥这个例子中，我使用的是 192.168.100.X/24 这个区段，此时 IP 就设定好了！
		然后在透过上面的脚本跑一次，每部计算机的 MAC 与 IP 对应就顺利的写入 dhcpd.conf 啰！
		然后你在将它贴上 /etc/dhcp/dhcpd.conf 即可！如果你管理的计算机是 Windows 的话，
		那使用文字接口下达『 netsh interface ip set address xxx 』之类的指令来修订啰！</p>
	</div>

	<hr><a name="other_remote"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">12.4.3 使用 ether-wake 实行远程自动开机 
	(remote boot)</span><br>
	<div class="block2">
		<p>既然已经知道客户端的 MAC 地址了，如果<span class="text_import2">客户端的主机符合一些电源标准，
		并且该客户端主机所使用之网络卡暨主板支持网络唤醒的功能时，我们就可以透过网络来让客户端计算机开机</span>了。
		如果你有一部主机想要让他可以透过网络来启动时，你必须要在这部客户端计算机上进行：</p>

		<ol class="text_import2">
		<li>首先你得要在 BIOS 里面设定『网络唤醒』的功能，否则是没有用的喔！</li>
		<li>再来你必须要让这部主机接上网络线，并且电源也是接通的。</li>
		<li>将这部主机的 MAC 抄下来，然后关机等待网络唤醒。</li>
		</ol>

		<p>接下来请到永远开着的主机 DHCP 服务器上面 (其实只要任何一部 Linux 主机均可！) ，安装 net-tools 这个软件后，
		就会取得 ether-wake 这个指令，这就是网络唤醒的主要功能！那该如何使用这个指令呢？假设客户端主机的 MAC 为 
		11:22:33:44:55:66 并且与我的服务器 eth1 相连接好了，那么你想要让这部主机被唤醒，就这样做吧：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">ether-wake -i eth1 11:22:33:44:55:66</span>

<span class="term_say"># 更多功能可以这样查阅喔：</span>
[root@www ~]# <span class="term_command">ether-wake -u</span>
</pre></td></tr></tbody></table>

		<p>然后你就会发现，哈哈！那部客户端主机被启动了！以后如果你要连到局域网络内的话，
		只要能够连上你的防火墙主机，然后透过这个 ether-wake 软件，就能够让你局域网络内的主机启动了，
		控管上面就更加方便的啦！你说是吧！ ^_^</p>

		<div style="padding: 10pt 0pt 10pt 0pt ;" align="right"><table width="90%"><tbody><tr><td><b>Tips:</b><br><span style="color : #009000"><font size="-1">		鸟哥办公室有一部桌机是经常用来测试的机器，但是因为比较耗电，因此当鸟哥离开办公室时，就会将计算机关闭。
		不过鸟哥办公室有一部 NAT server 在负责防火墙的第一道关卡，当鸟哥在家里有需要查询到学校桌机的数据时，
		桌机关了怎办？没关系，透过 NAT server  登入后，使用 ether-wake 唤醒桌机，那就能够开机进去工作啰！
		这样也比较不怕耗电问题～
		</font></span></td><td><img src="0340dhcp_files/vbird_face.gif" alt="鸟哥的图示" title="鸟哥的图示"></td></tr></tbody></table></div>	</div>

	<hr><a name="other_dns"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">12.4.4 DHCP 与 DNS 的关系</span><br>
	<div class="block2">
		<p>我们知道局域网络内如果很多 Linux 服务器时，你得要将 private IP 加入到每部主机的 /etc/hosts 里面，
		这样在联机阶段的等待时间才不会有逾时或者是等待太久的问题。问题是，如果计算机数量太大，又有很多测试机时，
		这时你得要常常去更新维护那些重灌过的机器的 /etc/hosts ，烦不烦吶？</p>

		<p>此时在区网内架设一部 DNS 
		服务器负责主机名解析就很重要！因此既然已经有 DNS 服务器帮忙进行主机名的解析，那你根本不需要更动 
		/etc/hosts ！未来的新机器或者是新灌的计算机也不需要改写任何网络参数，这样维护会轻松很多。
		因此，一个好的区网内，理论上，我们应该在 DHCP 服务器主机上面在安装一个 DNS 服务器，提供内部计算机的名称解析为宜。
		相关的设定就请参考<a href="http://linux.vbird.org/linux_server/0350dns.php">第十九章 DNS</a> 的介绍啰。<br><br></p>

		<ul class="list1"><li class="text_import1"><hr>DHCP 响应速度与有网管 switch 的设定问题</li></ul>

		<p>鸟哥在昆山信息传播系 (<a href="http://www.dic.ksu.edu.tw/" target="_blank">http://www.dic.ksu.edu.tw</a>)
		负责五间计算机教室的维护，每间计算机教室内部的 giga switch 是低阶的有网管功能的机器！有网管功能机器的设定信息比较多，
		switch 也能够进行封包异常的侦测与抵挡。问题是，如果抵挡的行为『太超过』时，也可能造成许多问题。</p>

		<p>鸟哥管理的计算机教室在重新启动网络取得 DHCP 时，都会等待几乎达 30 秒，虽然最终是成功的，但是等这么久呢！
		取得 IP 之后，网络速度却又是正常的，一切没问题～就是教导网络参数设定时，学生都会哇哇叫！以为失败了，
		有的等了将近一分钟才告知取得 IP 且为正常...</p>

		<p>后来问了有经验的计中的罗组长，才发现可能是 switch 的问题。大多在设定位于『L2 Features』--&gt;『Spanning 
		Tree』--&gt;『STP Port Settings』的子项目之类的字眼，将 STP 之类的埠口都设定为关闭 (Disabled) 看看，
		鸟哥做完这个设定后，DHCP 的取得就顺畅了！连带的网络开机功能也就没有问题～这部份也提供给大家参考呦！</p>

		<div style="padding: 10pt 0pt 10pt 0pt ;" align="right"><table width="90%"><tbody><tr><td><b>Tips:</b><br><span style="color : #009000"><font size="-1">		网友巩立伟兄来信谈到，STP 主要的目的是在抵挡广播风暴，若侦测到广播风暴时，该 switch 的埠口会被停用。
		只是启动这个功能后，会较缓慢的进入运作状态，所以会产生较慢的情况发生。较好的 switch 会支援 RSTP
		(Rapid spanning tree protocol)，速度会较快一些。感谢朋友提供的信息喔！^_^
		</font></span></td><td><img src="0340dhcp_files/vbird_face.gif" alt="鸟哥的图示" title="鸟哥的图示"></td></tr></tbody></table></div>	</div>
</div>
<hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
</tbody></table>

<div style="padding-top: 0px; text-align: center;">
<span style="font-size: 80%;">
	<a href="http://linux.vbird.org/" target="_top" title="前往鸟哥的首页">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="联络鸟哥(我不要广告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
         ﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></div>
</div>
</center>
</body></html>
