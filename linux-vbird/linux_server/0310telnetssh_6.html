<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-TW" lang="zh-TW"><head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf8">
	<meta name="Author" content="VBird, 鸟哥">
	<meta name="Description" content="关于文字接口登入主机的 ssh 及图形接口登入主机的 VNC/XDMCP 等方法">
	<title>鸟哥的 Linux 私房菜 -- 远程联机服务器 SSH/XDMCP/VNC/RDP</title>
    <script src="../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../script/index.js" type="text/javascript"></script>
	<link href="../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    </head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html')">

<center>
<div id="apDiv5">
<div> <LINK REL="SHORTCUT ICON" HREF="../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../linux_basic/0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="../linux_basic/Mandrake9.0/mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="../linux_basic/fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<table summary="本文内容的排版" style="width: 898px;" border="0" cellpadding="0" cellspacing="0">
<tbody><tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
<tr><td style="width: 16px; font-size: 6px;">　</td>
    <td width="866">

<!-- 本文的档头部分 -->
<div style="text-align:center">
    <a href="http://linux.vbird.org/linux_server/0310telnetssh.php">
    <span class="text_head0">第十一章、远程联机服务器<span class="text_head_en">SSH / XDMCP / VNC / RDP</span></span></a><br>
</div>
    <div style="text-align:right">
        <span class="text_history">最近更新日期：2011/11/24</span>
    </div>
<!-- 本文的连结区部分 -->
<div class="block1">
<span class="text_h1">
11.6 <a href="#adv_ssh">SSH 服务器的进阶应用</a><br>
	<span class="text_h2">
	　　11.6.1 <a href="#ssh_port">启动 ssh 在非正规埠口 (非 port 22)</a><br>
	　　11.6.2 <a href="#rsync">以 rsync 进行同步镜相备份</a><br>
	　　11.6.3 <a href="#ssh_enc">透过 ssh 通道加密原本无加密的服务</a><br>
	　　11.6.4 <a href="#ssh_xserver">以 ssh 信道配合 X server 传递图形接口</a><br>
	</span>
</span></div>
<!-- 本文的正式部分 -->
<hr><a name="adv_ssh"></a><img src="../image/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">11.6 SSH 服务器的进阶应用</span><br>
<div class="block1">
	<p>事实上 ssh 真的很好用！你甚至不需要启动甚么 xdmcp, vnc, xrdp 等等服务，使用 ssh 的加密通道就能够在客户端启动图形接口！
	此外，我们知道很多服务都是没有加密的，那么能不能将这些服务透过 ssh 通道来加密呢？嘿嘿！当然是可以！
	在这个章节当中，我们就来谈谈一些 ssh 的进阶应用吧！<br><br></p>

	<hr><a name="ssh_port"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">11.6.1 启动 ssh 在非正规埠口 (非 port 22)</span><br>
	<div class="block2">
		<p>从前面的章节里面我们就曾经提过， sshd 这个服务其实并不是很安全，所以很多 ISP 在入口处就已经将 port 22
		关闭了！为什么要这么作呢？这是因为很多网站管理员并没有定期的进行软件 update ，而且为了方便，又很开心的将
		port 22 对全世界开放。由于很多 cracker 会使用扫描程序乱扫整个 Internet 的埠口漏洞，这个 port 22 
		就是一个很常被扫描的端口啦！为了杜绝这个问题，所以 ISP 先帮你把关，先将 port 22 关闭！这也是为了整个区网好！</p>

		<p>只是，像鸟哥这种没有 ssh 就快要活不下去的人，关闭了 port 22 那鸟哥的头都痛了！没有办法工作啊！
		那怎办？没关系，其实我们可以将 ssh 开放在非正规的埠口。如此一来， cracker 不会扫描到该端口，而你的
		ISP 又没有对该埠口进行限制，那你就能够使用 ssh 啰！很棒吧！那就来试看看。我们底下将 ssh 开放在 port 22 及
		port 23 试看看 (请注意， port 23 不能够有被使用喔！)。<br><br></p>

		<ul class="list1"><li class="text_import1"><hr>设定 ssh 在 port 22 及 23 两个埠口的设定方式</li></ul>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vim /etc/ssh/sshd_config</span>
<span class="term_write">Port 22
Port 23</span>    <span class="term_note">&lt;==注意喔！要有两个 Port 的设定才行！</span>

[root@www ~]# <span class="term_command">/etc/init.d/sshd restart</span>
</pre></td></tr></tbody></table>

		<p>但是这一版的 CentOS 却将 SSH 规范 port 仅能启动于 22 而已，所以此时会出现一个 SELinux 的错误！那怎办？没关系，
		根据 setroubleshoot 的提示，我们必须要自行定义一个 SELinux 的规则放行模块才行！有没有很难呢？其实还算简单！
		整体流程是这样的：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 于 /var/log/audit/audit.log 找出与 ssh 有关的 AVC 信息，并转为本地模块</span>
[root@www ~]# <span class="term_command">cat /var/log/audit/audit.log | grep AVC | grep ssh | \</span>
&gt; <span class="term_command"> audit2allow -m sshlocal &gt; sshlocal.te</span>  <span class="term_note">&lt;==扩展名要是 .te 才行</span>
[root@www ~]# <span class="term_command">grep sshd_t /var/log/audit/audit.log | \</span>
&gt; <span class="term_command"> audit2allow -M sshlocal</span>  <span class="term_note">&lt;==sshlocal 就是刚刚建立的 .te 檔名</span>
******************** IMPORTANT ***********************
To make this policy package active, execute:
semodule -i sshlocal.pp   <span class="term_note">&lt;==这个指令会编译出这个重要的 .pp 模块！</span>

<span class="term_hd"># 2. 将这个模块加载系统的 SELinux 管理当中！</span>
[root@www ~]# <span class="term_command">semodule -i sshlocal.pp</span>

<span class="term_hd"># 3. 再重新启动 sshd 并且观察埠口吧！</span>
[root@www ~]# <span class="term_command">/etc/init.d/sshd restart</span>
[root@www ~]# <span class="term_command">netstat -tlunp | grep ssh</span>
tcp        0      0 0.0.0.0:22   0.0.0.0:*    LISTEN      7322/sshd
tcp        0      0 0.0.0.0:23   0.0.0.0:*    LISTEN      7322/sshd
tcp        0      0 :::22        :::*         LISTEN      7322/sshd
tcp        0      0 :::23        :::*         LISTEN      7322/sshd
</pre></td></tr></tbody></table>

		<p>有没有很简单！这样你就能够使用 port 22 或 port 23 联机到你的 sshd 服务喔！<br><br></p>

		<ul class="list1"><li class="text_import1"><hr>非正规埠口的联机方式</li></ul>

		<p>由于预设的 ssh, scp, sftp 都是连接到 port 22 的，那么如何使用这些指令联机到 port 23 呢？
		我们使用 ssh 当练习好了：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">ssh -p 23 root@localhost</span>
root@localhost's password:
Last login: Tue Jul 26 14:07:41 2011 from 192.168.1.101
[root@www ~]# <span class="term_command">netstat -tnp | grep 23</span>
tcp  0  0 ::1:23               ::1:56645              ESTABLISHED 7327/2
tcp  0  0 ::1:56645            ::1:23                 ESTABLISHED 7326/ssh
<span class="term_say"># 因为网络是双向的，因此自己连自己 (localhost)，就会抓到两只联机！</span>
</pre></td></tr></tbody></table>

		<p>这样，你就能够避过一些 ISP 或者是 cracker 的扫描了！注意一下，不要将 port 开放在某些既知的埠口上，
		例如你开放在 port 80 的话，那你就没有办法启动正常的 WWW 服务啦！注意注意！</p>
	</div>

	<hr><a name="rsync"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">11.6.2 以 rsync 进行同步镜像备份</span><br>
	<div class="block2">
		<p>我们曾在基础篇第三版第二十五章里头谈到 <a href="http://linux.vbird.org/linux_basic/0580backup.php">Linux 的备份策略</a>，
		该篇曾介绍常用的备份指令，包括 tar, dd, cp 等等，不过当时并未介绍网络，所以有个很棒的网络工具没有介绍，
		那就是这个地方要谈到的 rsync 啦！这个 rsync 可以作为一个相当棒的异地备援系统的备份指令喔！
		因为 rsync 可以达到类似『镜相 (mirror) 』的功能呢！</p>

		<p>rsync 最早是想要取代 rcp 这个指令的，因为 rsync 不但传输的速度快，而且他在传输时，
		可以比对本地端与远程主机欲复制的档案内容，而仅复制两端有差异的档案而已，所以传输的时间就相对的降低很多！
		此外， rsync 的传输方式至少可以透过三种方式来运作：</p>

		<ul class="text_import2">
		<li>在本机上直接运作，用法就与 cp 几乎一模一样，例如：<br>
		rsync -av /etc /tmp (将 /etc/ 的数据备份到 /tmp/etc 内)<br><br></li>
		<li>透过 rsh 或 ssh 的信道在 server / client 之间进行数据传输，例如：<br>
		rsync -av -e ssh user@rsh.server:/etc /tmp (将 rsh.server 的 /etc 备份到本地主机的 /tmp 内)<br><br></li>
		<li>直接透过 rsync 提供的服务 (daemon) 来传输，此时 rsync 主机需要启动 873 port：<br>
		1. 你必须要在 server 端启动 rsync ， 看 /etc/xinetd.d/rsync 即可；<br>
		2. 你必须编辑 /etc/rsyncd.conf 配置文件；<br>
		3. 你必须设定好 client 端联机的密码数据；<br>
		4. 在 client 端可以利用：rsync -av user@hostname::/dir/path /local/path</li>
		</ul>

		<p>其实三种传输模式差异在于有没有冒号 (:) 而已，本地端传输不需要冒号，透过 ssh 或 rsh 时，就得要利用一个冒号 (:)，
		如果是透过 rsync daemon 的话，就得要两个冒号 (::) ，应该不难理解啦！因为本地端处理很简单，
		而我们的系统本来就有提供 ssh 的服务，所以，底下鸟哥将直接介绍利用 rsync 透过 ssh 来备份的动作喔。
		不过，在此之前咱们先来看看 rsync 的语法吧！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">rsync [-avrlptgoD] [-e ssh] [user@host:/dir] [/local/path]</span>
<span class="term_say">选项与参数：
-v ：观察模式，可以列出更多的信息，包括镜像时的档案档名等；
-q ：与 -v  相反，安静模式，略过正常信息，仅显示错误讯息；
-r ：递归复制！可以针对『目录』来处理！很重要！
-u ：仅更新 (update)，若目标档案较新，则保留新档案不会覆盖；
-l ：复制链接文件的属性，而非链接的目标源文件内容；
-p ：复制时，连同属性 (permission) 也保存不变！
-g ：保存源文件的拥有群组；
-o ：保存源文件的拥有人；
-D ：保存源文件的装置属性 (device)
-t ：保存源文件的时间参数；
-I ：忽略更新时间 (mtime) 的属性，档案比对上会比较快速；
-z ：在数据传输时，加上压缩的参数！
-e ：使用的信道协议，例如使用 ssh 通道，则 -e ssh
-a ：相当于 -rlptgoD ，所以这个 -a 是最常用的参数了！
更多说明请参考 man rsync 的解说！</span>

<span class="term_hd"># 1. 将 /etc 的数据备份到 /tmp 底下：</span>
[root@www ~]# <span class="term_command">rsync -av /etc /tmp</span>
<span class="term_say">....(前面省略)....</span>
<u>sent 21979554 bytes  received 25934 bytes</u>  4000997.82 bytes/sec
total size is 21877999  speedup is 0.99
[root@www ~]# <span class="term_command">ll -d /tmp/etc /etc</span>
drwxr-xr-x. 106 root root 12288 Jul 26 16:10 /etc
drwxr-xr-x. 106 root root 12288 Jul 26 16:10 /tmp/etc <span class="term_note">&lt;==瞧！两个目录一样！</span>
<span class="term_say"># 第一次运作时会花比较久的时间，因为首次建立嘛！如果再次备份呢？</span>

[root@www ~]# <span class="term_command">rsync -av /etc /tmp</span>
<u>sent 55716 bytes  received 240 bytes</u>  111912.00 bytes/sec
total size is 21877999  speedup is 390.99
<span class="term_say"># 比较一下两次 rsync 的传输与接受数据量，你就会发现立刻就跑完了！
# 传输的数据也很少！因为再次比对，仅有差异的档案会被复制。</span>

<span class="term_hd"># 2. 利用 student 的身份登入 clientlinux.centos.vbird 将家目录复制到本机 /tmp</span>
[root@www ~]# <span class="term_command">rsync -av -e ssh student@192.168.100.10:~ /tmp </span>
student@192.168.100.10's password:  <span class="term_note">&lt;==输入对方主机的 student 密码</span>
receiving file list ... done
student/
student/.bash_logout
<span class="term_say">....(中间省略)....</span>
sent 110 bytes  received 697 bytes  124.15 bytes/sec
total size is 333  speedup is 0.41

[root@www ~]# <span class="term_command">ll -d /tmp/student</span>
drwx------. 4 student student 4096 Jul 26 16:52 /tmp/student
<span class="term_say"># 瞧！这样就做好备份啦！很简单吧！</span>
</pre></td></tr></tbody></table>

		<p>你可以利用上面的范例二来做为备份 script 的参考！不过要注意的是，因为 rsync 是透过 ssh 
		来传输数据的，所以你可以针对 student 这个家伙制作出免用密码登入的 ssh 密钥！
		如此一来往后异地备援系统就能够自动的以 crontab 来进行备份了！简单到爆！</p>

		<p>免密码的 ssh 账号我们在上头已经讲过了，撰写 shell script 的能力也是必须要有的！利用 rsync 
		来进行你的备份工作吧！ ^_^！至于更多的 rsync 用法可以参考本章后面所列出的参考网站(<a href="#ps10">注10</a>)喔！</p>

<table width="90%" border="1" cellpadding="5" cellspacing="0"><tbody><tr><td>
例题：<div class="block2">
在 clientlinux.centos.vbird (192.168.100.10) 上面，使用 vbirdtsai 的身份建立一只脚本，这只脚本可以在每天的 2:00am
主动的以 rsync 配合 ssh 取得 www.centos.vbird (192.168.100.254) 的 /etc, /root, /home 三个目录的镜像到 clientlinux.centos.vbird
的 /backups/ 底下。
</div>
答：<div class="block2">
由于必须要透过 ssh 通道，且必须要使用 crontab 例行工作排程，因此肯定要使用密钥系统的免密码账号。我们在 11.2.6 小节已经谈过相关作法，
vbirdtsai 已经有了公钥与私钥档案，因此不要再使用 ssh-keygen 了，直接将公钥档案复制到 www.centos.vbird 的 /root/.ssh/ 底下即可。
实际作法可以是这样的：

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 在 clientlinux.centos.vbird 将公钥档复制给 www.centos.vbird 的 root</span>
[vbirdtsia@clientlinux ~]$ <span class="term_command">scp ~/.ssh/id_rsa.pub root@192.168.100.254:~</span>

<span class="term_hd"># 2. 在 www.centos.vbird 上面用 root 建置好 authorized_keys</span>
[root@www ~]# <span class="term_command">ls -ld id_rsa.pub .ssh</span>
-rw-r--r--. 1 root root  416 Jul 26 16:59 id_rsa.pub <span class="term_note">&lt;==有公钥档</span>
drwx------. 2 root root 4096 Jul 25 11:44 .ssh       <span class="term_note">&lt;==有 ssh 的相关目录</span>

[root@www ~]# <span class="term_command">cat id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span>
[root@www ~]# <span class="term_command">chmod 644 ~/.ssh/authorized_keys</span>

<span class="term_hd"># 3. 在 clientlinux.centos.vbird 上面撰写 script 并测试执行：</span>
[vbirdtsai@clientlinux ~]$ <span class="term_command">mkdir ~/bin ; vim ~/bin/backup_www.sh</span>
#!/bin/bash
localdir=/backups
remotedir="/etc /root /home"
remoteip="192.168.100.254"

[ -d ${localdir} ] || mkdir ${localdir}
for dir in ${remotedir}
do
        rsync -av -e ssh root@${remoteip}:${dir} ${localdir}
done

[vbirdtsai@clientlinux ~]$ <span class="term_command">chmod 755 ~/bin/backup_www.sh</span>
[vbirdtsai@clientlinux ~]$ <span class="term_command">~/bin/backup_www.sh</span>
<span class="term_say"># 上面在测试啦！第一次测试可能会失败，因为鸟哥忘记 /backups 需要 root
# 的权限才能够建立。所以，请您再以 root 的身份去 mkdir 及 setfacl 吧！</span>

<span class="term_hd"># 4. 建立 crontab 工作</span>
[vbirdtsai@clientlinux ~]$ <span class="term_command">crontab -e</span>
0 2 * * * /home/vbirdtsai/bin/backup_www.sh
</pre></td></tr></tbody></table>
</div>
</td></tr></tbody></table><br>

	</div>

	<hr><a name="ssh_enc"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">11.6.3 透过 ssh 通道加密原本无加密的服务</span><br>
	<div class="block2">
		<p>现在我们知道 ssh 这个通道可以加密，而且，我们更知道 rsync 默认已经可以透过 ssh 通道来进行加密以进行镜像传输。
		既然如此，那么其他的服务能不能透过这个 ssh 进行数据加密来传送信息呢？当然可以！很棒呢这个功能！
		要介绍实做之前，我们先用图示来谈一下作法。</p>

		<p>假设服务器上面有启动了 VNC 服务在 port 5901 ，客户端则使用 vncviewer 要联机到服务器上的 port 5901 就是了。
		那现在我们在客户端计算机上面启动一个 5911 的埠口，然后再透过本地端的 ssh 联机到服务器的 sshd 去，而服务器的 sshd
		再去连接服务器的 VNC port 5901 。整个联机的图示如下所示：</p>

		<center><img src="0310telnetssh_files/ssh_vnc.gif" alt="透过本地端的 ssh 加密联机到远程的服务器示意图" title="透过本地端的 ssh 加密联机到远程的服务器示意图" border="0"><br>
		图 11.6-1、透过本地端的 ssh 加密联机到远程的服务器示意图<br></center>

		<p>假设你已经透过上述各个小节建立好服务器 (www.centos.vbird) 上面的 VNC port 5901 ，而客户端则没有启动任何的 VNC 埠口。
		那么你该如何透过 ssh 来进行加密呢？很简单，你可以在客户端计算机 (clientlinux.centos.vbird) 执行底下的指令：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@clientlinux ~]# <span class="term_command">ssh -L 本地埠口:127.0.0.1:远程端口 [-N] 远程主机</span>
<span class="term_say">选项与参数：
-N ：仅启动联机通道，不登入远程 sshd 服务器
本地埠口：就是开启 127.0.0.1 上面一个监听的埠口
远程埠口：指定联机到后面远程主机的 sshd 后，sshd 该连到哪个埠口进行传输</span>

<span class="term_hd"># 1. 在客户端启动所需要的端口进行的指令</span>
[root@clientlinux ~]# <span class="term_command">ssh -L 5911:127.0.0.1:5901 -N 192.168.100.254</span>
root@192.168.100.254's password:
<span class="term_white"> </span>  <span class="term_note">&lt;==登入远程仅是开启一个监听埠口，所以停止不能动作</span>

<span class="term_hd"># 2. 在客户端在另一个终端机测试看看，这个动作不需要作，只是查阅而已</span>
[root@clientlinux ~]# <span class="term_command">netstat -tnlp| grep ssh</span>
tcp  0   0 0.0.0.0:22           0.0.0.0:*            LISTEN      1330/sshd
tcp  0   0 127.0.0.1:<span class="term_write">5911</span>       0.0.0.0:*            LISTEN      <span class="term_write">3347/ssh</span>
tcp  0   0 :::22                :::*                 LISTEN      1330/sshd
[root@clientlinux ~]# <span class="term_command">netstat -tnap| grep ssh</span>
tcp  0   0 192.168.100.10:55490 192.168.100.254:22   ESTABLISHED <span class="term_write">3347/ssh</span>
<span class="term_say"># 在客户端启动 5911 的埠口是 ssh 启动的，同一个 PID 也联机到远程喔！</span>
</pre></td></tr></tbody></table>

		<p>接下来你就可以在客户端 (192.168.100.10, clientlinux.centos.vbird) 使用『 vncviewer localhost:5911 』来联机，
		但是该联机却会连到 www.centos.vbird (192.168.100.254) 那部主机的 port 5901 喔！不相信吗？
		当你达成 VNC 联机后，到 www.centos.vbird 那部主机上面瞧瞧就知道了：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 3. 在服务器端测试看看，这个动作不需要作，只是查阅而已</span>
[root@www ~]# <span class="term_command">netstat -tnp | grep ssh</span>
tcp   0  0 127.0.0.1:59442     127.0.0.1:5901        ESTABLISHED 7623/sshd: root
tcp   0  0 192.168.100.254:22  192.168.100.10:55490  ESTABLISHED 7623/sshd: root
<span class="term_say"># 明显的看到 port 22 的程序同时联机到 port 5901 喔！</span>
</pre></td></tr></tbody></table>

		<p>那如何取消这个联机呢？先关闭  VNC 之后，然后再将 clientlinux.centos.vbird 的第一个动作 (ssh -L ...)
		按下 [ctrl]-c 就中断这个加密通道啰！这样会使用了吗？你可以将这个动作用在任何服务上喔！</p>
	</div>

	<hr><a name="ssh_xserver"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">11.6.4 以 ssh 信道配合 X server 传递图形接口</span><br>
	<div class="block2">
		<p>从前一个小节我们知道 ssh 可以进行程序的加密传递，亦即 ssh 通道啦！那么可不可以用在 X 上面呢？
		意思是说，那我能不能不要启动甚么很复杂的接口，就是在原有的接口底下使用 ssh 信道，将我所需要的服务器上面的图形接口传过来就好了？
		是可以的喔！鸟哥用一个 Windows 上面的 Xming X server 作范例好了。整个动作是这样的：</p>

		<ul>
		<li>先在 Windows 上面启动 XLaunch，并设定好联机到 www.centos.vbird 的相关信息；</li>
		<li>启动 Xming 程序，会取得一个 xterm 程序，该程序是 www.centos.vbird 的程序；</li>
		<li>开始在 xterm 上面执行 X 软件，就会在 Windows 桌面上面显示啰！</li>
		</ul>

		<p>那我们就开始来处理一下 Xming 这个程序吧！启动 XLaunch 之后出现下图模样：</p>

		<center><img src="0310telnetssh_files/centos6_xming_ssh_1.gif" alt="启动 XLaunch 程序-选择显示模式" title="启动 XLaunch 程序-选择显示模式" border="1"><br>
		图 11.6-2、启动 XLaunch 程序-选择显示模式<br></center>

		<p>记得上图中要选择 Multiple windows 会比较漂亮喔！然后按下『下一步』会出现下图：</p>

		<center><img src="0310telnetssh_files/centos6_xming_ssh_2.gif" alt="设定 XLaunch 程序-选择联机方式" title="设定 XLaunch 程序-选择联机方式" border="1"><br>
		图 11.6-3、设定 XLaunch 程序-选择联机方式<br></center>

		<p>我们要启动一只程序，并且是开放在 ssh/putty 之类的软件帮忙进行 ssh 信道的建立喔！然后下一步吧。</p>

		<center><img src="0310telnetssh_files/centos6_xming_ssh_3.gif" alt="设定 XLaunch 程序-设定远程联机的相关参数" title="设定 XLaunch 程序-设定远程联机的相关参数" border="1"><br>
		图 11.6-4、设定 XLaunch 程序-设定远程联机的相关参数<br></center>

		<p>Xming 会主动的启动一个 putty 的程序帮你连进 sshd 服务器，所以这里得要帮忙设定好账号密码的相关信息。
		鸟哥这里假设你的 sshd 尚未取消 root 登入，因此这里使用 root 的权限喔！</p>

		<center><img src="0310telnetssh_files/centos6_xming_ssh_4.gif" alt="设定 XLaunch 程序-是否支持复制贴上功能" title="设定 XLaunch 程序-是否支持复制贴上功能" border="1"><br>
		图 11.6-5、设定 XLaunch 程序-是否支持复制贴上功能<br></center>

		<p>使用默认值吧！直接下一步。</p>

		<center><img src="0310telnetssh_files/centos6_xming_ssh_5.gif" alt="设定 XLaunch 程序-完成设定" title="设定 XLaunch 程序-完成设定" border="1"><br>
		图 11.6-6、设定 XLaunch 程序-完成设定<br></center>

		<p>很简单！这样就完成设定了！请按下完成，你就会看到 Windows 的桌面竟然出现如下的图示了！</p>

		<center><img src="0310telnetssh_files/centos6_xming_ssh_6.gif" alt="Windows 桌面出现的 X client 程序" title="Windows 桌面出现的 X client 程序" width="600" border="1"><br>
		图 11.6-7、Windows 桌面出现的 X client 程序<br></center>

		<p>上面这只程序就是 xterm 这个 X 的终端机程序。你可以在上面输入指令，该指令会传送到 Linux server ，
		然后再将你要执行的图形数据透过 ssh 信道传送到目前的 Windows 上面的 Xming ，你的 Linux
		完全不用启动 VNC, X, xrdp 等服务！只要有 sshd 就搞定了！就是这么简单！例如鸟哥输入几个游戏程序，
		你的 Windows 窗口 (看任务栏就知道了) 就会出现这样的情况：</p>

		<div style="padding: 10pt 0pt 10pt 0pt ;" align="right"><table width="90%"><tbody><tr><td><b>Tips:</b><br><span style="color : #009000"><font size="-1">		事实上，我们的 basic server 安装方式并没有帮你安装 xterm 喔！所以，你得要自己安装 xterm 才行！
		yum install xterm 就安装好啦！然后上面的动作再重来一次，就可以成功啰！而底下的图标里面的相关软件，
		也是需要你自己安装的呦！ ^_^
		</font></span></td><td><img src="0310telnetssh_files/vbird_face.gif" alt="鸟哥的图示" title="鸟哥的图示"></td></tr></tbody></table></div>
		<center><img src="0310telnetssh_files/centos6_xming_ssh_7.gif" alt="Windows 桌面出现的 X client 程序" title="Windows 桌面出现的 X client 程序" width="580" border="1"><br>
		图 11.6-8、Windows 桌面出现的 X client 程序<br></center>
	</div>
</div>
<hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
</tbody></table>

<div style="padding-top: 0px; text-align: center;">
<span style="font-size: 80%;">
	<a href="http://linux.vbird.org/" target="_top" title="前往鸟哥的首页">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="联络鸟哥(我不要广告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
         ﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></div>
</div>
</center>
</body></html>
