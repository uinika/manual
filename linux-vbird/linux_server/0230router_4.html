<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-TW" lang="zh-TW"><head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf8">
	<meta name="Author" content="VBird, 鸟哥">
	<meta name="Description" content="使用 Routing 的功能，让 Linux Server 也可以当作 Router 来使用！此外，亦提到 IP aliases 这个好用的功能呢！">
	<title>鸟哥的 Linux 私房菜 -- 架设 Router</title>
    <script src="../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../script/index.js" type="text/javascript"></script>
	<link href="../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    </head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html')">

<center>
<div id="apDiv5">
<div> <LINK REL="SHORTCUT ICON" HREF="../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../linux_basic/0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="../linux_basic/Mandrake9.0/mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="../linux_basic/fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="../linux_basic/linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<table summary="本文内容的排版" style="width: 898px;" border="0" cellpadding="0" cellspacing="0">
<tbody><tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
<tr><td style="width: 16px; font-size: 6px;">　</td>
    <td width="866">

<!-- 本文的档头部分 -->
<div style="text-align:center">
    <a href="http://linux.vbird.org/linux_server/0230router.php">
    <span class="text_head0">第八章、路由观念与路由器设定</span></a><br>
</div>
    <div style="text-align:right">
        <span class="text_history">最近更新日期：2011/07/22</span>
    </div>
<!-- 本文的连结区部分 -->
<div class="block1">
<span class="text_h1">
8.4 <a href="#arp_proxy">特殊状况：路由器两边界面是同一个 IP 网段：ARP Proxy</a><br>
</span></div>
<!-- 本文的正式部分 -->
<hr><a name="arp_proxy"></a><img src="../image/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">8.4 特殊状况：路由器两边界面是同一个 IP 网段：
ARP Proxy</span><br>
<div class="block1">
	<p>如果你一开始设计的网络环境就是同一个 Class C 的网域，例如 192.168.1.0/24 ，
	后来因为某些因素必须要将某些主机搬到比较内部的环境中，例如<a href="#fig8.2-1">图 8.2-1</a>的 clientlinxu, winxp, win7。
	然后又因为某些因素，所以你不能变更这些计算机的 IP，此时你的同一网域就会横跨在一个路由器的左右两边了！
	举例来说，联机图示有点像底下这样：</p>

	<a name="fig8.4-1"></a>
	<center><img src="0230router_files/centos6_arp_proxy.gif" alt="在路由器两个界面两边的 IP 是在同一个网域的设定情况" title="在路由器两个接口两边的 IP 是在同一个网域的设定情况" border="0"><br>
	图 8.4-1、在路由器两个界面两边的 IP 是在同一个网域的设定情况<br></center>

	<p>初次见面～看到眼睛快要掉下来哩！怎么路由器的两边的主机 IP 设定都在同一个网域内？而且还被规定不能够更改原先的 IP 设定，
	...真是一个头两个大啊～如此一来，在 Linux Router 两边要如何制作路由啊？好问题！真是好问题～
	因为 <span class="text_import2">OSI 第三层网络层的路由是一条一条去设定比对的，所以如果两块网卡上面都是同一个网域的 IP 时，
	就会发生错误</span>。那如何处理啊？</p>

	<p>我们先从两方面来说，第一个，当从正确的网段 (PC1) 要联机到 PC2~PC4 时，他应该是要透过 Linux Router 
	那部主机的对外 IP (192.168.1.100) 才行！而且 Linux Router 还必须要让该封包透过内部 IP (192.168.1.200) 联机到 PC2~PC4 。
	此时，封包传递的图示有点像这样：</p>

	<a name="fig8.4-2"></a>
	<center><img src="0230router_files/arp_proxy_in.gif" alt="正常的网段想要传送到内部计算机去的封包流向" title="正常的网段想要传送到内部计算机去的封包流向" border="0"><br>
	图 8.4-2、正常的网段想要传送到内部计算机去的封包流向<br></center>

	<p>在这个阶段，我们可以设定<span class="text_import2">PC2~PC4 的 IP 所对应的网卡卡号 (MAC) 都设定在 router 的对外网卡上，
	因此， router 的对外接口可以将给 PC2~PC4 的封包给『骗』过来</span>。接下来，就简单的透过路由设定，让封包转个接口发送出去即可。
	这样 PC1 --&gt; PC2 的问题解决了，但是 PC2 怎么传送到 PC1 呢？我们可以透过底下的图示来想象一下：</p>

	<a name="fig8.4-3"></a>
	<center><img src="0230router_files/arp_proxy_out.gif" alt="内部计算机想要传送到正常网域时的封包流向" title="内部计算机想要传送到正常网域时的封包流向" border="0"><br>
	图 8.4-3、内部计算机想要传送到正常网域时的封包流向<br></center>

	<p>当 PC2 要传送的封包是给 PC3, PC4 的，那么这个封包得要能够直接传递。但是如果需要传送到正常网域的封包，就得要透过 router
	的对内网卡，再透过路由规则来将该封包导向外部接口来传递才行！这个时候就变成内部的接口欺骗 PC2 说， PC1 与 Router A 
	的 IP 是在内部这张接口上就是了，然后再透过路由判断将该封包透过外部接口来对外传递出去即可。
	假设 Linux router 的对外界面为 eth0 而对内为 eth1 时，我们可以这样说：</p>

	<ol class="text_import2">
	<li>当 Linux Router 的 eth0 那个网域主机想要连接到 PC2~PC4 的主机时，由 Linux Router 负责接收；</li>
	<li>当 Linux Router 要传送数据到 PC2~PC4 时，务必要由 eth1 来传送；</li>
	<li>当内部计算机想要连接到 PC1 或 Router A 时，由 Linux router 的 eth1 负责接收；</li>
	<li>当 Linux Router 要传送的数据为 192.168.1.0/24 ，但并非 PC2~PC4 时，需由 eth0 传送。</li>
	</ol>

	<p>上列的步骤与图示内的线条上的顺序相符合呦！得要对照着看看。其中的 (1) 与 (3) 就是透过 ARP Proxy (代理) 的功能啦！
	那啥是 ARP Proxy 呢？简单的说，就是让我的某张适配卡的 MAC 代理其他主机的 IP 对应，让想要连接到这个 IP 的 MAC 
	封包由我帮他接下来的意思。举我们图 8.4-1 的例子来说，就是<span class="text_import2">在 Linux Router 的 eth0 
	界面上，规定 192.168.1.10, 192.168.1.20, 192.168.1.30 这三个 IP 都对应到 eth0 的 MAC 上，所以三个 IP 的封包就会由 eth0 
	代为收下</span>，因此才叫做 ARP 代理人嘛！所以啦，每一部在 eth0 那端的主机都会『误判』那三个 IP 是 Linux Router 
	所拥有，这样就能够让封包传给 Linux Router 啦！</p>

	<p>再接下来，咱们的 Linux Router 必须要额外指定路由，设定情况为：</p>

	<ul class="text_import2">
	<li>若目标是 PC2 ~ PC4 时，该路由必须要由内部的 eth1 发送出去才行，</li>
	<li>若目标不为 PC2 ~ PC4 ，且目标在 192.168.1.0/24 的网域时，需由 eth0 发送出去才行。</li></ul>

	<p>也就是说，你必须要指定路由规则当中，那个 PC2~PC4 具有优先选择权，然后其他的同网域封包才由 eth0 来传送。
	这样就能够达成我们所想要的结局啦！^_^！看样子似乎很难，其实设定方面还挺简单的，你可以透过 arp  
	以及 route 这两个指令来达成喔！</p>

	<ul style="font-family: '细明体'">
		<li>外部接口 eth0：08:00:27:71:85:BD</li>
		<li>内部接口 eth1：08:00:27:2A:30:14</li>
	</ul>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先设定外部 eth0 的 ARP Proxy，让三个 IP 对应到自己的 MAC</span>
[root@www ~]# <span class="term_command">arp -i eth0 -s 192.168.1.10 08:00:27:71:85:BD pub</span>
[root@www ~]# <span class="term_command">arp -i eth0 -s 192.168.1.20 08:00:27:71:85:BD pub</span>
[root@www ~]# <span class="term_command">arp -i eth0 -s 192.168.1.30 08:00:27:71:85:BD pub</span>
[root@www ~]# <span class="term_command">arp -n</span>
Address             HWtype  HWaddress      Flags Mask       Iface
192.168.1.30        *       *              MP               eth0
192.168.1.10        *       *              MP               eth0
192.168.1.20        *       *              MP               eth0
<span class="term_say"># 首先需要让外部接口拥有三个 IP 的操控权，透过这三个指令来建立 ARP 对应！</span>

<span class="term_hd"># 2. 开始处理路由，增加 PC2~PC4 的单机路由经过内部的 eth1 来传递</span>
[root@www ~]# <span class="term_command">route add -host 192.168.1.10 eth1</span>
[root@www ~]# <span class="term_command">route add -host 192.168.1.20 eth1</span>
[root@www ~]# <span class="term_command">route add -host 192.168.1.30 eth1</span>
[root@www ~]# <span class="term_command">route -n</span>
Kernel IP routing table
Destination    Gateway        Genmask         Flags Metric Ref    Use Iface
192.168.1.20   0.0.0.0        255.255.255.255 UH    0      0        0 eth1
192.168.1.10   0.0.0.0        255.255.255.255 UH    0      0        0 eth1
192.168.1.30   0.0.0.0        255.255.255.255 UH    0      0        0 eth1
<u>192.168.1.0    0.0.0.0        255.255.255.0   U     0      0        0 eth0</u>
<u>192.168.1.0    0.0.0.0        255.255.255.0   U     0      0        0 eth1</u>
0.0.0.0        192.168.1.254  0.0.0.0         UG    0      0        0 eth0
<span class="term_say"># 这样就处理好单向的单机路由啰！不过有个问题啊！那就是 192.168.1.0/24
# 的网域，两个接口都可以传送！因此，等一下第四个步骤得要将 eth1 删除才行！</span>

<span class="term_hd">3. 设定一下内部的 ARP Proxy 工作 (绑在 eth1 上头啰)！</span>
[root@www ~]# <span class="term_command">arp -i eth1 -s 192.168.1.101 08:00:27:2A:30:14 pub</span>
[root@www ~]# <span class="term_command">arp -i eth1 -s 192.168.1.254 08:00:27:2A:30:14 pub</span>
<span class="term_say"># 这样可以骗过 PC2 ~ PC4 ，让这三部主机传递的封包可以透过 router 来传递！</span>

<span class="term_hd">4. 开始清除掉 eth1 的 192.168.1.0/24 路由</span>
[root@www ~]# <span class="term_command">route del -net 192.168.1.0 netmask 255.255.255.0 eth1</span>
</pre></td></tr></tbody></table>

		<p>所有的计算机都在同一个网域内，因此 default gatway 都是 192.168.1.254 ，而 netmask  都是 255.255.255.0，
		只有 IP 不一样而已。最后，所有的计算机都可以直接跟对方联机，也能够顺利的连上 Internet ！
		这样的设定就能够满足上述的功能需求啰！如果一切都没有问题，那么将上述的指令写成一个脚本档，
		例如 /root/bin/network.sh ，然后将该档案设定为可执行，并将它写入 /etc/rc.d/rc.local ，
		同时每次重新启动网络后，就得要重新执行一次该脚本，即可达到你的需求啰！</p>

		<p>透过这个案例你也可以清楚的知道，<span class="text_import2">能不能联机其实与路由的关系才大哩！
		而路由是双向的，你必须要考虑到这个封包如何回来的问题喔！</span></p>
</div><hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
</tbody></table>

<div style="padding-top: 0px; text-align: center;">
<span style="font-size: 80%;">
	<a href="http://linux.vbird.org/" target="_top" title="前往鸟哥的首页">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="联络鸟哥(我不要广告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
         ﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></div>
</div>
</center>
</body></html>
