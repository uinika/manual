<!DOCTYPE HTML PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html><head>


   <meta http-equiv="Content-Type" content="text/html; charset=utf8">
   <meta name="Author" content="VBird">
   <meta name="Description" content="包括了 crontab 与 at 这两支程序啦！">
   <title>鸟哥的 Linux 私房菜 -- 例行性命令的建立</title>
   	<script src="../../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../../script/index.js" type="text/javascript"></script>
	<link href="../../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../../css/main.css" rel="stylesheet" type="text/css" />

</head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../../index-2.html','../../index-2.html','../../index-2.html','../../index-2.html','../../index-2.html','../../index-2.html','../../index-2.html','../../index-2.html')">
<center>
<div id="apDiv5" align="left">
<div> <LINK REL="SHORTCUT ICON" HREF="../../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="../../linux_server/0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="../linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="../fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="../linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="../../linux_server/index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="../../linux_server/linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="../../linux_server/centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="../../linux_server/index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<div align="center"><font color="#3333ff"><font size="+2"><a href="http://linux.vbird.org/linux_basic/0430cron/0430cron.php" target="_self"><font face="Times New Roman,Times">Linux
</font><font face="标楷体">例行性命令的建立</font></a></font></font><br>
本文已不再维护，新文章请参考 <a href="http://linux.vbird.org/linux_basic/0430cron.php">这里</a>
</div>

<div align="right"><font face="新细明体"><font color="#3333ff"><font size="-1">最近更新日期：2002/05/30</font></font></font></div>
<font color="#000099"><font size="+1"><a href="#Whatiscron">什么是例行性命令</a>？</font></font>
<br><font color="#000099"><font size="+1"><a href="#linuxcron">Linux 系统的例行性命令有哪些</a>？</font></font>
<br><font color="#000099"><font size="+1"><a href="#at">仅执行一次的工作排程</a>：
at</font></font>
<br><font color="#000099"><font size="+1"><a href="#crontab">循环执行的例行性命令</a>：
crontab</font></font>
<br><font color="#000099"><font size="+1"><a href="#etc-crontab">系统的 crontab
设定</a>： /etc/crontab</font></font>
<br><font color="#000099"><font size="+1"><a href="#safe">安全的防护</a>：
/var/log/cron 记录文件</font></font>
<br><font color="#000099"><font size="+1"><a href="#FAQ">本章习题练习</a></font></font>
<br>
<hr width="100%"><a name="Whatiscron"></a><font color="#000099"><font size="+1">什么是例行性命令？</font></font>
<blockquote>每个人或多或少都有一些约会或者是工作，有的工作是例行性的，例如每年一次的加薪、每个月一次的工作报告、每周一次的午餐会报、
每天需要的打卡等等；有的工作则是临时发生的，例如刚好总公司有高官来访，需要你准备演讲器材等等！用在生活上面，例如每年的爱人的生日、每天的起床时间
等等、还有突发性的计算机大降价（阿～我等好久了～～）等等啰。这些工作都可以称为例行性命令，而这些工作
Linux 也都可以帮您提醒，例如：每一天早上 8:00 钟要服务器连接上音响，并启动音乐来唤你起床；而中午
12:00 希望 Linux 
可以发一封信到你的邮件信箱，提醒你可以去吃午餐了；另外，在每年的你爱人的生日的前一天，先发封信提醒你，以免忘记这么重要的一天。</blockquote>

<blockquote>从上面的说明当中可以很清楚的发现两种工作排程的方式：
<ul>
<li>
一种是例行性的，就是每隔一定的周期要来办的事项；</li>

<li>
一种是突发性的，就是这次做完以后就没有的那一种（计算机大降价....）</li>
</ul>
那么在 Linux 底下如何达到这两个功能呢？呵呵！那就得使用 at 与 crontab 这两个好东西啰！
<ul>
<li>
<b><font color="#000099">at</font></b> ： 这个工作仅执行一次就从 Linux
系统中的排程中取消；</li>

<li>
<b><font color="#000099">crontab</font></b> ： 这个工作将持续例行性的作下去！</li>
</ul>
底下我们先来谈一谈 Linux 的系统到底在做什么事情，怎么有若干多的工作排程在工作呢？然后再回来谈一谈
at 与 crontab 这两个好东西！</blockquote>

<hr width="100%"><a name="linuxcron"></a><font color="#000099"><font size="+1">Linux
系统的例行性命令有哪些</font></font>
<blockquote>好了，那么服务器自己有什么例行性命令要来作呀！？Linux 的工作可多着呢！由前面提到的几篇文章中，我们知道Linux
本身在背景下的工作可是很多的，尤其是网络开放的情况下，建立与取消联机、MySQL
数据库的实时更新、以及一些例行的系统指令，例如释放内存的工作等等。由于例行的工作非常的多，实在不可能每天都要管理员来手动输入吧！所以才会建立这个工作排程的需求的！基本预设的工作有底下这些：
<ul>
<li>
<b>进行数据轮替 ( log rotate )</b>：这个步骤重要了！尤其是在 log file 的选项当中！由于登录档案会越来越大，所以需要适时适量的将登录档备份，并以新开的档案来进行记录，这样效率会比较好，因此就需要使用
log rotate 啦！系统默认的重要工作之一；</li>
</ul>

<ul>
<li>
<b>rpm 数据库的建立</b>：虽然 RPM 数据库会在你以 RPM 安装之后即更新到 RPM
数据库当中去，但是难保会有漏网之鱼，所以系统也会设定每隔依段时间自动的搜集系统上面的
RPM
数据库来建置一番；</li>
</ul>

<ul>
<li>
<b>建立 locate 的数据库</b>：是否还记得为何使用 <a href="http://linux.vbird.org/linux_basic/0430cron/0220filemanager.php#locate">locate</a>
这个指令时，搜寻速度超快！那是因为 Linux 系统上将档案与路径都记录在数据库里面了！所以使用
locate 的时候，嘿嘿！直接指向数据库去 ( <font face="细明体"><font color="#3333ff">/var/lib/slocate/slocate.db</font></font>
) ，偏偏麻烦的是这个档案的更新是每天一次！所以当你今天更新的档案，使用
locate 反而可能会找不到....</li>
</ul>

<ul>
<li>
<b>进行程序的分析</b>：每隔依段时间会进行程序的分析，如果发现有僵尸程序的时候，就会将他删去！以保持内存的工作能力！</li>
</ul>

<ul>
<li>
<b>登录档视察</b>：这个东西是在 Red Hat 7.1 以后才出现的东西，后来太好用了，所以被拿到旧版的
Red Hat 里面去使用！基本上就是分析登录档啦！然后据以解析有问题的纪录文件，以维护主机的安全性！这部份不才小弟也自己写了一个简易型的分析档案，觉得更好用就是了！</li>
</ul>

<ul>
<li>
<b>指纹数据库的比对</b>：基本上就是 tripwire 这个套件啦！可以用来分析最近被更动过的档案内容！蛮不错的一个程序！有空也来玩玩看。</li>
</ul>
Linux 预设的例行工作至少就有这些了，再加上您努力的为 Linux 进行工作排程的设计，嘿嘿！每天的工作量可是相当的大的呢！</blockquote>

<hr width="100%"><a name="at"></a><font color="#000099"><font size="+1">仅执行一次的工作排程</font></font>
<blockquote>如果仅要执行一次的工作，就使用 at 这个指令吧！这个指令其实就是
atd 这个服务啦！所以请记得一定要启动这个服务呦！如果是在 Red Hat 系统下，可以使用：
<ol>
<li>
<font face="细明体"><font color="#000066">ntsysv</font></font></li>

<li>
<font face="细明体"><font color="#000066">选择 atd</font></font></li>

<li>
<font face="细明体"><font color="#000066">按下 OK ！</font></font></li>
</ol>
如果是在 Mandrake 系统下，可以使用：
<ol>
<li>
<font color="#000066">chkconfig --add atd</font></li>

<li>
<font color="#000066">chkconfig --list</font></li>

<br><font color="#000066">上面这个指令可以查看 atd 在 run-level 正确的情况中，是否会在开机的时候被启动！</font></ol>
基本上， atd 是预设开启的，如果您没有更动过系统默认值的话，那么上面的动作就不需要动啰！下达
at 这个动作会将工作排程写入<font face="细明体"><font color="#3333ff"> /var/spool/at</font></font>
这个目录下呢！然后等待系统将之执行啰！此外，这个 at 指令虽然默认是所有人都能进行，但是可以经由
root 的规范来限制使用的人口。限制的方法其实与 /etc/hosts.allow(deny) 类似，使用
/etc/at.allow(deny) 这两个档案来限制：
<ul>
<li>
<b>限制用户原理</b>：当用户执行 at 时，系统会</li>

<br>　
<ol>
<li>
先找寻 <b>/etc/at.allow</b> 这个档案，写在这个档案中的使用者才能使用 at
，没有在这个档案中的使用者则不能使用 at ( 即使没有写在 at.deny 当中&nbsp;
)；</li>

<li>
如果没有 /etc/at.allow 就寻找<b> /etc/at.deny</b> 这个档案，若写在这个
at.deny 的使用者则不能使用 at ，而没有在这个 at.deny 档案中的使用者，就可以使用
at 咯；</li>

<li>
如果两个档案都不存在，那么只有 root 可以使用 at 这个指令。</li>
</ol>
</ul>

<ul>
<li>
Linux 预设情况下，只有 <b>/etc/at.deny</b> 这个档案，且这个档案的内容为空白的，由于内容没有任何使用者，所以当然『所有人都可以使用
at 』</li>
</ul>

<ul>
<li>
如果不想要某个使用者使用 at 时，那么将该使用者账号写到 /etc/at.deny 这个档案中即可。</li>
</ul>
好了！我们来谈一谈 at 的语法吧！
<br>&nbsp;
<table width="650" bgcolor="#000000" border="1" cols="1">
<tbody><tr>
<td><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">at [-m] TIME</font><font color="#ffffff">　　　</font><font color="#ff9900">　(下达工作指令)</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">atq</font><font color="#ffffff">　　　　　　　　</font><font color="#ff9900">
(查看目前的工作排程)</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">atrm [jobnumber]</font><font color="#ffffff">　　</font><font color="#ff9900">(删除排程)</font></font></font>
<br><font face="细明体"><font color="#ffffcc"><font size="-1">参数说明：</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">-m&nbsp;&nbsp;&nbsp;
：执行 at 所规范的工作排程时，将屏幕输出结果 mail 给下达指令的用户</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">TIME&nbsp;
：时间的格式，有底下几个：</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">　　　HH:MM
YYYY-MM-DD　　　　　　　　　　　 　ex&gt; 04:00 2002-05-30 (五月三十号四点执行)</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">　　　HH[pm;am]
+ number [hours;days;weeks]　　ex&gt; 4pm + 3 days (在过 3 天的下午 4 点)</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">　　　HH:MM　　　　　　　　　　　　　　　　　　ex&gt;
12:00 (今天的 12 点执行)</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">　　　HH[pm;am]
[Month] [Day]　　　　　　　　　ex&gt; 1pm May 30</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">jobnumber：每一个
at 工作排程都有编排的顺序！这个即是！</font></font></font>
<br><font face="细明体"><font color="#ffffcc"><font size="-1">范例：</font></font></font>
<p><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">at 5pm&nbsp;&nbsp; </font><font color="#ff9900">&lt;==在今天的
5pm 执行，如果今天已过 5 点则明天执行；</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">warning: commands
will be executed using (in order) a) $SHELL b) login shell c) /bin/sh</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">at&gt; </font><font color="#ffff00">mail
-s test test &lt; /home/test/.bashrc </font><font color="#ff9900">&lt;==这就是我的工作！</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">at&gt; &lt;EOT&gt;
</font><font color="#ff9900">&lt;==这里是按下
[Ctrl] + D 就可以离开了！</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">job 8 at 2002-05-30
17:00&nbsp;</font><font color="#ff9900"> &lt;==这里会告诉你这个工作的号码为
8 号，执行的日期为后面所示。</font></font></font>
</p><p><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">atq&nbsp;</font><font color="#ffffff">&nbsp;</font><font color="#ff9900">
&lt;==窥视一下你(test)目前有多少工作？</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2002-05-30 12:00 a test</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2002-05-30 17:00 a rest</font></font></font>
</p><p><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">atrm 5</font><font color="#ff9900">&lt;==删除第
5 号工作</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">atq</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
2002-05-30 17:00 a rest</font></font></font></p></td>
</tr>
</tbody></table>

<p>请注意！在 at 下达之后，便进入指令列下达的模式！在这里你可以重复的输入指令，但是离开的时候请下达『
[Ctrl] + D 』就可以离开了！离开之后，系统会告诉你这个工作排程的号码与用户是谁！呵呵！很简单吧！</p></blockquote>

<hr width="100%"><a name="crontab"></a><font color="#000099"><font size="+1">循环执行的例行性命令</font></font>
<blockquote>这个循环的例行性命令其实就是 cron 这个服务啦 (crond)！当你下达
crontab 的指令之后，会将你的命令写入<font color="#3333ff"> </font><b><font color="#000099">/var/spool/cron</font></b>这个目录当中呦！例如
test 下达了他的 crontab 命令，那么就会自动产生 /var/spool/cron/test 这个档案！『<font color="#3333ff">但请注意，这个档案不能直接编辑！</font>』然后执行的指令记录会放置在
/var/log/cron 这个档案中！所以，『<font color="#3333ff">如果您的 Linux
系统不知道是否被木马入侵时，可以搜寻一下 /var/log/cron 这个记录挡，视察看看有没有被搞鬼</font>？』</blockquote>

<blockquote>好了！我们来看一下 crontab 的指令语法吧！
<br>&nbsp;
<table width="650" bgcolor="#000000" border="1" cols="1">
<tbody><tr>
<td><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">crontab [-u user] [-l | -e | -r]</font></font></font>
<br><font face="细明体"><font color="#ffffcc"><font size="-1">参数说明：</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">-u user ：只有
root 能下达的参数，视察或编译其他使用者的 crontab 内容</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">-l&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
：列出 crontab 的内容</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">-e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
：编辑 crontab 的内容</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">-r&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
：删除 crontab 的内容</font></font></font>
<br><font face="细明体"><font color="#ffffcc"><font size="-1">范例：</font></font></font>
<br><font face="细明体"><font color="#ffffcc"><font size="-1">一般使用者
test 要在每天的 12:00 发信给自己：</font></font></font>
<p><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">crontab -e</font><font color="#ffffff">
</font><font color="#ff9900">&lt;==自己编辑自己的 crontab 内容</font></font></font>
</p><p><font face="细明体"><font color="#ffffcc"><font size="-1">进入 crontab
编辑内容，使用 vi 呦！</font></font></font>
</p><p><font face="细明体"><font color="#ffff00"><font size="-1">0 12 * * * mail
test &lt; /home/test/test.txt</font></font></font>
<br><font face="细明体"><font color="#ff9900"><font size="-1">分时日月周
|========指令列===============|</font></font></font></p></td>
</tr>
</tbody></table>

<p>上面的例子是说：假如你需要在每天的正午 12:00 发一封信给你自己，而且信的内容已经写好了，那要怎样作呢？而且，另一个假设是，你在
Linux Server 中的权限仅止于一般使用者，并不是 root （管理员）身份，那要怎样设定你的例行性命令呢？哈哈！那就使用
crontab 这个指令吧！你只要执行『 <b>crontab -e </b>』就可以进入 vi 的编辑画面来编辑你的例行性命令说！</p></blockquote>

<blockquote>在上面的例子中，输入 crontab -e 时，会出现一个 <a href="http://linux.vbird.org/linux_basic/0430cron/0310vi.php">vi</a>
画面，然后你在 vi 画面中输入上面的一行字，之后按
<font color="#3333ff">:wq
</font>储存后离开！即可完成编辑！容易吧！那上面那一行字代表什么意义呢？你可以看到，在真正执行命令之前（就是
mail test &lt; /home/test/test.txt ）总共有五个数字，这五个数字分别代表：
<blockquote><font face="细明体"><font color="#000099">分　　（0-59）</font></font>
<br><font face="细明体"><font color="#000099">小时　（0-23）</font></font>
<br><font face="细明体"><font color="#000099">日期　（1-31）</font></font>
<br><font face="细明体"><font color="#000099">月份　（1-12）</font></font>
<br><font face="细明体"><font color="#000099">周　　（0-6）</font></font>
<table width="550" border="1" cols="6">
<tbody><tr>
<td width="120" bgcolor="#ffffcc">
<center>数字代表的意义</center>
</td>

<td width="70">
<center>分钟</center>
</td>

<td width="70">
<center>小时</center>
</td>

<td width="70">
<center>日期</center>
</td>

<td width="70">
<center>月份</center>
</td>

<td width="150">
<center>周</center>
</td>
</tr>

<tr>
<td bgcolor="#ffffcc">
<center>范围</center>
</td>

<td>
<center>0-59</center>
</td>

<td>
<center>0-23</center>
</td>

<td>
<center>1-31</center>
</td>

<td>
<center>1-12</center>
</td>

<td>
<center>0-6 (0为星期天)</center>
</td>
</tr>
</tbody></table>
</blockquote>
另外，如果是『 ＊&nbsp; 』的时候，代表所有数字都适用的意思。所以，你就可以知道我上面那一行写的意义为何了！那就是『<font face="细明体"><font color="#3333ff">不论何月、何日、星期几的
12 点 0 分时，执行 mail test &lt; /home/test/test.txt 这个命令</font></font>』！还不了解？没关系，我们这里作几个例子！
<br>&nbsp;
<table width="650" bgcolor="#000000" border="1" cols="1">
<tbody><tr>
<td><font face="细明体"><font color="#ffffcc"><font size="-1">例题一：假如你的女朋友生日是
5 月 2 日，你想要在 5 月 1 日的 23:59 发一封信给他，</font></font></font>
<br><font face="细明体"><font color="#ffffcc"><font size="-1">　　　　这封信的内容已经写在
/home/test/lover.txt 中了</font></font></font>
<p><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">crontab -e</font></font></font>
</p><p><font face="细明体"><font color="#ffffff"><font size="-1">59 23 1 5 *
mail pigpp &lt; /home/test/lover.txt</font></font></font></p></td>
</tr>
</tbody></table>
那样的话，每年 pigpp 都会收到你的这封信喔！（当然啰，信的内容就要每年变一变啦！）
<br>&nbsp;
<table width="650" bgcolor="#000000" border="1" cols="1">
<tbody><tr>
<td><font face="细明体"><font color="#ffffcc"><font size="-1">例题二：假如你每隔五分钟要去
check 你的一个名为 test.sh 的批处理文件一次，则：</font></font></font>
<p><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]#</font><font color="#ffff00"> crontab -e</font></font></font>
</p><p><font face="细明体"><font size="-1"><font color="#ffffff">59 23 1 5 *
mail pigpp &lt; /home/test/lover.txt&nbsp;</font><font color="#ff9900">
&lt;==刚刚的那个指令还存在呦！</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">*/5 * * * *
/home/test/test.sh&nbsp;</font><font color="#ff9900"> &lt;==新加入的一个排程！</font></font></font></p></td>
</tr>
</tbody></table>
注意到呦！那个 crontab 每个人都只有一个档案，就是在 /var/spool/cron 里面的档案啦！还有两件事要注意一下：
<blockquote>(1) 指令的路径最好是下达<a href="http://linux.vbird.org/linux_basic/0430cron/0220filemanager.php#abslut_relate">绝对路径</a>，这样比较不会找不到执行的档案喔；
<br>(2) 第一个数字 <font color="#3333ff">*/5 </font>表示『每五分钟执行一次』的意思！</blockquote>

<table width="650" bgcolor="#000000" border="1" cols="1">
<tbody><tr>
<td><font face="细明体"><font color="#ffffcc"><font size="-1">例题三：假如你每个礼拜的星期五下午
4:30 要告诉朋友星期六的约会不要忘记，则：</font></font></font>
<p><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">crontab -e</font></font></font>
</p><p><font face="细明体"><font color="#ffffff"><font size="-1">59 23 1 5 *
mail pigpp &lt; /home/test/lover.txt&nbsp;</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">*/5 * * * *
/home/test/test.sh</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">30 16 * * 5
mail frend@test.domain.name &lt; /home/test/frend.txt</font><font color="#ff9900">
&lt;==新加入的！</font></font></font></p></td>
</tr>
</tbody></table>
呵呵！这样很简单吧！如此就可以轻易的达到您所需要的例行性工作排程的安排啰！</blockquote>

<blockquote>好了！那么我们要如何来查看使用者目前的 crontab 的工作排程呢？
<br>&nbsp;
<table width="650" bgcolor="#000000" border="1" cols="1">
<tbody><tr>
<td><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">crontab -l</font><font color="#ffffff">
</font><font color="#ff9900">&lt;==这个 -l 是 L 的小写</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1"># DO NOT EDIT
THIS FILE - edit the master and reinstall.</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1"># (/tmp/crontab.27683
installed on Thu May 30 13:38:38 2002)</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1"># (Cron version
-- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $)</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">59 23 1 5 *
mail pigpp &lt; /home/test/lover.txt</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">*/5 * * * *
/home/test/test.sh</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">30 16 * * 5
mail frend@test.domain.name &lt; /home/test/frend.txt</font></font></font></td>
</tr>
</tbody></table>
呵呵呵！其实这个显示的内容就是 /var/spool/cron/test 档案的内容啦！那么如何删除排程呢？
<br>&nbsp;
<table width="650" bgcolor="#000000" border="1" cols="1">
<tbody><tr>
<td><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]#</font><font color="#ffff00"> crontab -r</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">[test @test
test]# </font><font color="#ffff00">crontab -l</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">no crontab
for test</font></font></font></td>
</tr>
</tbody></table>
看到了吗？ crontab 『整个内容都不见了！』所以请注意：『<font color="#3333ff">如果只是要删除某个
crontab 的工作项目，那么请使用 crontab -e 来重新编辑即可！</font>』如果使用
-r 的参数，是会将所有的 crontab 数据内容都删掉的！千万注意了！</blockquote>

<hr width="100%"><a name="etc-crontab"></a><font color="#000099"><font size="+1">系统的
crontab 设定</font></font>
<blockquote>这个『 crontab -e 』是针对使用者的 cron 来设计的，如果是『系统的例行性任务』时，该怎么办呢？是否还是需要以
crontab -e 来管理你的例行性命令呢？当然不需要，你只要编辑
<b><font color="#3333ff">/etc/crontab</font></b>这个档案就可以啦！有一点需要特别注意喔！那就是
crontab -e 这个 crontab 其实是 /usr/bin/crontab 这个执行档，但是 /etc/crontab
可是一个『纯文本档』喔！你可以 root 的身份编辑一下这个档案哩！</blockquote>

<blockquote>基本上， cron 这个服务的最低侦测限制是『分钟』，所以『<b> cron
会每分钟去读取一次 /etc/crontab 与 /var/spool/cron 里面的数据内容</b>』，因此，只要你编辑完
/etc/crontab 这个档案，并且将他储存之后，呵呵！那么 crontab 的设定就自动的会来执行了！
<blockquote><font color="#000066"><b>注意</b>：在 Linux 底下的 crontab
会自动的帮我们每分钟重新读取一次 /etc/crontab 的例行工作事项，但是某些原因或者是其他的
Unix 系统中，由于 crontab 是读到内存当中的，所以在你修改完 /etc/crontab
之后，可能并不会马上执行，这个时候请重新启动 crond 这个服务吧！</font>
<blockquote><b><font face="细明体"><font color="#000066">/etc/rc.d/init.d/crond
restart</font></font></b></blockquote>
</blockquote>
好了，我们来看看 /etc/crontab 这的档案的内容吧：
<br>&nbsp;
<table width="600" bgcolor="#000000" border="1" cols="1">
<tbody><tr>
<td><font face="细明体"><font size="-1"><font color="#ffffff">[root@test
/root]# </font><font color="#ffff00">vi /etc/crontab</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">SHELL=/bin/bash</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">PATH=/sbin:/bin:/usr/sbin:/usr/bin</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">MAILTO=root</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">HOME=/</font></font></font>
<p><font face="细明体"><font color="#ffffff"><font size="-1"># run-parts</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">01&nbsp; *
* * * root&nbsp;&nbsp;&nbsp; run-parts /etc/cron.hourly&nbsp;</font><font color="#ffff00">&nbsp;</font><font color="#ff9900">
&lt;==每小时执行的工作</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">02&nbsp; 4
* * * root&nbsp;&nbsp;&nbsp; run-parts /etc/cron.daily&nbsp;&nbsp; </font><font color="#ff9900">&lt;==每天
执行的工作</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">22&nbsp; 4
* * 0 root&nbsp;&nbsp;&nbsp; run-parts /etc/cron.weekly&nbsp; </font><font color="#ff9900">&lt;==每星期执行的工作</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">42&nbsp; 4
1 * * root&nbsp;&nbsp;&nbsp; run-parts /etc/cron.monthly&nbsp;</font><font color="#ff9900">
&lt;==每个月执行的工作</font></font></font>
<br><font face="细明体"><font color="#ffff00"><font size="-1">分 时日月周
使用者&nbsp;&nbsp;&nbsp; 参数&nbsp;&nbsp;&nbsp;&nbsp; 指令</font></font></font></p></td>
</tr>
</tbody></table>
看到这个档案的内容你大概就了解了吧！呵呵，没错！这个档案与将刚刚我们下达
crontab -e 的内容几乎完全一模一样！只是有几个地方不太相同：</blockquote>

<ul>
<ul>
<li>
<b><font color="#3333ff">MAILTO=root</font></b>：是说，当 /etc/crontab
这个档案中的例行性命令发生错误时，会将错误讯息或者是屏幕显示的讯息传给谁？由于
root 并无法在客户端中收信，因此，我通常都将这个 e-mail 改成自己的账号，好让我随时了解系统的状况！</li>
</ul>
</ul>

<ul>
<ul>
<li>
<b><font face="细明体"><font color="#3333ff">01 * * * * root run-parts
/etc/cron.hourly</font></font></b>：在批注符号 <font face="细明体">#run-parts</font>
这一行以后的命令，我们可以发现，五个数字后面接的是 root 喔！没错，这一行代表的是『<font color="#3333ff">执行的层级为
root 身份</font>』当然啰，你也可以将这一行改写成其他的身份哩！而 <font color="#3333ff">run-parts</font>
代表后面接的 /etc/cron.hourly 是『<font color="#3333ff">一个目录内（/etc/cron.hourly）的所有可执行文件</font>』，这也就是说，<font color="#000099">每</font><font color="#3333ff">个小时的
01 分，系统会以 root 层级的使用者去 /etc/cron.hourly 这个目录下执行所有可以执行的档案</font>！后面的三行也都是类似的意思！你可以到
/etc/ 底下去看看，系统本来就默认了这四个目录了！你可以将每天需要执行的命令直接写到
/etc/cron.daily 即可，还不需要使用到 crontab -e 的程序呢！方便吧！</li>
</ul>
</ul>

<ul>
<ul>
<ul>注意：基本上 /etc/crontab 里头支持两种下达指令的方式，一种是直接以
指令型态 下达，一种则是以『目录规划』来下达；</ul>
</ul>
</ul>

<ul>
<ul>
<ul>
<ul>
<li>
<font face="细明体"><b>指令型态</b>：</font></li>

<br><font face="细明体">01 * * * * test mail -s test test &lt; /home/test/test.txt</font>
<br><font face="细明体">使用者是 test, 且在每个小时执行一次指令 mail ...</font></ul>
</ul>
</ul>
</ul>

<ul>
<ul>
<ul>
<ul>
<li>
<font face="细明体"><b>目录规划</b>：</font></li>

<br><font face="细明体">*/5 * * * * root run-parts /root/runcron</font>
<br><font face="细明体">建立一个 /root/runcron 的目录，将要每隔五分钟执行的『可执行文件』都写到该目录下，就可以让系统每五分钟执行一次该目录下的所有可执行文件。</font></ul>
</ul>
</ul>
</ul>

<ul>这样就可以晓得 run-parts 的用意了吧！此外，与 crontab -e 规划当中最不相同的就是多了一个『使用者层级』的概念，通常我们都是以
root 的角度来规划例行性命令，但是总有不需要 root 的指令吧！就可以使用这个层级来规范该程序的用户属于谁啰！</ul>

<ul>好！你现在大概了解了这一个咚咚吧！OK！假设你现在要作一个目录，让系统可以每
2 分钟去执行这个目录下的所有可以执行的档案，你可以写下如下的这一行在 /etc/crontab
中：</ul>

<ul>
<ul><font face="细明体"><font color="#3333ff">*/2 * * * * root run-parts
/etc/cron.min</font></font></ul>
</ul>

<ul>当然啰， /etc/cron.min 这个目录是需要存在的喔！那如果我需要执行的是一个『程序』而已，不需要用到一个目录呢？该如何是好？例如在侦测网络流量时，我们希望每五分钟侦测分析一次，可以这样写：</ul>

<ul>
<ul><font face="细明体"><font color="#3333ff">*/5 * * * * root /usr/local/mrtg-2/bin/mrtg
/usr/local/apache/htdocs/mrtg/net/mrtg.cfg</font></font></ul>
</ul>

<ul>没有了 run-parts 就是代表『一个档案』的意思啦！</ul>

<ul>如何！？建立例行性命令很简单吧！如果你是系统管理员的话，直接修改 /etc/crontab
这个档案即可喔！又便利，又方便管理呢！</ul>

<hr width="100%"><a name="safe"></a><font color="#000099"><font size="+1">安全的防护</font></font>
<ul>
<li>
<b><font color="#000099">资源分配不均</font></b>：</li>

<br>当大量使用 crontab 的时候，总是会有问题发生的，最严重的问题就是『系统资源分配不均』的问题，以我的系统为例，
VBird 有侦测流量的信息，包括：</ul>

<ul>
<ul>
<li>
流量</li>

<li>
区域内其他 PC 的流量侦测</li>

<li>
CPU 使用率</li>

<li>
RAM 使用率</li>

<li>
在线人数实时侦测</li>
</ul>
</ul>

<ul>如果每个流程都在同一个时间启动的话，呵呵！那么在某个时段时，我的系统会变的相当的繁忙，所以，这个时候就必须要分别设定啦！我可以这样做：
<br>&nbsp;
<table width="600" bgcolor="#000000" border="1" cols="1">
<tbody><tr>
<td><font face="细明体"><font size="-1"><font color="#ffffff">[root@test
/root]# </font><font color="#ffff00">vi /etc/crontab</font></font></font>
<br><font face="细明体"><font size="-1"><font color="#ffffff">1,6,11,16,21,26,31,36,41,46,51,56
* * * * root ........&nbsp; </font><font color="#ff9900">&lt;==那个 ..
代表你的指令</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">2,7,12,17,22,27,32,37,42,47,52,57
* * * * root ........</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">3,8,13,18,23,28,33,38,43,48,53,58
* * * * root ........</font></font></font>
<br><font face="细明体"><font color="#ffffff"><font size="-1">4,9,14,19,24,29,34,39,44,49,54,59
* * * * root ........</font></font></font></td>
</tr>
</tbody></table>
看到了没？那个『 , 』分隔的时候，请注意，不要有空格符！（连续的意思）如此一来，则可以将每五分钟工作的流程分别在不同的时刻来工作！则可以让系统的执行较为顺畅呦！</ul>

<ul>
<li>
<b><font color="#000099">取消不要的输出项目</font></b>：</li>

<br>另外一个困扰发生在『<b>当有执行成果或者是执行的项目中有输出的数据时，该数据将会
mail 给 MAILTO 设定的账号</b>』，好啦，那么当有一个排程一直出错（例如 DNS
的侦测系统当中，若 DNS 上层主机挂掉，那么你就会一直收到错误讯息！）怎么办？呵呵！还记得
<a href="http://linux.vbird.org/linux_basic/0430cron/0340bashshell-scripts.php">BASH
与 Shell scripts </a>那一章吧！？直接以『命令重导向』将输出的结果输出到
<b><font face="细明体">/dev/null</font></b>
这个垃圾桶当中就好了！</ul>

<ul>
<li>
<b><font color="#000099">安全的检验</font></b>：</li>

<br>很多时候被植入木马都是以例行命令的方式植入的，所以可以藉由检查 /var/log/cron
的内容来视察是否有『非您设定的 cron 被执行了？』这个时候就需要小心一点啰！</ul>

<hr width="100%"><a name="FAQ"></a><font color="#000099"><font size="+1">本章习题练习
( 要看答案请将鼠标移动到『答：』底下的空白处，按下左键圈选空白处即可察看
)</font></font>
<ul>
<li>
今天假设我有一个指令程序，名称为： ping.sh 这个档名！我想要让系统每三分钟执行这个档案一次，但是偏偏这个档案会有很多的讯息显示出来，所以我的
root 账号每天都会收到差不多四百多封的信件，光是收信就差不多快要疯掉了！那么请问应该怎么设定比较好呢？</li>

<br>答：
<ul><font face="细明体"><font color="#ffffff">这个涉及命令重导向的问题，我们可以将他导入档案或者直接丢弃！如果该讯息不重要的话，那么就予以丢弃，如果讯息很重要的话，才将他保留下来！假设今天这个命令不重要，所以将他丢弃掉！因此，可以这样写：</font></font>
<br><font face="细明体"><font color="#ffffff">*/5 * * * * root /usr/local/ping.sh
&gt; /dev/null 2&gt;&amp;1</font></font></ul>
</ul>

<hr width="100%"><font face="新细明体"><font color="#000066"><font size="-1">2002/05/30：第一次完成</font></font></font>
<br><font face="新细明体"><font color="#000066"><font size="-1">2003/02/10：重新编排与加入
FAQ</font></font></font>
<hr width="100%">
<center>
<font color="#000066"><font size="-1">Designed by <a href="mailto:vbird@mail.vbird.idv.tw">VBird</a>
during 2001-2004.&nbsp; Aerosol Lab.</font></font>
﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></center>
</div></center>
</body></html>
