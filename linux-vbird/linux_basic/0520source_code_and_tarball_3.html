<html><head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="Author" content="2011/04/21,white">
	<meta name="Description" content="谈一下，在 Linux 里面的软件管理，用最原始的原始码与 tarball 来管理的。">
	<title>鸟哥的 Linux 私房菜 -- 原始码与 Tarball 软件管理员</title>
    <script src="../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../script/index.js" type="text/javascript"></script>
	<link href="../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    </head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html')">

<center>
<div id="apDiv5">
<div> <LINK REL="SHORTCUT ICON" HREF="../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="../linux_server/0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="Mandrake9.0/mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="../linux_server/index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="../linux_server/linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="../linux_server/centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="../linux_server/index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<table summary="本文内容的排版" style="width: 898px;" border="0" cellpadding="0" cellspacing="0">
<tbody><tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
<tr><td style="width: 16px; font-size: 6px;">　</td>
    <td width="866">

<!-- 本文的档头部分 -->
<div style="text-align: center;">
    <a href="0520source_code_and_tarball.html">
    <span class="text_head0">第二十二章、软件安装：原始码与<span class="text_head_en"> Tarball </span></span></a><br>
</div>
    <div style="text-align: right;">
        <span class="text_history">最近升级日期：2009/09/15</span>
    </div>
<!-- 本文的连结区部分 -->

<div class="block1">
<span class="text_h1">
3. <a href="#make">用 make 进行巨集编译</a><br>
	<span class="text_h2">
	　　3.1 <a href="#make_why">为什么要用 make</a><br>
	　　3.2 <a href="#make_makefile">makefile 的基本语法与变量</a><br>
	</span>
</span></div>

<!-- 本文的正式部分 -->
<hr><a name="make"></a><img src="../image/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">用 make 进行巨集编译</span>
<div class="block1">
	<p>在本章一开始我们提到过 make 的功能是可以简化编译过程里面所下达的命令，同时还具有很多很方便的功能！那么底下咱们就来试看看使用
	make 简化下达编译命令的流程吧！<br><br></p>

	<hr><a name="make_why"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">为什么要用 make</span>
	<div class="block2">
		<p>先来想像一个案例，假设我的运行档里面包含了四个原始码文件，分别是 main.c haha.c sin_value.c cos_value.c 
		这四个文件，这四个文件的目的是：</p>

		<ul style="font-family: '细明体';">
		<li>main.c ：主要的目的是让使用者输入角度数据与呼叫其他三支副程序；</li>
		<li>haha.c ：输出一堆有的没有的信息而已；</li>
		<li>sin_value.c ：计算使用者输入的角度(360) sin 数值；</li>
		<li>cos_value.c ：计算使用者输入的角度(360) cos 数值。</li>
		</ul>

		<p>这四个文件你可以到 <a href="../index-2.html">http://cn.linux.vbird.org/linux_basic/0520source/main.tgz</a>
		来下载。由於这四个文件里面包含了相关性，并且还用到数学函式在里面，所以如果你想要让这个程序可以跑，
		那么就需要这样编译：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先进行目标档的编译，最终会有四个 *.o 的档名出现：</span>
[root@www ~]# <span class="term_command">gcc -c main.c</span>
[root@www ~]# <span class="term_command">gcc -c haha.c</span>
[root@www ~]# <span class="term_command">gcc -c sin_value.c</span>
[root@www ~]# <span class="term_command">gcc -c cos_value.c</span>

<span class="term_hd"># 2. 再进行连结成为运行档，并加入 libm 的数学函式，以产生 main 运行档：</span>
[root@www ~]# <span class="term_command">gcc -o main main.o haha.o sin_value.o cos_value.o \</span>
&gt; <span class="term_command">-lm -L/usr/lib -L/lib</span>

<span class="term_hd"># 3. 本程序的运行结果，必须输入姓名、360 度角的角度值来计算：</span>
[root@www ~]# <span class="term_command">./main </span>
Please input your name: <span class="term_command">VBird</span>  <span class="term_note">&lt;==这里先输入名字</span>
Please enter the degree angle (ex&gt; 90): <span class="term_command">30</span>   <span class="term_note">&lt;==输入以 360 度角为主的角度</span>
Hi, Dear VBird, nice to meet you.    <span class="term_note">&lt;==这三行为输出的结果喔！</span>
The Sin is:  0.50
The Cos is:  0.87
</pre></td></tr></tbody></table>

		<p>编译的过程需要进行好多动作啊！而且如果要重新编译，则上述的流程得要重新来一遍，光是找出这些命令就够烦人的了！
		如果可以的话，能不能一个步骤就给他完成上面所有的动作呢？那就利用 make 这个工具吧！
		先试看看在这个目录下创建一个名为 makefile 的文件，内容如下：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先编辑 makefile 这个守则档，内容只要作出 main 这个运行档</span>
[root@www ~]# <span class="term_command">vim makefile</span>
<span class="term_write">main: main.o haha.o sin_value.o cos_value.o
	gcc -o main main.o haha.o sin_value.o cos_value.o -lm</span>
<span class="term_say"># 注意：第二行的 gcc 之前是 &lt;tab&gt; 按键产生的空格喔！</span>

<span class="term_hd"># 2. 尝试使用 makefile 制订的守则进行编译的行为：</span>
[root@www ~]# <span class="term_command">rm -f main *.o   <span class="term_note">&lt;==先将之前的目标档去除</span></span>
[root@www ~]# <span class="term_command">make</span>
cc    -c -o main.o main.c
cc    -c -o haha.o haha.c
cc    -c -o sin_value.o sin_value.c
cc    -c -o cos_value.o cos_value.c
gcc -o main main.o haha.o sin_value.o cos_value.o -lm
<span class="term_say"># 此时 make 会去读取 makefile 的内容，并根据内容直接去给他编译相关的文件罗！</span>

<span class="term_hd"># 3. 在不删除任何文件的情况下，重新运行一次编译的动作：</span>
[root@www ~]# <span class="term_command">make</span>
make: `main' is up to date.
<span class="term_say"># 看到了吧！是否很方便呢！只会进行升级 (update) 的动作而已。</span>
</pre></td></tr></tbody></table>

		<p>或许你会说：『如果我创建一个 shell script 来将上面的所有动作都集结在一起，不是具有同样的效果吗？』呵呵！
		效果当然不一样，以上面的测试为例，我们仅写出 main 需要的目标档，结果 make 
		会主动的去判断每个目标档相关的原始码文件，并直接予以编译，最后再直接进行连结的动作！
		真的是很方便啊！此外，如果我们更动过某些原始码文件，则 make 也可以主动的判断哪一个原始码与相关的目标档文件有升级过，
		并仅升级该文件，如此一来，将可大大的节省很多编译的时间呢！要知道，某些程序在进行编译的行为时，会消耗很多的
		CPU 资源呢！所以说， make 有这些好处：</p>

		<ul class="text_import2">
		<li>简化编译时所需要下达的命令；</li>
		<li>若在编译完成之后，修改了某个原始码文件，则 make 仅会针对被修改了的文件进行编译，其他的
			object file 不会被更动；</li>
		<li>最后可以依照相依性来升级 (update) 运行档。</li></ul>

		<p>既然 make 有这么多的优点，那么我们当然就得好好的了解一下 make 这个令人关心的家伙啦！而 make 
		里面最需要注意的大概就是那个守则文件，也就是 makefile 这个文件的语法啦！所以底下我们就针对 makefile 
		的语法来加以介绍罗。</p>
	</div>

	<hr><a name="make_makefile"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">makefile 的基本语法与变量</span>
	<div class="block2">
		<a name="20080110"></a><p>make 的语法可是相当的多而复杂的，有兴趣的话可以到 <a href="http://www.gnu.org/software/make/manual/make.html" target="_blank">GNU</a> (<a href="#ps1">注1</a>)
		去查阅相关的说明，鸟哥这里仅列出一些基本的守则，重点在於让读者们未来在接触原始码时，不会太紧张啊！
		好了，基本的 makefile 守则是这样的：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_write">标的(target): 目标档1 目标档2
&lt;tab&gt;   gcc -o 欲创建的运行档 目标档1 目标档2</span>
</pre></td></tr></tbody></table>

		<p>那个标的 (target) 就是我们想要创建的资讯，而目标档就是具有相关性的 object files ，那创建运行档的语法就是以 
		&lt;tab&gt; 按键开头的那一行！特别给他留意喔，『<span class="text_import2">命令列必须要以 tab 
		按键作为开头</span>』才行！他的守则基本上是这样的：</p>

		<ul class="text_import2">
		<li>在 makefile 当中的 # 代表注解；</li>
		<li>&lt;tab&gt; 需要在命令行 (例如 gcc 这个编译器命令) 的第一个字节；</li>
		<li>标的 (target) 与相依文件(就是目标档)之间需以『:』隔开。</li>
		</ul>

		<p>同样的，我们以刚刚上一个小节的范例进一步说明，如果我想要有两个以上的运行动作时，
		例如下达一个命令就直接清除掉所有的目标档与运行档，该如何制作呢？</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先编辑 makefile 来创建新的守则，此守则的标的名称为 clean ：</span>
[root@www ~]# <span class="term_command">vi makefile</span>
main: main.o haha.o sin_value.o cos_value.o
	gcc -o main main.o haha.o sin_value.o cos_value.o -lm
<span class="term_write">clean:
	rm -f main main.o haha.o sin_value.o cos_value.o</span>

<span class="term_hd"># 2. 以新的标的 (clean) 测试看看运行 make 的结果：</span>
[root@www ~]# <span class="term_command">make clean</span>  <span class="term_note">&lt;==就是这里！透过 make 以 clean 为标的</span>
rm -rf main main.o haha.o sin_value.o cos_value.o
</pre></td></tr></tbody></table>

		<p>如此一来，我们的 makefile 里面就具有至少两个标的，分别是 main 与 clean ，如果我们想要创建 main 
		的话，输入『<span class="text_import2">make main</span>』，如果想要清除有的没的，输入『<span class="text_import2">make
		clean</span>』即可啊！而如果想要先清除目标档再编译 main 这个程序的话，就可以这样输入：『make 
		clean main』，如下所示：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">make clean main</span>
rm -rf main main.o haha.o sin_value.o cos_value.o
cc    -c -o main.o main.c
cc    -c -o haha.o haha.c
cc    -c -o sin_value.o sin_value.c
cc    -c -o cos_value.o cos_value.c
gcc -o main main.o haha.o sin_value.o cos_value.o -lm
</pre></td></tr></tbody></table>

		<p>这样就很清楚了吧！但是，你是否会觉得，咦！ makefile 里面怎么重复的数据这么多啊！没错！所以我们可以再藉由 shell
		script 那时学到的『变量』来更简化 makefile 喔：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vi makefile</span>
<span class="term_write">LIBS = -lm
OBJS = main.o haha.o sin_value.o cos_value.o
main: ${OBJS}
        gcc -o main ${OBJS} ${LIBS}
clean:
        rm -f main ${OBJS}</span>
</pre></td></tr></tbody></table>

		<p>与 <a href="0340bashshell-scripts.html">bash shell script</a> 的语法有点不太相同，变量的基本语法为：</p>

		<ol class="text_import2">
		<li>变量与变量内容以『=』隔开，同时两边可以具有空格；</li>
		<li>变量左边不可以有 &lt;tab&gt; ，例如上面范例的第一行 LIBS 左边不可以是 &lt;tab&gt;；</li>
		<li>变量与变量内容在『=』两边不能具有『:』；</li>
		<li>在习惯上，变量最好是以『大写字母』为主；</li>
		<li>运用变量时，以 ${变量} 或 $(变量) 使用；</li>
		<li>在该 shell 的环境变量是可以被套用的，例如提到的 CFLAGS 这个变量！</li>
		<li>在命令列模式也可以给予变量。</li></ol>

		<p>由於 <span class="text_import2">gcc 在进行编译的行为时，会主动的去读取 CFLAGS
		这个环境变量</span>，所以，你可以直接在 shell 定义出这个环境变量，也可以在
		makefile 文件里面去定义，更可以在命令列当中给予这个咚咚呢！例如：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">CFLAGS="-Wall" make clean main</span>
<span class="term_say"># 这个动作在上 make 进行编译时，会去取用 CFLAGS 的变量内容！</span>
</pre></td></tr></tbody></table>

		<p>也可以这样：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vi makefile</span>
LIBS = -lm
OBJS = main.o haha.o sin_value.o cos_value.o
<span class="term_write">CFLAGS = -Wall</span>
main: ${OBJS}
	gcc -o main ${OBJS} ${LIBS}
clean:
	rm -f main ${OBJS}
</pre></td></tr></tbody></table>

		<p>咦！我可以利用命令列进行环境变量的输入，也可以在文件内直接指定环境变量，那万一这个
		CFLAGS 的内容在命令列与 makefile 里面并不相同时，以那个方式输入的为主？呵呵！问了个好问题啊！
		环境变量取用的守则是这样的：</p>

		<ol class="text_import2">
		<li>make 命令列后面加上的环境变量为优先；</li>
		<li>makefile 里面指定的环境变量第二；</li>
		<li>shell 原本具有的环境变量第三。</li></ol>

		<p>此外，还有一些特殊的变量需要了解的喔：</p>

		<ul class="text_import2">
		<li>$@：代表目前的标的(target)</li></ul>

		<p>所以我也可以将 makefile 改成：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vi makefile</span>
LIBS = -lm
OBJS = main.o haha.o sin_value.o cos_value.o
CFLAGS = -Wall
main: ${OBJS}
	<span class="term_write">gcc -o $@ ${OBJS} ${LIBS}</span>   <span class="term_note">&lt;==那个 $@ 就是 main ！</span>
clean:
	rm -f main ${OBJS}
</pre></td></tr></tbody></table>

		<p>这样是否稍微了解了 makefile (也可能是 Makefile) 
		的基本语法？这对於你未来自行修改原始码的编译守则时，是很有帮助的喔！^_^！</p>
	</div>
</div>
<hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
</tbody></table>

<div style="padding-top: 0px; text-align: center;">
<span style="font-size: 80%;">
	<a href="http://linux.vbird.org/" target="_top" title="前往鸟哥的首页">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="联络鸟哥(我不要广告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
         ﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></div>
</div>
</center>
</body></html>
