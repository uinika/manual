<html><head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="Author" content="2011/04/19,white">
	<meta name="Description" content="可以公平使用磁碟容量的 Quota 以及可添加磁碟容量的 RAID, LVM, iSCSI 设备等介绍">
	<title>鸟哥的 Linux 私房菜 -- Quota, Software RAID, LVM, iSCSI</title>
    <script src="../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../script/index.js" type="text/javascript"></script>
	<link href="../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    </head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html')">

<center>
<div id="apDiv5">
<div> <LINK REL="SHORTCUT ICON" HREF="../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="../linux_server/0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="Mandrake9.0/mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="../linux_server/index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="../linux_server/linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="../linux_server/centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="../linux_server/index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<table summary="本文内容的排版" style="width: 898px;" border="0" cellpadding="0" cellspacing="0">
<tbody><tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
<tr><td style="width: 16px; font-size: 6px;">　</td>
    <td width="866">

<!-- 本文的档头部分 -->
<div style="text-align: center;">
    <a href="0420quota.html">
    <span class="text_head0">第十五章、磁碟配额<span class="text_head_en">(Quota)</span>与进阶文件系统管理</span></a><br>
</div>
    <div style="text-align: right;">
        <span class="text_history">最近升级日期：2009/09/10</span>
    </div>
<!-- 本文的连结区部分 -->
<div class="block1">
<span class="text_h1">
1. <a href="#the_quota">磁碟配额 (Quota) 的应用与实作</a><br>
	<span class="text_h2">
	　　1.1 <a href="#the_quota_whatis">什么是 Quota</a>：<a href="#the_quota_use">一般用途</a>,  
		<a href="#the_quota_limit">限制</a>, 
		<a href="#the_quota_set">规范 (inode/block, soft/hard, grace time)</a><br>
	　　1.2 <a href="#quota_flow">一个 Quota 的实作范例</a><br>
	　　1.3 <a href="#quota_flow_1">实作 Quota 流程-1：文件系统支持</a> <a href="#fstab">(/etc/fstab, /etc/mtab)</a><br>
	　　1.4 <a href="#quota_flow_2">实作 Quota 流程-2：创建 quota 记录档</a> (<a href="#quotacheck">quotacheck</a>)<br>
	　　1.5 <a href="#quota_flow_3">实作 Quota 流程-3：启动、关闭与限制值配置</a> (<a href="#quotaon">quotaon</a>, 
		<a href="#quotaoff">quotaoff</a>, <a href="#edquota">edquota</a>)<br>
	　　1.6 <a href="#quota_flow_4">实作 Quota 流程-4：Quota 限制值的报表</a> (<a href="#quota">quota</a>,
		<a href="#repquota">repquota</a>)<br>
	　　1.7 <a href="#quota_flow_5">实作 Quota 流程-5：测试与管理</a> (<a href="#quota_flow_5">测试</a>,
		<a href="#warnquota">warnquota</a>, <a href="#setquota">setquota</a>)<br>
	　　1.8 <a href="#quota_nochange">不更动既有系统的 Quota 实例</a><br>
	</span>
</span></div>
<!-- 本文的正式部分 -->
<hr><a name="the_quota"></a><img src="../image/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">磁碟配额 (Quota) 的应用与实作</span><br>
<div class="block1">
	<p>Quota 这个玩意儿就字面上的意思来看，就是有多少『限额』的意思啦！如果是用在零用钱上面，
	就是类似『<span class="text_import2">有多少零用钱一个月</span>』的意思之类的。如果是在计算机主机的磁碟使用量上呢？以
	Linux 来说，就是有多少容量限制的意思罗。我们可以使用 quota 来让磁碟的容量使用较为公平，
	底下我们会介绍什么是 quota ，然后以一个完整的范例来介绍 quota 的实作喔！<br><br></p>

	<hr><a name="the_quota_whatis"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">什么是 Quota</span><br>
	<div class="block2">
		<p>在 Linux 系统中，由於是多人多工的环境，所以会有多人共同使用一个磁盘空间的情况发生，
		如果其中有少数几个使用者大量的占掉了磁盘空间的话，那势必压缩其他使用者的使用权力！
		因此管理员应该适当的限制硬盘的容量给使用者，以妥善的分配系统资源！避免有人抗议呀！</p>

		<p>举例来说，我们使用者的默认家目录都是在 /home 底下，如果 /home 是个独立的 partition ，
		假设这个分割槽有 10G 好了，而 /home 底下共有 30 个帐号，也就是说，每个使用者平均应该会有 333MB 的空间才对。
		偏偏有个使用者在他的家目录底下塞了好多只影片，占掉了 8GB 的空间，想想看，是否造成其他正常使用者的不便呢？
		如果想要让磁碟的容量公平的分配，这个时候就得要靠 quota 的帮忙罗！<br><br></p>

		<a name="the_quota_use"></a>
		<hr><ul class="list1"><li class="text_import1">Quota 的一般用途</li></ul>

		<p>quota 比较常使用的几个情况是：</p>
		<ul class="text_import2">
		<li>针对 WWW server ，例如：每个人的网页空间的容量限制！</li>
		<li>针对 mail server，例如：每个人的邮件空间限制。</li>
		<li>针对 file server，例如：每个人最大的可用网络磁盘空间 (教学环境中最常见！)</li>
		</ul>

		<p>上头讲的是针对网络服务的设计，如果是针对 Linux 系统主机上面的配置那么使用的方向有底下这一些：</p>
		<ul>
		<li><span class="text_import2">限制某一群组所能使用的最大磁碟配额 (使用群组限制)</span>：<br>
		你可以将你的主机上的使用者分门别类，有点像是目前很流行的付费与免付费会员制的情况，
		你比较喜好的那一群的使用配额就可以给高一些！呵呵！ ^_^...<br><br></li>

		<li><span class="text_import2">限制某一使用者的最大磁碟配额 (使用使用者限制)</span>：<br>
		在限制了群组之后，你也可以再继续针对个人来进行限制，使得同一群组之下还可以有更公平的分配！<br><br></li>

		<li><span class="text_import2">以 Link 的方式，来使邮件可以作为限制的配额 (更改 /var/spool/mail 
		这个路径)</span>：<br>如果是分为付费与免付费会员的『邮件主机系统』，是否需要重新再规划一个硬盘呢？
		也不需要啦！直接使用 Link 的方式指向 /home (或者其他已经做好的 quota 磁碟) 就可以啦！
		这通常是用在原本磁盘分区的规划不好，但是却又不想要更动原有主机架构的情况中啊！</li></ul>

		<p>大概有这些实际的用途啦！<br><br></p>

		<a name="the_quota_limit"></a>
		<hr><ul class="list1"><li class="text_import1">Quota 的使用限制</li></ul>

		<p>虽然 quota 很好用，但是使用上还是有些限制要先了解的：</p>

		<ul>
		<li><span class="text_import2">仅能针对整个 filesystem：</span><br>
		quota 实际在运行的时候，是针对『<span class="text_import2">整个 filesystem</span>』进行限制的，
		例如：如果你的 /dev/sda5 是挂载在 /home 底下，那么在 /home 底下的所有目录都会受到限制！<br><br></li>

		<li><span class="text_import2">核心必须支持 quota ：</span><br>
		Linux 核心必须有支持 quota 这个功能才行：如果你是使用 CentOS 5.x 的默认核心，
		嘿嘿！那恭喜你了，你的系统已经默认有支持 quota 这个功能罗！如果你是自行编译核心的，
		那么请特别留意你是否已经『真的』开启了 quota 这个功能？否则底下的功夫将全部都视为『白工』。<br><br></li>

		<li><span class="text_import2">Quota 的记录档：</span><br>
		目前新版的 Linux distributions 使用的是 Kernel 2.6.xx 的核心版本，这个核心版本支持新的 quota 
		模块，使用的默认文件 (aquota.user, aquota.group )将不同於旧版本的 quota.user, quota.group ！
		(多了一个 a 呦！) 而由旧版本的 quota 可以藉由 convertquota 这个程序来转换呢！<br><br></li>

		<li><span class="text_import2">只对一般身份使用者有效：</span><br>
		这就有趣了！并不是所有在 Linux 上面的帐号都可以配置 quota 呢，例如 root 就不能配置 quota ，
		因为整个系统所有的数据几乎都是他的啊！ ^_^</li>
		</ul>

		<p>所以罗，你不能针对『某个目录』来进行 Quota 的设计，但你可以针对『某个文件系统 (filesystem) 』来配置。
		如果不明白目录与挂载点还有文件系统的关系，请回到<a href="0230filesystem.html">第八章</a>去瞧瞧再回来！
		<br><br></p>

		<a name="the_quota_set"></a>
		<hr><ul class="list1"><li class="text_import1">Quota 的规范配置项目：</li></ul>

		<p>quota 这玩意儿针对整个 filesystem 的限制项目主要分为底下几个部分：</p>

		<ul>
		<li><span class="text_import2">容量限制或文件数量限制 (block 或 inode)：</span><br><br>
		我们在<a href="0230filesystem.html">第八章</a>谈到文件系统中，说到文件系统主要规划为存放属性的 
		inode 与实际文件数据的 block 区块，Quota 既然是管理文件系统，所以当然也可以管理 inode 或 block 罗！
		这两个管理的功能为：<br><br>
		<ul class="text_import2"><li>限制 inode 用量：可以管理使用者可以创建的『文件数量』；</li>
		<li>限制 block 用量：管理使用者磁碟容量的限制，较常见为这种方式。</li></ul>
		<br></li>

		<li><span class="text_import2">柔性劝导与硬性规定 (soft/hard)：</span><br><br>
		既然是规范，当然就有限制值。不管是 inode/block ，限制值都有两个，分别是 soft 与 hard。
		通常 hard 限制值要比 soft 还要高。举例来说，若限制项目为 block ，可以限制 hard 为 500MBytes 而 soft
		为 400MBytes。这两个限值的意义为：<br><br>
		<ul>
		<li>hard：表示使用者的用量绝对不会超过这个限制值，以上面的配置为例，
		使用者所能使用的磁碟容量绝对不会超过 500Mbytes ，若超过这个值则系统会锁住该用户的磁碟使用权；<br><br></li>
		<li>soft：表示使用者在低於 soft 限值时 (此例中为 400Mbytes)，可以正常使用磁碟，但若超过 soft 
		且低於 hard 的限值 (介於 400~500Mbytes 之间时)，每次使用者登陆系统时，系统会主动发出磁碟即将爆满的警告信息，
		且会给予一个宽限时间 (grace time)。不过，若使用者在宽限时间倒数期间就将容量再次降低於 soft 限值之下，
		则宽限时间会停止。</li>
		</ul><br></li>

		<li><span class="text_import2">会倒数计时的宽限时间 (grace time)：</span><br><br>
		刚刚上面就谈到宽限时间了！这个宽限时间只有在使用者的磁碟用量介於 soft 到 hard 之间时，才会出现且会倒数的一个咚咚！
		由於达到 hard 限值时，使用者的磁碟使用权可能会被锁住。为了担心使用者没有注意到这个磁碟配额的问题，
		因此设计了 soft 。当你的磁碟用量即将到达 hard 且超过 soft  时，系统会给予警告，但也会给一段时间让使用者自行管理磁碟。
		一般默认的宽限时间为七天，如果七天内你都不进行任何磁碟管理，那么<span class="text_import2"> soft 
		限制值会即刻取代 hard 限值来作为 quota 的限制</span>。<br><br>

		以上面配置的例子来说，假设你的容量高达 450MBytes 了，那七天的宽限时间就会开始倒数，
		若七天内你都不进行任何删除文件的动作来替你的磁碟用量瘦身，
		那么七天后你的磁碟最大用量将变成 400MBytes (那个 soft 
		的限制值)，此时你的磁碟使用权就会被锁住而无法新增文件了。</li>
		</ul>

		<p>整个 soft, hard, grace time 的相关性我们可以用底下的图示来说明：</p>

		<center><img src="0420quota_files/soft_hard.gif" alt="soft, hard, grace time 的相关性" title="soft, hard, grace time 的相关性" border="0"><br>
		图 1.1.1、soft, hard, grace time 的相关性<br></center>

		<p>图中的长条图为使用者的磁碟容量，soft/hard 分别是限制值。只要小於 400M 就一切 OK ，
		若高於 soft 就出现 grace time 并倒数且等待使用者自行处理，若到达 hard 的限制值，
		那我们就搬张小板凳等著看好戏啦！嘿嘿！^_^！这样图示有清楚一点了吗？</p>
	</div>

	<hr><a name="quota_flow"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">一个 Quota 实作范例</span><br>
	<div class="block2">
		<p>坐而言不如起而行啊，所以这里我们使用一个范例来设计一下如何处理 Quota 的配置流程。</p>

		<ul>
		<li>目的与帐号：现在我想要让我的专题生五个为一组，这五个人的帐号分别是 myquota1, myquota2, 
		myquota3, myquota4, myquota5，这五个用户的口令都是 password ，且这五个用户所属的初始群组都是 myquotagrp 。
		其他的帐号属性则使用默认值。<br><br></li>
		<li>帐号的磁碟容量限制值：我想让这五个用户都能够取得 300MBytes 的磁碟使用量(hard)，文件数量则不予限制。
		此外，只要容量使用率超过 250MBytes ，就予以警告 (soft)。<br><br></li>

		<li>群组的限额：由於我的系统里面还有其他用户存在，因此我仅承认 myquotagrp 这个群组最多仅能使用 1GBytes 的容量。
		这也就是说，如果 myquota1, myquota2, myquota3 都用了 280MBytes 的容量了，那么其他两人最多只能使用
		(1000MB - 280x3 = 160MB) 的磁碟容量罗！这就是使用者与群组同时配置时会产生的后果。<br><br></li>

		<li>宽限时间的限制：最后，我希望每个使用者在超过 soft 限制值之后，都还能够有 14 天的宽限时间。</li>
		</ul>

		<p>好了，那你怎么规范帐号以及相关的 Quota 配置呢？首先，在这个小节我们先来将帐号相关的属性与参数搞定再说吧！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 制作帐号环境时，由於有五个帐号，因此鸟哥使用 script 来创建环境！</span>
[root@www ~]# <span class="term_command">vi addaccount.sh</span>
<span class="term_write">#!/bin/bash
# 使用 script 来创建实验 quota 所需的环境
groupadd myquotagrp
for username in myquota1 myquota2 myquota3 myquota4 myquota5
do
	useradd -g myquotagrp $username
	echo "password" | passwd --stdin $username
done</span>

[root@www ~]# <span class="term_command">sh addaccount.sh</span>
</pre></td></tr></tbody></table>

		<p>接下来，就让我们来实作 Quota 的练习吧！</p>
	</div>

	<hr><a name="quota_flow_1"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">实作 Quota 流程-1：文件系统支持</span><br>
	<div class="block2">
		<p>前面我们就谈到，要使用 Quota 必须要核心与文件系统支持才行！假设你已经使用了默认支持 Quota 的核心，
		那么接下来就是要启动文件系统的支持啦！不过，由於 Quota 仅针对整个文件系统来进行规划，所以我们得先查一下，
		/home 是否是个独立的 filesystem 呢？</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">df -h /home</span>
Filesystem     Size  Used Avail Use% Mounted on
/dev/hda3      4.8G  740M  3.8G  17% /home  <span class="term_note">&lt;==鸟哥主机的 /home 确实是独立的！</span>

[root@www ~]# <span class="term_command">mount | grep home</span>
/dev/hda3 on /home type <span class="term_write">ext3</span> (rw)
</pre></td></tr></tbody></table>

		<p>从上面的数据来看，鸟哥这部主机的 /home 确实是独立的 filesystem，因此可以直接限制 /dev/hda3 。
		如果你的系统的 /home 并非独立的文件系统，那么可能就得要针对根目录 (/) 来规范了！不过，不太建议在根目录配置 Quota。
		此外，由於 VFAT 文件系统并不支持 Linux Quota 功能，所以我们得要使用 mount 查询一下 /home 的文件系统为何？
		看起来是 Linux 传统的 ext2/ext3 ，这种文件系统肯定有支持 Quota 啦！没问题！</p>

		<p>如果只是想要在这次启动中实验 Quota ，那么可以使用如下的方式来手动加入 quota 的支持：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">mount -o remount,usrquota,grpquota /home</span>
[root@www ~]# <span class="term_command">mount | grep home</span>
/dev/hda3 on /home type ext3 (rw,<span class="term_write">usrquota,grpquota</span>)
<span class="term_say"># 重点就在於 usrquota, grpquota ！注意写法！</span>
</pre></td></tr></tbody></table>

		<p>事实上，<span class="text_import2">当你重新挂载时，系统会同步升级 /etc/mtab 这个文件，
		所以你必须要确定 /etc/mtab 已经加入 usrquota, grpquota 的支持到你所想要配置的文件系统中。</span>
		另外也要特别强调，使用者与群组的 quota 文件系统支持参数分别是：<span class="text_import1">usrquota, grpquota</span>
		！千万不要写错了！这一点非常多初接触 Quota 的朋友常常搞错。</p>

		<a name="fstab"></a>
		<p>不过手动挂载的数据在下次重新挂载就会消失，因此最好写入配置档中啊！在鸟哥这部主机的案例中，
		我可以直接修改 /etc/fstab 成为底下这个样子：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vi /etc/fstab</span>
LABEL=/home   /home  ext3   defaults<span class="term_command">,usrquota,grpquota</span>  1 2
<span class="term_say"># 其他项目鸟哥并没有列出来！重点在於第四栏位！於 default 后面加上两个参数！</span>

[root@www ~]# <span class="term_command">umount /home</span>
[root@www ~]# <span class="term_command">mount -a</span>
[root@www ~]# <span class="term_command">mount | grep home</span>
/dev/hda3 on /home type ext3 (rw<span class="term_write">,usrquota,grpquota</span>)
</pre></td></tr></tbody></table>

		<p>还是要再次的强调，修改完 /etc/fstab 后，务必要测试一下！若有发生错误得要赶紧处理！
		因为这个文件如果修改错误，是会造成无法启动完全的情况啊！切记切记！最好使用 vim 来修改啦！
		因为会有语法的检验，就不会让你写错字了！启动文件系统的支持后，接下来让我们创建起 quota 的记录档吧！</p>
	</div>

	<hr><a name="quota_flow_2"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">实作 Quota 流程-2：创建 quota 记录档</span><br>
	<div class="block2">
		<p>其实 <span class="text_import2">Quota 是透过分析整个文件系统中，每个使用者(群组)拥有的文件总数与总容量，
		再将这些数据记录在该文件系统的最顶层目录，然后在该记录档中再使用每个帐号(或群组)的限制值去规范磁碟使用量</span>的。
		所以啦，建置这个 Quota 记录档就显的非常的重要。扫瞄有支持 Quota 参数 (usrquota, grpquota) 的文件系统，
		就使用 quotacheck 这个命令！这个命令的语法如下：<br><br></p>

		<a name="quotacheck"></a>
		<hr><ul class="list1"><li class="text_import1">quotacheck ：扫瞄文件系统并创建 Quota 的记录档</li></ul>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">quotacheck [-avugfM] [/mount_point]</span>
<span class="term_say">选项与参数：
-a  ：扫瞄所有在 /etc/mtab 内，含有 quota 支持的 filesystem，加上此参数后， 
      /mount_point 可不必写，因为扫瞄所有的 filesystem 了嘛！
-u  ：针对使用者扫瞄文件与目录的使用情况，会创建 aquota.user
-g  ：针对群组扫瞄文件与目录的使用情况，会创建 aquota.group
-v  ：显示扫瞄过程的资讯；
-f  ：强制扫瞄文件系统，并写入新的 quota 配置档 (危险)
-M  ：强制以读写的方式扫瞄文件系统，只有在特殊情况下才会使用。</span>
</pre></td></tr></tbody></table>

		<p>quotacheck 的选项你只要记得『 -avug 』一起下达即可！那个 -f 与 -M 是在文件系统可能已经启动 quota 了，
		但是你还想要重新扫瞄文件系统时，系统会要求你加入那两个选项啦 (担心有其他人已经使用 quota 
		中)！平时没必要不要加上那两个项目。好了，那就让我们来处理我们的任务吧！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 针对整个系统含有 usrquota, grpquota 参数的文件系统进行 quotacheck 扫瞄</span>
[root@www ~]# <span class="term_command">quotacheck -avug</span>
quotacheck: <span class="term_write">Scanning /dev/hda3 [/home] quotacheck</span>: Cannot stat old user quota
file: No such file or directory <span class="term_note">&lt;==有找到文件系统，但尚未制作记录档！</span>
quotacheck: Cannot stat old group quota file: No such file or directory
quotacheck: Cannot stat old user quota file: No such file or directory
quotacheck: Cannot stat old group quota file: No such file or directory
done  <span class="term_note">&lt;==上面三个错误只是说明记录档尚未创建而已，可以忽略不理！</span>
quotacheck: <u>Checked 130 directories and 107 files</u> <span class="term_note">&lt;==实际搜寻结果</span>
quotacheck: Old file not found.
quotacheck: Old file not found.
<span class="term_say"># 若运行这个命令却出现如下的错误信息，表示你没有任何文件系统有启动 quota 支持！
# quotacheck: Can't find filesystem to check or filesystem not mounted with 
# quota option.</span>

[root@www ~]# <span class="term_command">ll -d /home/a*</span>
-rw------- 1 root root 8192 Mar  6 11:58 /home/<span class="term_write">aquota.group</span>
-rw------- 1 root root 9216 Mar  6 11:58 /home/<span class="term_write">aquota.user</span>
<span class="term_say"># 在鸟哥的案例中，/home 独立的文件系统，因此搜寻结果会将两个记录档放在 
# /home 底下。这两个文件就是 Quota 最重要的资讯了！</span>
</pre></td></tr></tbody></table>

		<p>这个命令只要进行到这里就够了，不要反覆的进行！因为等一下我们会启动 quota 功能，若启动后你还要进行 quotacheck ，
		系统会担心破坏原有的记录档，所以会产生一些错误信息警告你。如果你确定没有任何人在使用 quota 时，
		可以强制重新进行 quotacheck 的动作。强制运行的情况可以使用如下的选项功能：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 如果因为特殊需求需要强制扫瞄已挂载的文件系统时</span>
[root@www ~]# <span class="term_command">quotacheck -avug -mf</span>
quotacheck: Scanning /dev/hda3 [/home] done
quotacheck: Checked 130 directories and 109 files
<span class="term_say"># 数据要简洁很多！因为有记录档存在嘛！所以警告信息不会出现！</span>
</pre></td></tr></tbody></table>

		<p>这样记录档就创建起来了！你不用手动去编辑那两个文件～因为那两个文件是 quota 自己的数据档，并不是纯文字档啦！
		且该文件会一直变动，这是因为当你对 /home 这个文件系统进行操作时，你操作的结果会影响磁碟吧！
		所以当然会同步记载到那两个文件中啦！所以要创建 aquota.user, aquota.group，记得使用的是 quotacheck 命令！
		不是手动编辑的喔！</p>
	</div>

	<hr><a name="quota_flow_3"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">实作 Quota 流程-3：Quota 启动、
	关闭与限制值配置</span><br>
	<div class="block2">
		<p>制作好 Quota 配置档之后，接下来就是要启动 quota 了！启动的方式很简单！使用 quotaon ，至於关闭就用 quotaoff
		即可<br><br></p>

		<a name="quotaon"></a>
		<hr><ul class="list1"><li class="text_import1">quotaon ：启动 quota 的服务</li></ul>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">quotaon [-avug]</span>
[root@www ~]# <span class="term_command">quotaon [-vug] [/mount_point]</span>
<span class="term_say">选项与参数：
-u  ：针对使用者启动 quota (aquota.user)
-g  ：针对群组启动 quota (aquota.group)
-v  ：显示启动过程的相关信息；
-a  ：根据 /etc/mtab 内的 filesystem 配置启动有关的 quota ，若不加 -a 的话，
      则后面就需要加上特定的那个 filesystem 喔！</span>

<span class="term_hd"># 由於我们要启动 user/group 的 quota ，所以使用底下的语法即可</span>
[root@www ~]# <span class="term_command">quotaon -auvg</span>
/dev/hda3 [/home]: group quotas turned on
/dev/hda3 [/home]: user quotas turned on

<span class="term_hd"># 特殊用法，假如你的启动 /var 的 quota 支持，那么仅启动 user quota 时</span>
[root@www ~]# <span class="term_command">quotaon -uv /var</span>
</pre></td></tr></tbody></table>

		<p>这个『 quotaon -auvg 』的命令几乎只在第一次启动 quota 时才需要进行！因为下次等你重新启动系统时，
		系统的 /etc/rc.d/rc.sysinit 这个初始化脚本就会自动的下达这个命令了！因此你只要在这次实例中进行一次即可，
		未来都不需要自行启动 quota ，因为 CentOS 5.x 系统会自动帮你搞定他！<br><br></p>

		<a name="quotaoff"></a>
		<hr><ul class="list1"><li class="text_import1">quotaoff ：关闭 quota 的服务</li></ul>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">quotaoff [-a]</span>
[root@www ~]# <span class="term_command">quotaoff [-ug] [/mount_point]</span>
<span class="term_say">选项与参数：
-a  ：全部的 filesystem 的 quota 都关闭 (根据 /etc/mtab)
-u  ：仅针对后面接的那个 /mount_point 关闭 user quota
-g  ：仅针对后面接的那个 /mount_point 关闭 group quota</span>
</pre></td></tr></tbody></table>

		<p>这个命令就是关闭了 quota 的支持！我们这里需要练习 quota 实作，所以这里请不要关闭他喔！
		接下来让我们开始来配置使用者与群组的 quota 限额吧！<br><br></p>

		<a name="edquota"></a>
		<hr><ul class="list1"><li class="text_import1">edquota ：编辑帐号/群组的限值与宽限时间</li></ul>

		<p>edquota 是 edit quota 的缩写，所以就是用来编辑使用者或者是群组限额的命令罗。我们先来看看 edquota 的语法吧，
		看完后再来实际操作一下。</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">edquota [-u username] [-g groupname]</span>
[root@www ~]# <span class="term_command">edquota -t</span>  <span class="term_note">&lt;==修改宽限时间</span>
[root@www ~]# <span class="term_command">edquota -p 范本帐号 -u 新帐号</span>
<span class="term_say">选项与参数：
-u  ：后面接帐号名称。可以进入 quota 的编辑画面 (vi) 去配置 username 的限制值；
-g  ：后面接群组名称。可以进入 quota 的编辑画面 (vi) 去配置 groupname 的限制值；
-t  ：可以修改宽限时间。
-p  ：复制范本。那个 范本帐号 为已经存在并且已配置好 quota 的使用者，
      意义为『将 范本帐号 这个人的 quota 限制值复制给 新帐号 』！</span>
</pre></td></tr></tbody></table>

		<p>好了，先让我们来看看当进入 myquota1 的限额配置时，会出现什么画面：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd">范例一：配置 dmtsai 这个使用者的 quota 限制值</span>
[root@www ~]# <span class="term_command">edquota -u myquota1</span>
Disk quotas for user myquota1 (uid 710):
  Filesystem    blocks  soft   hard  inodes  soft  hard
  /dev/hda3         80     0      0      10     0     0
</pre></td></tr></tbody></table>

		<p>上头第一行在说明针对哪个帐号 (myquota1) 进行 quota 的限额配置，第二行则是标头行，里面共分为七个栏位，
		七个栏位分别的意义为：</p>
		<ol class="text_import2">
		<li>文件系统 (filesystem)：说明该限制值是针对哪个文件系统 (或 partition)；</li>
		<li>磁碟容量 (blocks)：这个数值是 quota 自己算出来的，单位为 Kbytes，请不要更动他；</li>
		<li>soft：磁碟容量 (block) 的 soft 限制值，单位亦为 KB</li>
		<li>hard：block 的 hard  限制值，单位 KB；</li>
		<li>文件数量 (inodes)：这是 quota 自己算出来的，单位为个数，请不要更动他；</li>
		<li>soft：inode 的 soft 限制值；</li>
		<li>hard：inode 的 hard 限制值；</li>
		</ol>

		<p>当 soft/hard 为 0 时，表示没有限制的意思。好，依据我们的<a href="#quota_flow">范例说明</a>，我们需要配置的是 blocks 
		的 soft/hard ，至於 inode 则不要去更动他！因此上述的画面我们将他改成如下的模样：</p>

		<div style="padding: 10pt 0pt;" align="right"><table width="90%"><tbody><tr><td><b>Tips:</b><br><span style="color: rgb(0, 144, 0);"><font size="-1">		在 edquota 的画面中，每一行只要保持七个栏位就可以了，并不需要排列整齐的！
		</font></span></td><td><img src="0420quota_files/vbird_face.gif" alt="鸟哥的图示" title="鸟哥的图示"></td></tr></tbody></table></div>
<table class="term"><tbody><tr><td class="term"><pre>Disk quotas for user myquota1 (uid 710):
  Filesystem    blocks    soft    hard  inodes  soft  hard
  /dev/hda3         80  <span class="term_write">250000  300000</span>      10     0     0
<span class="term_say"># 鸟哥使用 1000 去近似 1024 的倍数！比较好算啦！然后就可以储存后离开罗！</span>
</pre></td></tr></tbody></table>

		<p>配置完成之后，我们还有其他 5 个用户要配置，由於配置值都一样，此时可以使用 quota 复制喔！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 将 myquota1 的限制值复制给其他四个帐号</span>
[root@www ~]# <span class="term_command">edquota -p myquota1 -u myquota2</span>
[root@www ~]# <span class="term_command">edquota -p myquota1 -u myquota3</span>
[root@www ~]# <span class="term_command">edquota -p myquota1 -u myquota4</span>
[root@www ~]# <span class="term_command">edquota -p myquota1 -u myquota5</span>
</pre></td></tr></tbody></table>

		<p>这样就方便多了！然后，赶紧更改一下群组的 quota 限额吧！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">edquota -g myquotagrp</span>
Disk quotas for group myquotagrp (gid 713):
  Filesystem    blocks    soft     hard  inodes  soft  hard
  /dev/hda3        400  <span class="term_write">900000  1000000</span>      50     0     0
<span class="term_say"># 记得，单位为 KB 喔！</span>
</pre></td></tr></tbody></table>

		<p>最后，将宽限时间给他改成 14 天吧！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 宽限时间原本为 7 天，将他改成 14 天吧！</span>
[root@www ~]# <span class="term_command">edquota -t</span>
Grace period before enforcing soft limits for users:
Time units may be: days, hours, minutes, or seconds
  Filesystem         Block grace period     Inode grace period
  /dev/hda3                <span class="term_write">14</span>days                  7days
<span class="term_say"># 原本是 7days ，我们将他给改为 14days 喔！</span>
</pre></td></tr></tbody></table>

		<p>透过这个简单的小步骤，我们已经将使用者/群组/宽限时间都配置妥当！接下来就是观察到底配置有没有生效啦！</p>
	</div>

	<hr><a name="quota_flow_4"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">实作 Quota 流程-4：Quota 
	限制值的报表</span><br>
	<div class="block2">
		<p>quota 的报表主要有两种模式，一种是针对每个个人或群组的 quota 命令，一个是针对整个文件系统的 repquota 命令。
		我们先从较简单的 quota 来介绍！你也可以顺道看看你的配置值对不对啊！<br><br></p>

		<a name="quota"></a>
		<hr><ul class="list1"><li class="text_import1">quota ：单一用户的 quota 报表</li></ul>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">quota [-uvs] [username]</span>
[root@www ~]# <span class="term_command">quota [-gvs] [groupname]</span>
<span class="term_say">选项与参数：
-u  ：后面可以接 username ，表示显示出该使用者的 quota 限制值。若不接 username 
      ，表示显示出运行者的 quota 限制值。
-g  ：后面可接 groupname ，表示显示出该群组的 quota 限制值。
-v  ：显示每个用户在 filesystem 的 quota 值；
-s  ：使用 1024 为倍数来指定单位，会显示如 M 之类的单位！</span>

<span class="term_hd"># 直接使用 quota 去显示出 myquota1 与 myquota2 的限额</span>
[root@www ~]# <span class="term_command">quota -uvs myquota1 myquota2</span>
Disk quotas for user myquota1 (uid 710):
   Filesystem  blocks  quota  limit   grace   files   quota   limit   grace
    /dev/hda3      80   <span class="term_write">245M   293M</span>              10       0       0
Disk quotas for user myquota2 (uid 711):
   Filesystem  blocks  quota  limit   grace   files   quota   limit   grace
    /dev/hda3      80   <span class="term_write">245M   293M</span>              10       0       0
<span class="term_say"># 这个命令显示出来的数据跟 <a href="#edquota">edquota</a> 几乎是一模一样的！只是多了个 grace 项目。
# 你会发现 grace 底下没有任何数据，这是因为我们的使用量 (80) 尚未超过 soft</span>

<span class="term_hd"># 显示出 myquotagrp 的群组限额</span>
[root@www ~]# <span class="term_command">quota -gvs myquotagrp</span>
Disk quotas for group myquotagrp (gid 713):
   Filesystem  blocks  quota  limit   grace   files   quota   limit   grace
    /dev/hda3     400   <span class="term_write">879M   977M</span>              50       0       0
</pre></td></tr></tbody></table>

		<p>由於使用常见的 K, M, G 等单位比较好算，因此上头我们使用了『 -s 』的选项，就能够以 M 为单位显示了。
		不过由於我们使用 <a href="#edquota">edquota</a> 配置限额时，使用的是近似值 (1000) 而不是实际的 1024 倍数，
		所以看起来会有点不太一样喔！由於 quota 仅能针对某些用户显示报表，如果要针对整个 filesystem 列出报表时，
		那个可爱的 repquota 就派上用场啦！<br><br></p>

		<a name="repquota"></a>
		<hr><ul class="list1"><li class="text_import1">repquota ：针对文件系统的限额做报表</li></ul>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">repquota -a [-vugs]</span>
<span class="term_say">选项与参数：
-a  ：直接到 /etc/mtab 搜寻具有 quota 标志的 filesystem ，并报告 quota 的结果；
-v  ：输出的数据将含有 filesystem 相关的细部资讯；
-u  ：显示出使用者的 quota 限值 (这是默认值)；
-g  ：显示出个别群组的 quota 限值。
-s  ：使用 M, G 为单位显示结果</span>

<span class="term_hd"># 查询本案例中所有使用者的 quota 限制情况：</span>
[root@www ~]# <span class="term_command">repquota -auvs</span>
*** Report for user quotas on device <span class="term_write">/dev/hda3</span>    <span class="term_note">&lt;==针对 /dev/hda3</span>
Block grace time: <span class="term_write">14days</span>; Inode grace time: 7days <span class="term_note">&lt;==block 宽限时间为 14 天</span>
                        Block limits                File limits
User            used    soft    hard  grace    used  soft  hard  grace
----------------------------------------------------------------------
root      --    651M       0       0              5     0     0
myquota1  --      80    245M    293M             10     0     0
myquota2  --      80    245M    293M             10     0     0
myquota3  --      80    245M    293M             10     0     0
myquota4  --      80    245M    293M             10     0     0
myquota5  --      80    245M    293M             10     0     0

Statistics:  <span class="term_note">&lt;==这是所谓的系统相关资讯，用 -v 才会显示</span>
Total blocks: 9
Data blocks: 2
Entries: 22
Used average: 11.000000
</pre></td></tr></tbody></table>

		<p>根据这些资讯，您就可以知道目前的限制情况罗！ ^_^！怎样， Quota 
		很简单吧！你可以赶紧针对你的系统配置一下磁碟使用的守则，让你的用户不会抱怨磁碟怎么老是被耗光！</p>
	</div>

	<hr><a name="quota_flow_5"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">实作 Quota 流程-5：测试与管理</span><br>
	<div class="block2">
		<p>Quota 到底有没有效果？测试看看不就知道了？让我们使用 myquota1 去测试看看，如果创建一个大文件时，
		整个系统会便怎样呢？</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 测试一：利用 myquota1 的身份，建置一个 270MB 的大文件，并观察 quota 结果！</span>
[myquota1@www ~]$ <span class="term_command">dd if=/dev/zero of=bigfile bs=1M count=270</span>
hda3: warning, user block quota exceeded.
270+0 records in
270+0 records out
283115520 bytes (283 MB) copied, 3.20282 seconds, 88.4 MB/s
<span class="term_say"># 注意看，我是使用 myquota1 的帐号去进行 dd 命令的喔！不要恶搞啊！
# 然后你可以发现出现一个 warning 的信息喔！接下来看看报表。</span>

[root@www ~]# <span class="term_command">repquota -auv </span>
*** Report for user quotas on device /dev/hda3
Block grace time: 14days; Inode grace time: 7days
                        Block limits                File limits
User            used    soft    hard  grace    used  soft  hard  grace
----------------------------------------------------------------------
myquota1  +-  276840  250000  300000 <span class="term_write">13days</span>      11     0     0
<span class="term_say"># 这个命令则是利用 root 去查阅的！
# 你可以发现 myquota1 的 grace 出现！并且开始倒数了！</span>

<span class="term_hd"># 测试二：再创建另外一个大文件，让总容量超过 300M ！</span>
[myquota1@www ~]$ <span class="term_command">dd if=/dev/zero of=bigfile2 bs=1M count=300</span>
hda3: write failed, user block limit reached.
dd: writing `bigfile2': Disk quota exceeded <span class="term_note">&lt;==看！错误信息不一样了！</span>
23+0 records in  <span class="term_note">&lt;==没办法写入了！所以只记录 23 笔</span>
22+0 records out
23683072 bytes (24 MB) copied, 0.260081 seconds, 91.1 MB/s

[myquota1@www ~]$ <span class="term_command">du -sk</span>
300000  .  <span class="term_note">&lt;==果然是到极限了！</span>
</pre></td></tr></tbody></table>

		<p>此时 myquota1 可以开始处理他的文件系统了！如果不处理的话，最后宽限时间会归零，然后出现如下的画面：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">repquota -au</span>
*** Report for user quotas on device /dev/hda3
Block grace time: 00:01; Inode grace time: 7days
                        Block limits                File limits
User            used    soft    hard  grace    used  soft  hard  grace
----------------------------------------------------------------------
myquota1  +-  300000  250000  300000   <span class="term_write">none</span>      11     0     0
<span class="term_say"># 倒数整个归零，所以 grace 的部分就会变成 none 啦！不继续倒数</span>
</pre></td></tr></tbody></table>

		<p>其实倒数归零也不会有什么特殊的意外啦！别担心！只是如果你的磁碟使用量介於 soft/hard 之间时，
		当倒数归零那么 soft 的值会变成严格限制，此时你就没有多余的容量可以使用了。如何解决？
		就登陆系统去删除文件即可啦！没有想像中那么可怕啦！问题是，使用者通常傻傻分不清楚到底系统出了什么问题，
		所以我们可能需要寄送一些警告信 (email) 给用户比较妥当。那么如何处理呢？透过 warnquota 来处置即可。<br><br></p>

		<a name="warnquota"></a>
		<hr><ul class="list1"><li class="text_import1">warnquota ：对超过限额者发出警告信</li></ul>

		<p>warnquota字面上的意义就是 quota 的警告 (warn) 嘛！那么这东西有什么用呢？他<span class="text_import2">可以依据 /etc/warnquota.conf 的配置，然后找出目前系统上面 quota 用量超过 soft 
		(就是有 grace time 出现的那些家伙) 的帐号，透过 email 的功能将警告信件发送到使用者的电子邮件信箱。</span>
		warnquota 并不会自动运行，所以我们需要手动去运行他。单纯运行『 warnquota 』之后，他会发送两封信出去，
		一封给 myquota1 一封给 root ！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">warnquota</span>
<span class="term_say"># 完全不会出现任何信息！没有信息就是『好信息』！ ^_^</span>

[root@www ~]# <span class="term_command">mail</span>
 N329 root@www.vbird.tsai   Fri Mar  6 16:10  27/1007  "<span class="term_write">NOTE: ....</span>
&amp; <span class="term_command">329</span>   <span class="term_note">&lt;==因为新信件在第 329 封之故</span>
From root@www.vbird.tsai  Fri Mar  6 16:10:18 2009
Date: Fri, 6 Mar 2009 16:10:17 +0800
From: root &lt;root@www.vbird.tsai&gt;
Reply-To: root@myhost.com
Subject: <span class="term_write">NOTE: You are exceeding your allocated disk space limits
To: myquota1@www.vbird.tsai
Cc: root@www.vbird.tsai</span>   <span class="term_note">&lt;==注意这三行，分别是标题、收件者与副本 (CC)。</span>

Your disk usage has exceeded the agreed limits on this server <span class="term_note">&lt;==问题说明</span>
Please delete any unnecessary files on following filesystems:

/dev/hda3  <span class="term_note">&lt;==底下这几行为发生磁碟『爆表』的资讯啦！</span>
                        Block limits               File limits
Filesystem           used    soft    hard  grace    used  soft  hard  grace
/dev/hda3      +-  300000  250000  300000 13days      12     0     0

root@localhost  <span class="term_note">&lt;==这个是警告信息发送者的『签名数据』啦！</span>

&amp; <span class="term_command">exit</span>  <span class="term_note">&lt;==离开 mail 程序！</span>
</pre></td></tr></tbody></table>

		<p>运行 warnquota 可能也不会产生任何信息以及信件，因为只有当使用者的 quota 有超过 soft 时，
		warnquota 才会发送警告信啦！那么上表的内容中，包括标题、资讯内容说明、签名档等数据放在哪里呢？
		刚刚不是讲过吗？ /etc/warnquota 啦！因为上述的数据是英文，不好理解吗？没关系，你可以自己转成中文喔！
		所以你可以这样处理的：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vi /etc/warnquota.conf</span>
<span class="term_say"># 先找到底下这几行的配置值：</span>
SUBJECT   = NOTE: You are exceeding your allocated disk space limits <span class="term_note">&lt;==第10行</span>
CC_TO     = "root@localhost"                                         <span class="term_note">&lt;==第11行</span>
MESSAGE   = Your disk usage has exceeded the agreed limits\          <span class="term_note">&lt;==第21行</span>
 on this server|Please delete any unnecessary files on following filesystems:|
SIGNATURE = root@localhost                                           <span class="term_note">&lt;==第25行</span>

<span class="term_say"># 可以将他改成如下的模样啊！</span>
<span class="term_write">SUBJECT   = 注意：你在本系统上拥有的文件容量已经超过最大容许限额
CC_TO     = "root@localhost"  <span class="term_note">&lt;==除非你要寄给其他人，否则这个项目可以不改</span>
MESSAGE   = 你的磁碟容量已经超过本机的容许限额，|\
  请在如下的文件系统中，删除不必要的文件：|
SIGNATURE = 你的系统管理员 (root@localhost)</span>
<span class="term_say"># 在 MESSAGE 内的 | 代表断行的意思，反斜线则代表连接下一行；</span>
</pre></td></tr></tbody></table>

		<p>如果你重复运行 warnquota ，那么 myquota1 就会收到类似如下的信件内容：</p>

<table class="term"><tbody><tr><td class="term"><pre>Subject: 注意：你在本系统上拥有的文件容量已经超过最大容许限额
To: myquota1@www.vbird.tsai
Cc: root@www.vbird.tsai

你的磁碟容量已经超过本机的容许限额，
  请在如下的文件系统中，删除不必要的文件：

/dev/hda3

Filesystem           used    soft    hard  grace    used  soft  hard  grace
/dev/hda3      +-  300000  250000  300000   none      11     0     0

你的系统管理员 (root@localhost)
</pre></td></tr></tbody></table>

		<p>不过这个方法并不适用在 /var/spool/mail 也爆表的 quota 控管中，因为如果使用者在这个 filesystem 
		的容量已经爆表，那么新的信件当然就收不下来啦！此时就只能等待使用者自己发现并跑来这里删除数据，
		或者是请求 root 帮忙处理罗！知道了这玩意儿这么好用，那么我们怎么让系统自动的运行 warnquota 呢？
		你可以这样做：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">vi /etc/cron.daily/warnquota</span>
<span class="term_write">/usr/sbin/warnquota</span>
<span class="term_say"># 你没有看错！只要这一行，且将运行档以绝对路径的方式写入即可！</span>

[root@www ~]# <span class="term_command">chmod 755 /etc/cron.daily/warnquota</span>
</pre></td></tr></tbody></table>

		<p>那么未来每天早上 4:02am 时，这个文件就会主动被运行，那么系统就能够主动的通知磁碟配额爆表的用户罗！
		您瞧瞧！这玩意儿是否很好用啊！至於为何要写入上述的文件呢？留待下一章<a href="0430cron.html">工作排程</a>时我们再来加强介绍罗！<br><br></p>

		<a name="setquota"></a>
		<hr><ul class="list1"><li class="text_import1">setquota ：直接於命令中配置 quota 限额</li></ul>

		<p>如果你想要使用 script 的方法来创建大量的帐号，并且所有的帐号都在创建时就给予 quota ，那该如何是好？
		其实有两个方法可以考虑：</p>
		<ul>
		<li>先创建一个原始 quota 帐号，再以『 <a href="#edquota">edquota</a> -p old -u new 』写入 script 中；</li>
		<li>直接以 setquota 创建用户的 quota 配置值。</li>
		</ul>
		<p>不同於 <a href="#edquota">edquota</a> 是呼叫 vi 来进行配置，setquota 直接由命令输入所必须要的各项限制值。
		他的语法有点像这样：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">setquota [-u|-g] 名称 block(soft) block(hard) \</span>
&gt;  <span class="term_command">inode(soft) inode(hard) 文件系统</span>

<span class="term_hd"># 观察原始的 myquota5 限值，并给予 soft/hard 分别为 100000/200000</span>
[root@www ~]# <span class="term_command">quota -uv myquota5</span>
Disk quotas for user myquota5 (uid 714): 
   Filesystem blocks  quota  limit  grace files  quota  limit  grace
    /dev/hda3     80 <span class="term_write">250000 300000</span>           10      0      0

[root@www ~]# <span class="term_command">setquota -u myquota5 100000 200000 0 0 /home</span>

[root@www ~]# <span class="term_command">quota -uv myquota5</span>
Disk quotas for user myquota5 (uid 714): 
   Filesystem blocks  quota  limit  grace files  quota  limit  grace
    /dev/hda3     80 <span class="term_write">100000 200000</span>           10      0      0
<span class="term_say"># 看吧！真的有改变过来！这就是 quota 的简单脚本配置语法！</span>
</pre></td></tr></tbody></table><br>
	</div>

	<hr><a name="quota_nochange"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">不更动既有系统的 quota 实例</span><br>
	<div class="block2">
		<p>想一想，如果你的主机原先没有想到要配置成为邮件主机，所以并没有规划将邮件信箱所在的 /var/spool/mail/
		目录独立成为一个 partition ，然后目前你的主机已经没有办法新增或分割出任何新的分割槽了。那我们知道 quota 
		是针对整个 filesystem 进行设计的，因此，你是否就无法针对 mail 的使用量给予 quota 的限制呢？</p>

		<p>此外，如果你想要让使用者的邮件信箱与家目录的总体磁碟使用量为固定，那又该如何是好？
		由於 /home 及 /var/spool/mail 根本不可能是同一个 filesystem (除非是都不分割，使用根目录，才有可能整合在一起)，
		所以，该如何进行这样的 quota 限制呢？</p>

		<p>其实没有那么难啦！既然 quota 是针对整个 filesystem 来进行限制，假设你又已经有 /home 这个独立的分割槽了，
		那么你只要：</p>
		<ol>
		<li>将 /var/spool/mail 这个目录完整的移动到 /home 底下；</li>
		<li>利用 ln -s /home/mail /var/spool/mail 来创建连结数据；</li>
		<li>将 /home 进行 quota 限额配置</li>
		</ol>

		<p>只要这样的一个小步骤，嘿嘿！您家主机的邮件就有一定的限额罗！当然罗！您也可以依据不同的使用者与群组来配置
		quota 然后同样的以上面的方式来进行 link 的动作！嘿嘿嘿！就有不同的限额针对不同的使用者提出罗！很方便吧！
		^_^</p>

		<div style="padding: 10pt 0pt;" align="right"><table width="90%"><tbody><tr><td><b>Tips:</b><br><span style="color: rgb(0, 144, 0);"><font size="-1">		朋友们需要注意的是，由於目前新的 distributions 大多有使用 SELinux 的机制，
		因此你要进行如同上面的目录搬移时，在许多情况下可能会有使用上的限制喔！或许你得要先暂时关闭 SELinux 才能测试，
		也或许你得要自行修改 SELinux 的守则才行喔！
		</font></span></td><td><img src="0420quota_files/vbird_face.gif" alt="鸟哥的图示" title="鸟哥的图示"></td></tr></tbody></table></div>	</div>
</div>
<hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
</tbody></table>

<div style="padding-top: 0px; text-align: center;">
<span style="font-size: 80%;">
	<a href="http://linux.vbird.org/" target="_top" title="前往鸟哥的首页">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="联络鸟哥(我不要广告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
         ﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></div>
</div>
</center>
</body></html>
