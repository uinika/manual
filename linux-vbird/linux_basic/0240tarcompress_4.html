<html><head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf8">
	<meta name="Author" content="2011/04/17,lee">
	<meta name="Description" content="对 Linux 文件进行压缩与打包的动作命令介绍">
	<title>鸟哥的 Linux 私房菜 -- Linux 的文件压缩与打包</title>
    <script src="../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../script/index.js" type="text/javascript"></script>
	<link href="../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    </head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html')">

<center>
<div id="apDiv5">
<div> <LINK REL="SHORTCUT ICON" HREF="../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="../linux_server/0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="Mandrake9.0/mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="../linux_server/index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="../linux_server/linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="../linux_server/centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="../linux_server/index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<table summary="本文内容的排版" style="width: 898px;" border="0" cellpadding="0" cellspacing="0">
<tbody><tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
<tr><td style="width: 16px; font-size: 6px;">　</td>
    <td width="866">
<!-- 本文的档头部分 -->
<div style="text-align: center;">
    <a href="0240tarcompress.html">
    <span class="text_head0">第九章、文件与文件系统的压缩与打包</span></a><br>
</div>
    <div style="text-align: right;">
        <span class="text_history">最近升级日期：2009/08/20</span>
    </div>
<!-- 本文的连结区部分 -->
<div class="block1">
<span class="text_h1">
4. <a href="#dump_restore">完整备份工具：dump</a>, <a href="#restore">restore</a><br>
</span></div>
<!-- 本文的正式部分 -->
<hr><a name="dump_restore"></a><img src="../image/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">完整备份工具：dump</span><br>
<div class="block1">
	<p>某些时刻你想要针对文件系统进行备份或者是储存的功能时，不能不谈到这个 dump 命令！
	这玩意儿我们曾在前一章的 <a href="0230filesystem.html#fstab">/etc/fstab</a> 里面稍微谈过。
	其实这个命令除了能够针对整个 filesystem 备份之外，也能够仅针对目录来备份喔！
	底下就让我们来谈一谈这个命令的用法吧！<br><br></p>

	<hr><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">dump</span><br>
	<div class="block2">
		<p>其实 dump 的功能颇强，他除了可以备份整个文件系统之外，还可以制定等级喔！什么意思啊！
		假设你的 /home 是独立的一个文件系统，那你第一次进行过 dump 后，再进行第二次 dump 时，
		你可以指定不同的备份等级，假如指定等级为 1 时，此时新备份的数据只会记录与第一次备份所有差异的文件而已。
		看不懂吗？没关系！我们用一张简图来说明。</p>

		<center><img src="0240tarcompress_files/dump-1.gif" alt="" title="" border="0"><br>
		图 4.1.1、dump 运行的等级 (level)<br></center>

		<p>如上图所示，上方的『即时文件系统』是一直随著时间而变化的数据，例如在 /home 里面的文件数据会一直变化一样。
		而底下的方块则是 dump 备份起来的数据，第一次备份时使用的是 level 0 ，这个等级也是完整的备份啦！
		等到第二次备份时，即时文件系统内的数据已经与 level 0 不一样了，而 level 1 仅只是比较目前的文件系统与 level 0
		之间的差异后，备份有变化过的文件而已。至於 level 2 则是与 level 1 进行比较啦！这样了解呼？</p>

		<p>虽然 dump 支持整个文件系统或者是单一各别目录，但是对於目录的支持是比较不足的，这也是 dump 的限制所在。
		简单的说，如果想要备份的数据如下时，则有不同的限制情况：</p>

		<ul>
		<li><span class="text_import2">当待备份的数据为单一文件系统：</span><br>
		如果是单一文件系统 (filesystem) ，那么该文件系统可以使用完整的 dump 功能，包括利用 0~9 的数个 level 来备份，
		同时，备份时可以使用挂载点或者是装置档名 (例如 /dev/sda5 之类的装置档名) 来进行备份！<br><br></li>

		<li><span class="text_import2">待备份的数据只是目录，并非单一文件系统：</span><br>
		例如你仅想要备份 /home/someone/ ，但是该目录并非独立的文件系统时。此时备份就有限制啦！包括：<br><br>
		<ul class="text_import2"><li>所有的备份数据都必须要在该目录 (本例为：/home/someone/) 底下；</li>
		<li>且仅能使用 level 0 ，亦即仅支持完整备份而已；</li>
		<li>不支持 -u 选项，亦即无法创建 /etc/dumpdates 这个各别 level 备份的时间记录档；</li>
		</ul></li>
		</ul>

		<p>dump 的选项虽然非常的繁复，不过如果只是想要简单的操作时，您只要记得底下的几个选项就很够用了！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">dump [-Suvj] [-level] [-f 备份档] 待备份数据</span>
[root@www ~]# <span class="term_command">dump -W</span>
<span class="term_say">选项与参数：
-S    ：仅列出后面的待备份数据需要多少磁碟空间才能够备份完毕；
-u    ：将这次 dump 的时间记录到 /etc/dumpdates 文件中；
-v    ：将 dump 的文件过程显示出来；
-j    ：加入 bzip2 的支持！将数据进行压缩，默认 bzip2 压缩等级为 2
-level：就是我们谈到的等级，从 -0 ~ -9 共十个等级；
-f    ：有点类似 tar 啦！后面接产生的文件，亦可接例如 /dev/st0 装置档名等
-W    ：列出在 /etc/fstab 里面的具有 dump 配置的 partition 是否有备份过？</span>
</pre></td></tr></tbody></table>

		<hr><ul class="list1"><li class="text_import1">用 dump 备份完整的文件系统</li></ul>

		<p>现在就让我们来做几个范例吧！假如你要将系统的最小的文件系统捉出来进行备份，那该如何进行呢？</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先找出系统中最小的那个文件系统，如下所示：</span>
[root@www ~]# <span class="term_command">df -h</span>
Filesystem            Size  Used Avail Use% Mounted on
/dev/hdc2             9.5G  3.7G  5.3G  42% /
/dev/hdc3             4.8G  651M  3.9G  15% /home
<span class="term_write">/dev/hdc1              99M   11M   83M  12% /boot</span>  <span class="term_note">&lt;==看起来最小的就是他啦！</span>
tmpfs                 363M     0  363M   0% /dev/shm

<span class="term_hd"># 2. 先测试一下，如果要备份此文件系统，需多少容量？</span>
[root@www ~]# <span class="term_command">dump -S /dev/hdc1</span>
5630976     <span class="term_note">&lt;==注意一下，这个单位是 bytes ，所以差不多是 5.6MBytes。</span>

<span class="term_hd"># 3. 将完整备份的档名记录成为 /root/boot.dump ，同时升级记录档：</span>
[root@www ~]# <span class="term_command">dump -0u -f /root/boot.dump /boot</span>
  DUMP: Date of this level 0 dump: Tue Dec  2 02:53:45 2008 <span class="term_note">&lt;==记录等级与备份时间</span>
  DUMP: Dumping /dev/hdc1 (/boot) to /root/boot.dump        <span class="term_note">&lt;==dump的来源与目标</span>
  DUMP: Label: /boot                                        <span class="term_note">&lt;==文件系统的 label</span>
  DUMP: Writing 10 Kilobyte records
  DUMP: mapping (Pass I) [regular files]                    <span class="term_note">&lt;==开始进行文件对应</span>
  DUMP: mapping (Pass II) [directories]
  DUMP: estimated 5499 blocks.                              <span class="term_note">&lt;==评估整体block数量</span>
  DUMP: Volume 1 started with block 1 at: Tue Dec  2 02:53:46 2008
  DUMP: dumping (Pass III) [directories]                    <span class="term_note">&lt;==开始 dump 工作</span>
  DUMP: dumping (Pass IV) [regular files]
  DUMP: Closing /root/boot.dump                             <span class="term_note">&lt;==结束写入备份档</span>
  DUMP: Volume 1 completed at: Tue Dec  2 02:53:47 2008
  DUMP: Volume 1 5550 blocks (5.42MB)                       <span class="term_note">&lt;==最终备份数据容量</span>
  DUMP: Volume 1 took 0:00:01
  DUMP: Volume 1 transfer rate: 5550 kB/s
  DUMP: 5550 blocks (5.42MB) on 1 volume(s)
  DUMP: finished in 1 seconds, throughput 5550 kBytes/sec
  DUMP: Date of this level 0 dump: Tue Dec  2 02:53:45 2008
  DUMP: Date this dump completed:  Tue Dec  2 02:53:47 2008
  DUMP: Average transfer rate: 5550 kB/s
  DUMP: DUMP IS DONE
<span class="term_say"># 在命令的下达方面，dump 后面接 /boot 或 /dev/hdc1 都可以的！
# 而运行 dump 的过程中会出现如上的一些信息，您可以自行仔细的观察！</span>

[root@www ~]# <span class="term_command">ll /root/boot.dump /etc/dumpdates</span>
-rw-rw-r-- 1 root disk      43 Dec  2 02:53 /etc/dumpdates
-rw-r--r-- 1 root root 5683200 Dec  2 02:53 /root/boot.dump
<span class="term_say"># 由於加上 -u 的选项，因此 /etc/dumpdates 该文件的内容会被升级！注意，
# 这个文件仅有在 dump 完整的文件系统时才有支持主动升级的功能。</span>

<span class="term_hd"># 4. 观察一下系统主动创建的记录档：</span>
[root@www ~]# <span class="term_command">cat /etc/dumpdates</span>
/dev/hdc1     0   Tue Dec  2 02:53:47 2008 +0800
<span class="term_say">[文件系统] [等级] [       ctime 的时间         ]</span>
</pre></td></tr></tbody></table>

		<p>这样很简单的就创建起来 /root/boot.dump 文件，该文件将整个 /boot/ 文件系统都备份下来了！
		并且将备份的时间写入 /etc/dumpdates 文件中，准备让下次备份时可以作为一个参考依据。
		现在让我们来进行一个测试，检查看看能否真的创建 level 1 的备份呢？</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 0. 看一下有没有任何文件系统被 dump 过的数据？</span>
[root@www ~]# <span class="term_command">dump -W</span>
Last dump(s) done (Dump '&gt;' file systems):
&gt; /dev/hdc2     (     /) Last dump: <span class="term_write">never</span>
&gt; /dev/hdc3     ( /home) Last dump: <span class="term_write">never</span>
  /dev/hdc1     ( /boot) Last dump: <span class="term_write">Level 0, Date Tue Dec  2 02:53:47 2008</span>
<span class="term_say"># 如上列的结果，该结果会捉出 /etc/fstab 里面第五栏位配置有需要 dump 的 
# partition，然后与 /etc/dumpdates 进行比对，可以得到上面的结果啦！
# 尤其是第三行，可以显示我们曾经对 /dev/hdc1 进行过 dump 的备份动作喔！</span>

<span class="term_hd"># 1. 先恶搞一下，创建一个大约 10 MB 的文件在 /boot 内：</span>
[root@www ~]# <span class="term_command">dd if=/dev/zero of=/boot/testing.img bs=1M count=10</span>
10+0 records in
10+0 records out
10485760 bytes (10 MB) copied, 0.166128 seconds, 63.1 MB/s

<span class="term_hd"># 2. 开始创建差异备份档，此时我们使用 level 1 吧：</span>
[root@www ~]# <span class="term_command">dump -1u -f /root/boot.dump.1 /boot</span>
<span class="term_say">....(中间省略)....</span>

[root@www ~]# <span class="term_command">ll /root/boot*</span>
-rw-r--r-- 1 root root  5683200 Dec  2 02:53 /root/boot.dump
-rw-r--r-- 1 root root <span class="term_write">10547200</span> Dec  2 02:56 /root/boot.dump.1
<span class="term_say"># 看看文件大小，岂不是就是刚刚我们所创建的那个大文件的容量吗？ ^_^</span>

<span class="term_hd"># 3. 最后再看一下是否有记录 level 1 备份的时间点呢？</span>
[root@www ~]# <span class="term_command">dump -W</span>
Last dump(s) done (Dump '&gt;' file systems):
&gt; /dev/hdc2     (     /) Last dump: never
&gt; /dev/hdc3     ( /home) Last dump: never
&gt; /dev/hdc1     ( /boot) Last dump: <span class="term_write">Level 1</span>, Date Tue Dec  2 02:56:33 2008
<span class="term_say">....(中间省略)....</span>
</pre></td></tr></tbody></table>

		<p>透过这个简单的方式，我们就能够仅备份差异文件的部分罗！底下再来看看针对单一目录的 dump 用途！<br><br></p>

		<hr><ul class="list1"><li class="text_import1">用 dump 备份非文件系统，亦即单一目录的方法</li></ul>

		<p>现在让我们来处理一下 /etc 的 dump 备份吧！因为 /etc  并非单一文件系统，他只是个目录而已。
		所以依据限制的说明， -u, level 1~9 都是不适用的。我们只能够使用 level 0 的完整备份将 /etc 给他 dump 
		下来。因此作法就变的很简单了！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 让我们将 /etc 整个目录透过 dump 进行备份，且含压缩功能</span>
[root@www ~]# <span class="term_command">dump -0j -f /root/etc.dump.bz2 /etc</span>
  DUMP: Date of this level 0 dump: Tue Dec  2 12:08:22 2008
  DUMP: Dumping /dev/hdc2 (/ (dir etc)) to /root/etc.dump.bz2

  DUMP: Label: /1
  DUMP: Writing 10 Kilobyte records
  DUMP: Compressing output at compression level 2 (bzlib)
  DUMP: mapping (Pass I) [regular files]
  DUMP: mapping (Pass II) [directories]
  DUMP: estimated 115343 blocks.
  DUMP: Volume 1 started with block 1 at: Tue Dec  2 12:08:23 2008
  DUMP: dumping (Pass III) [directories]
  DUMP: dumping (Pass IV) [regular files]
  DUMP: Closing /root/etc.dump.bz2
  DUMP: Volume 1 completed at: Tue Dec  2 12:09:49 2008
  DUMP: Volume 1 took 0:01:26
  DUMP: Volume 1 transfer rate: 218 kB/s
  DUMP: Volume 1 124680kB uncompressed, 18752kB compressed, 6.649:1
  DUMP: 124680 blocks (121.76MB) on 1 volume(s)
  DUMP: finished in 86 seconds, throughput 1449 kBytes/sec
  DUMP: Date of this level 0 dump: Tue Dec  2 12:08:22 2008
  DUMP: Date this dump completed:  Tue Dec  2 12:09:49 2008
  DUMP: Average transfer rate: 218 kB/s
  DUMP: <span class="term_write">Wrote 124680kB uncompressed, 18752kB compressed, 6.649:1</span>
  DUMP: DUMP IS DONE
<span class="term_say"># 上面特殊字体的部分显示：原本有 124680kb  的容量，被压缩成为 18752kb，
# 整个压缩比为 6.649:1 ，还可以的压缩情况啦！</span>
</pre></td></tr></tbody></table>

		<p>一般来说 dump 不会使用包含压缩的功能，不过如果你想要将备份的空间降低的话，那个 -j 的选项是可以使用的。
		加上 -j 之后你的 dump 成果会使用较少的硬盘容量啦！如上述的情况来看，文件容量由原本的 128MB 左右下滑到
		18MB 左右，当然可以节省备份空间罗！</p>
	</div>

	<hr><a name="restore"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">restore</span><br>
	<div class="block2">
		<p>备份档就是在急用时可以回复系统的重要数据，所以有备份当然就得要学学如何复原了！
		dump 的复原使用的是 restore 这个命令！这个命令的选项也非常的多～您可以自行 man restore 瞧瞧！
		鸟哥在这里仅作个简单的介绍罗！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">restore -t [-f dumpfile] [-h]       </span> <span class="term_note">&lt;==用来察看 dump 档</span>
[root@www ~]# <span class="term_command">restore -C [-f dumpfile] [-D 挂载点]</span> <span class="term_note">&lt;==比较dump与实际文件</span>
[root@www ~]# <span class="term_command">restore -i [-f dumpfile]            </span> <span class="term_note">&lt;==进入互动模式</span>
[root@www ~]# <span class="term_command">restore -r [-f dumpfile]            </span> <span class="term_note">&lt;==还原整个文件系统</span>
<span class="term_say">选项与参数：
相关的各种模式，各种模式无法混用喔！例如不可以写 -tC 啦！
-t  ：此模式用在察看 dump 起来的备份档中含有什么重要数据！类似 tar -t 功能；
-C  ：此模式可以将 dump 内的数据拿出来跟实际的文件系统做比较，
      最终会列出『在 dump 文件内有记录的，且目前文件系统不一样』的文件；
-i  ：进入互动模式，可以仅还原部分文件，用在 dump 目录时的还原！
-r  ：将整个 filesystem 还原的一种模式，用在还原针对文件系统的 dump 备份；
其他较常用到的选项功能：
-h  ：察看完整备份数据中的 inode 与文件系统 label 等资讯
-f  ：后面就接你要处理的那个 dump 文件罗！
-D  ：与 -C 进行搭配，可以查出后面接的挂载点与 dump 内有不同的文件！</span>
</pre></td></tr></tbody></table>

		<hr><ul class="list1"><li class="text_import1">用 restore 观察 dump 后的备份数据内容</li></ul>

		<p>要找出 dump 的内容就使用 restore -t 来查阅即可！例如我们将 boot.dump 的文件内容捉出来看看！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">restore -t -f /root/boot.dump </span>
Dump   date: Tue Dec  2 02:53:45 2008              <span class="term_note">&lt;==说明备份的日期</span>
Dumped from: the epoch
Level 0 dump of /boot on www.vbird.tsai:/dev/hdc1  <span class="term_note">&lt;==说明 level 状态</span>
Label: /boot                                       <span class="term_note">&lt;==说明该 filesystem 的表头！</span>
         2      .
        11      ./lost+found
      2009      ./grub
      2011      ./grub/grub.conf
<span class="term_say">....底下省略....</span>

[root@www ~]# <span class="term_command">restore -t -f /root/etc.dump</span>
Dump tape is compressed.                          <span class="term_note">&lt;==加注说明数据有压缩</span>
Dump   date: Tue Dec  2 12:08:22 2008
Dumped from: the epoch
Level 0 dump of <span class="term_write">/ (dir etc)</span> on www.vbird.tsai:/dev/hdc2 <span class="term_note">&lt;==是目录！</span>
Label: /1
         2      .
   1912545      ./etc
   1912549      ./etc/rpm
   1912550      ./etc/rpm/platform
<span class="term_say">....底下省略....</span>
</pre></td></tr></tbody></table>

		<p>这个查阅的数据其实显示出的是档名与原始文件的 inode 状态，所以我们可以说， dump 会参考 inode 的记录哩！
		透过这个查询我们也能知道 dump 的内容为何呢！再来查一查如何还原吧！<br><br></p>

		<hr><ul class="list1"><li class="text_import1">比较差异并且还原整个文件系统</li></ul>

		<p>为什么 dump 可以进行累积备份呢？就是因为他具有可以查询文件系统与备份文件之间的差异，
		并且将分析到的差异数据进行备份的缘故。所以我们先来看看，如何查询有变动过的资讯呢？你可以使用如下的方法检验：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 0. 先尝试变更文件系统的内容：</span>
[root@www ~]# <span class="term_command">cd /boot</span>
[root@www boot]# <span class="term_command">mv config-2.6.18-128.el5 config-2.6.18-128.el5-back</span>

<span class="term_hd"># 1. 看使进行文件系统与备份文件之间的差异！</span>
[root@www boot]# <span class="term_command">restore -C -f /root/boot.dump</span>
Dump   date: Tue Dec  2 02:53:45 2008
Dumped from: the epoch
Level 0 dump of /boot on www.vbird.tsai:/dev/hdc1
Label: /boot
filesys = /boot
<span class="term_write">restore: unable to stat ./config-2.6.18-128.el5: No such file or directory
Some files were modified!  1 compare errors</span>
<span class="term_say"># 看到上面的特殊字体了吧！那就是有差异的部分！总共有一个文件被变更！
# 我们刚刚确实有更动过该文件，嘿嘿！这样是否能了解？！</span>

<span class="term_hd"># 2. 将文件系统改回来啊！</span>
[root@www boot]# <span class="term_command">mv config-2.6.18-128.el5-back config-2.6.18-128.el5</span>
[root@www boot]# <span class="term_command">cd /root</span>
</pre></td></tr></tbody></table>

		<p>如同上面的动作，透过曾经备份过的资讯，也可以找到与目前实际文件系统中有差异的数据呢！
		如果你不想要进行累积备份，但也能透过这个动作找出最近这一阵子有变动过的文件说！了解乎？
		那如何还原呢？由於 dump 是记录整个文件系统的，因此还原时你也应该要给予一个全新的文件系统才行。
		因此底下我们先创建一个文件系统，然后再来还原吧！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先创建一个新的 partition 来使用，假设我们需要的是 150M 的容量</span>
[root@www ~]# <span class="term_command">fdisk /dev/hdc</span>
Command (m for help): <span class="term_command">n</span>
First cylinder (2335-5005, default 2335): <span class="term_note">&lt;==这里按 Enter</span>
Using default value 2335
Last cylinder or +size or +sizeM or +sizeK (2335-5005, default 5005): <span class="term_command">+150M</span>
Command (m for help): <span class="term_command">p</span>
<span class="term_say">....中间省略....</span>
<span class="term_write">/dev/hdc8            2335        2353      152586   83  Linux</span>

Command (m for help): <span class="term_command">w</span>

[root@www ~]# <span class="term_command">partprobe</span>   <span class="term_note">&lt;==很重要的动作！别忘记！</span>
<span class="term_say"># 这样就能够创建一个 /dev/hdc8 的 partition ，然后继续格式化吧！</span>

[root@www ~]# <span class="term_command">mkfs -t ext3 /dev/hdc8</span>
[root@www ~]# <span class="term_command">mount /dev/hdc8 /mnt</span>

<span class="term_hd"># 2. 开始进行还原的动作！请您务必到新文件系统的挂载点底下去！</span>
[root@www ~]# <span class="term_command">cd /mnt</span>
[root@www mnt]# <span class="term_command">restore -r -f /root/boot.dump</span>
restore: ./lost+found: File exists
</pre></td></tr></tbody></table>

		<p>由於我们是备份整个文件系统，因此你也可以建置一个全新的文件系统 (partition) 来进行还原的动作！
		整个还原的动作也不难，如上表最后一个命令，就是将<span class="text_import2">备份文件中的数据还原到本目录下</span>。
		你必须要变更目录到挂载点所在的那个目录才行啊！这样还原的文件才不会跑错地方！如果你还想要将 level 1 的
		/root/boot.dump.1 那个文件的内容也还原的话，那就继续使用『restore -r -f /root/boot.dump.1』去还原吧！<br><br></p>

		<hr><ul class="list1"><li class="text_import1">仅还原部分文件的 restore 互动模式</li></ul>

		<p>某些时候你只是要将备份档的某个内容捉出来而已，并不想要全部解开，那该如何是好？此时你可以进入 restore
		的互动模式 (interactive mode)。在底下我们使用 etc.dump 来进行范例说明。假如你要将 etc.dump 
		内的 passwd 与 shadow 捉出来而已，该如何进行呢？</p>
 
<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">cd /mnt</span>
[root@www mnt]# <span class="term_command">restore -i -f /root/etc.dump</span>
restore &gt; <span class="term_command"></span>
<span class="term_say"># 此时你就已经进入 restore 的互动模式画面中！要注意的是：
# 你目前已经在 etc.dump 这个文件内了！所有的动作都是在 etc.dump 内！</span>

restore &gt; <span class="term_command">help</span>
Available commands are:
        ls [arg] - list directory          <span class="term_note">&lt;==列出 etc.dump 内的文件或目录</span>
        cd arg - change directory          <span class="term_note">&lt;==在 etc.dump 内变更目录</span>
        pwd - print current directory      <span class="term_note">&lt;==列出在 etc.dump 内的路径档名</span>
        add [arg] - add `arg' to list of files to be extracted 
        delete [arg] - delete `arg' from list of files to be extracted
        extract - extract requested files
<span class="term_say"># 上面三个命令是重点！各命令的功能为：
# add file    ：将 file 加入等一下要解压缩的文件列表中
# delete file ：将 file 移除出解压缩的列表，并非删除 etc.dump 内的文件！别误会！^_^
# extract     ：开始将刚刚选择的文件列表解压缩了去！</span>
        setmodes - set modes of requested directories
        quit - immediately exit program
        what - list dump header information
        verbose - toggle verbose flag (useful with ``ls'')
        prompt - toggle the prompt display
        help or `?' - print this list

restore &gt; <span class="term_command">ls</span>
.:
etc/  <span class="term_note">&lt;==会显示出在 etc.dump 内主要的目录，因为我们备份 /etc ，所以档名为此！</span>

restore &gt; <span class="term_command">cd etc                 </span> <span class="term_note">&lt;==在 etc.dump 内变换路径到 etc 目录下</span>
restore &gt; <span class="term_command">pwd                    </span> <span class="term_note">&lt;==列出本目录的档名为？</span>
/etc
restore &gt; <span class="term_command">ls passwd shadow group </span> <span class="term_note">&lt;==看看，真的有这三个文件喔！</span>
passwd
shadow
group
restore &gt; <span class="term_command">add passwd shadow group</span> <span class="term_note">&lt;==加入解压缩列表</span>
restore &gt; <span class="term_command">delete group           </span> <span class="term_note">&lt;==加错了！将 group 移除解压缩列表</span>
restore &gt; <span class="term_command">ls passwd shadow group</span>
<span class="term_write">*passwd  <span class="term_note">&lt;==有要被解压缩的，档名之前会出现 * 的符号呢！</span>
*shadow</span>
group
restore &gt; <span class="term_command">extract                </span> <span class="term_note">&lt;==开始进行解压缩去！</span>
You have not read any volumes yet.   <span class="term_note">&lt;==这里会询问你需要的volume</span>
Unless you know which volume your file(s) are on you should start
with the last volume and work towards the first.
Specify next volume # (none if no more volumes): <span class="term_command">1</span> <span class="term_note">&lt;==只有一个 volume</span>
set owner/mode for '.'? [yn] <span class="term_command">n</span> <span class="term_note">&lt;==不需要修改权限</span>

restore &gt; <span class="term_command">quit                   </span> <span class="term_note">&lt;==离开 restore 的功能</span>

[root@www ~]# <span class="term_command">ll -d etc</span>
drwxr-xr-x 2 root root 1024 Dec 15 17:49 etc  <span class="term_note">&lt;==解压缩后，所创建出来的目录啦！</span>
[root@www ~]# <span class="term_command">ll etc</span>
total 6
-rw-r--r-- 1 root root 1945 Sep 29 02:21 passwd
-r-------- 1 root root 1257 Sep 29 02:21 shadow
</pre></td></tr></tbody></table>

		<p>透过互动式的 restore 功能，可以让你将备份的数据取出一部份，而不必全部都得解压缩才能够取得你想要的文件数据。
		而 restore 内的 add 除了可以添加文件外，也能够添加整个备份的『目录』喔！还不错玩吧！
		赶紧测试看看先！ ^_^</p>
	</div>
</div>
<hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
</tbody></table>

<div style="padding-top: 0px; text-align: center;">
<span style="font-size: 80%;">
	<a href="http://linux.vbird.org/" target="_top" title="前往鸟哥的首页">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="联络鸟哥(我不要广告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
         ﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></div>
</div>
</center>
</body></html>
