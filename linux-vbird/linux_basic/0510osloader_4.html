<html><head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="Author" content="2011/04/20,white">
	<meta name="Description" content="整个 Linux 系统下的开关机流程介绍，以及启动管理软件的介绍">
	<title>鸟哥的 Linux 私房菜 -- 启动关机流程与 Loader</title>
    <script src="../script/SpryMenuBar.js" type="text/javascript"></script>
	<script src="../script/index.js" type="text/javascript"></script>
	<link href="../css/SpryMenuBarHorizontal.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    </head><body style="margin: 0pt; padding: 0pt;" class="table"onload="MM_preloadImages('../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html','../index-2.html')">

<center>
<div id="apDiv5">
<div> <LINK REL="SHORTCUT ICON" HREF="../index-2.html">
<!-- ImageReady Slices (title3.ai) -->
<table id="___01" width="898" height="81" border="0" align="center" cellpadding="0" cellspacing="0";>
	<tr>
		<td colspan="15">
			<img src="image/title/title_01.png" width="900" height="1" alt=""></td>
	</tr>
	<tr>
		<td rowspan="4" bgcolor="#182448"><p><img src="http://linux.vbird.org/cgi-bin/Count.cgi?dd=C&amp;ft=5&amp;sh=T&amp;md=8&amp;pad=Y&amp;df=vbird.dic.ksu.edu.tw.dat" width="93" align="left" title="計數器" /></p>
	    <p><font color="#FFFFFF" size="-1">since2012/04/23</font></p></td>
		<td rowspan="4" align="left" valign="top"><a href="../index.html"><img src="image/title/title_03.png" alt="" width="263" height="79" border="0"></a></td>
		<td colspan="13">
			<img src="image/title/title_04.png" alt="" width="535" height="9" border="0"></td>
	</tr>
	<tr>
		<td rowspan="3">
			<img src="image/title/title_05.png" alt="" width="53" height="70" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="0110whatislinux.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image51','','image/title/title_06.png',1)"><img src="image/title/title3_06.png" name="Image51" width="106" height="25" border="0" id="Image51" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_07.png" alt="" width="27" height="37" border="0"></td>
		<td colspan="3" align="left" valign="top"><a href="../linux_server/0110network_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image52','','image/title/title_08.png',1)"><img src="image/title/title3_08.png" name="Image52" width="107" height="25" border="0" id="Image52" alt=""/></a></td>
		<td rowspan="2">
			<img src="image/title/title_09.png" alt="" width="37" height="37" border="0"></td>
		<td colspan="2" align="left" valign="top"><a href="../about.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image53','','image/title/title_10.png',1)"><img src="image/title/title3_10.png" name="Image53" width="75" height="25" border="0" id="Image53" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_11.png" alt="" width="35" height="70" border="0"></td>
		<td align="left" valign="top"><a href="mailto:vbird@mail.vbird.idv.tw" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image54','','image/title/title_12.png',1)"><img src="image/title/title3_12.png" name="Image54" width="74" height="25" border="0" id="Image54" alt=""/></a></td>
		<td rowspan="3">
			<img src="image/title/title_13.png" alt="" width="21" height="70" border="0"></td>
	</tr>
	<tr>
		<td colspan="2">
			<img src="image/title/title_14.png" alt="" width="106" height="12" border="0"></td>
		<td colspan="3">
			<img src="image/title/title_15.png" alt="" width="107" height="12" border="0"></td>
		<td colspan="2">
			<img src="image/title/title_16.png" width="75" height="12" alt=""></td>
		<td rowspan="2">
			<img src="image/title/title_17.png" alt="" width="74" height="45" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/title_18.png" alt="" width="15" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar1" class="MenuBarHorizontal">
	  <li><a href="linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image44','','image/title/title_19.png',1)"><img src="image/title/title3_19.png" name="Image44" width="123" height="33" border="0" id="Image44" /></a>
			    <ul>
			      <li><a href="Mandrake9.0/mandrake9.0.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image46','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image46" width="120" height="26" border="0" id="Image46" alt="" /></a></li>
                  <li><a href="fedora_4/fc4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image47','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image47" width="120" height="26" border="0" id="Image47" alt="" /></a></li>
                  <li><a href="linux_basic.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image48','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image48" width="120" height="26" border="0" id="Image48" alt="" /></a></li>
                </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_20.png" alt="" width="42" height="33" border="0"></td>
		<td colspan="3" align="left" valign="top"><ul id="MenuBar2" class="MenuBarHorizontal">
	  <li><a href="../linux_server/index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image45','','image/title/title_21.png',1)"><img src="image/title/title3_21.png" name="Image45" width="125" height="33" border="0" id="Image45" /></a>
			    <ul>
			      <li><a href="../linux_server/linux_redhat9/redhat9.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image43','','image/title/title_26.png',1)"><img src="image/title/title_23.png" name="Image43" width="120" height="26" border="0" id="Image43" alt=""/></a></li>
			      <li><a href="../linux_server/centos4.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image49','','image/title/title_27.png',1)"><img src="image/title/title_24.png" name="Image49" width="120" height="26" border="0" id="Image49" alt="" /></a></li>
			      <li><a href="../linux_server/index.html" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image50','','image/title/title_28.png',1)"><img src="image/title/title_25.png" name="Image50" width="120" height="26" border="0" id="Image50" alt="" /></a></li>
		        </ul>
		      </li>
		</ul></td>
		<td>
			<img src="image/title/title_22.png" alt="" width="47" height="33" border="0"></td>
	</tr>
	<tr>
		<td>
			<img src="image/title/Spacer.gif" width="101" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="263" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="53" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="15" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="91" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="27" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="5" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="42" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="60" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="37" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="28" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="47" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="35" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="74" height="1" alt=""></td>
		<td>
			<img src="image/title/Spacer.gif" width="22" height="1" alt=""></td>
	</tr>
</table>
<!-- End ImageReady Slices -->
<script type="text/javascript">
<!--
var MenuBar1 = new Spry.Widget.MenuBar("MenuBar1", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
var MenuBar2 = new Spry.Widget.MenuBar("MenuBar2", {imgDown:"SpryAssets/SpryMenuBarDownHover.gif", imgRight:"SpryAssets/SpryMenuBarRightHover.gif"});
//-->
</script>
</div>
<table summary="本文内容的排版" style="width: 898px;" border="0" cellpadding="0" cellspacing="0">
<tbody><tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
<tr><td style="width: 16px; font-size: 6px;">　</td>
    <td width="866">
<!-- 本文的档头部分 -->
<div style="text-align: center;">
    <a href="0510osloader.html">
    <span class="text_head0">第二十章、启动流程、模块管理与<span class="text_head_en"> Loader</span></span></a><br>
</div>
    <div style="text-align: right;">
        <span class="text_history">最近升级日期：2009/09/14</span>
    </div>
<!-- 本文的连结区部分 -->
<div class="block1">
<span class="text_h1">
4. <a href="#solution">启动过程的问题解决</a><br>
	<span class="text_h2">
	　　4.1 <a href="#solution_root">忘记 root 口令的解决之道</a><br>
	　　4.2 <a href="#solution_init">init 配置档错误</a><br>
	　　4.3 <a href="#solution_hd">BIOS 磁碟对应的问题 (device.map)</a><br>
	　　4.4 <a href="#solution_config">因文件系统错误而无法启动</a><br>
	　　4.5 <a href="#solution_chroot">利用 chroot 切换到另一颗硬盘工作</a><br>
	</span>
</span></div>
<!-- 本文的正式部分 -->
<hr><a name="solution"></a><img src="../image/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">启动过程的问题解决</span><br>
<div class="block1">
	<p>很多时候，我们可能因为做了某些配置，或者是因为不正常关机 (例如未经通知的停电等等) 而导致系统的
	filesystem 错乱，此时，Linux 可能无法顺利启动成功，那怎么办呢？难道要重灌？当然不需要啦！
	进入 run level 1 (单人维护模式) 去处理处理，应该就 OK 的啦！底下我们就来谈一谈如何处理几个常见的问题！<br><br></p>

	<hr><a name="solution_root"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">忘记 root 口令的解决之道</span><br>
	<div class="block2">
		<p>大家都知道鸟哥的记忆力不佳，容易忘东忘西的，那如果连 root 的口令都忘记了，怎么办？
		其实在 Linux 环境中 root 口令忘记时还是可以救回来的！只要能够进入并且挂载 / ，
		然后重新配置一下 root 的口令，就救回来啦！这是因为启动流程中，若强制核心进入 runlevel 1 时，
		默认是不需要口令即可取得一个 root 的 shell 来救援的。整个动作有点像这样：</p>

		<ol>
		<li>重新启动！一定要重新启动！怎么重开都没关系；<br><br></li>

		<li>在启动进入 grub 菜单后， (1)在你要进入的菜单上面点 'e' 进入详细配置； (2)将光棒移动到 kernel 
		上方并点 'e' 进入编辑画面； (3)然后出现如下画面来处理：<br>

<table class="term"><tbody><tr><td class="term"><pre>grub edit&gt; kernel /vmlinuz-2.6.18-92.el5 ro root=LABEL=/ rhgb quiet <span class="term_write">single</span>
</pre></td></tr></tbody></table>

		重点就是那个特殊字体的咚咚啦！按下 [enter] 再按下 b 就能够启动进入单人维护模式了。<br><br></li>

		<li>进入单人维护模式后，系统会以 root 的权限直接给你一个 shell ，此时你就能够运行『 passwd 』这个命令来重建 root 
		的口令啦！然后直接『 init 5 』就可以切换成为 X 窗口介面罗！就是这么简单。</li>
		</ol>
	</div>

	<hr><a name="solution_init"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">init 配置档错误</span><br>
	<div class="block2">
		<p>前一个 root 口令挽救的方法其实可以用在很多地方，唯一一个无法挽救的情况，那就是 /etc/inittab 
		这个文件配置错误导致的无法启动！根据启动流程，我们知道 runlevel 0~6 都会读取 /etc/inittab 配置档，
		因此你使用 single mode (runlevel 1) 当然也是要读取 /etc/inittab 来进行启动的。那既然无法进入单人维护模式，
		就表示这题无解罗？非也非也，既然默认的 init 无法运行，那我们就告诉核心不要运行 init ，改呼叫 bash 啊！
		可以略过 init 吗？可以的，同样在启动进入 grub 后，同样在 grub edit 的情况下这样做：</p>

<table class="term"><tbody><tr><td class="term"><pre>grub edit&gt; kernel /vmlinuz-2.6.18-92.el5 ro root=LABEL=/ rhgb quiet <span class="term_write">init=/bin/bash</span>
</pre></td></tr></tbody></table>

		<p>因为我们指定了核心呼叫的第一支程序 (init) 变成 /bin/bash，因此 /sbin/init 就不会被运行。
		又根据启动流程的说明，我们知道此时虽然可以利用 root 取得 bash 来工作，但此时 (1)除了根目录外，其他的目录都没有被挂载；
		(2)根目录被挂载成为唯读状态。因此我们还需要进行一些动作才行！如下所示：</p>

		<center><img src="0510osloader_files/grub-05.jpg" alt="直接进入 bash 的环境" title="直接进入 bash 的环境" border="1"><br>
		图 4.2.1、 略过 init 的程序，直接进入 bash shell<br></center>

		<p>鸟哥仅下达两个命令，『 mount -o remount,rw / 』用途是将根目录重新挂载成为可读写，<span class="text_import2">至於『 mount -a 』则是参考 /etc/fstab 的内容重新挂载文件系统</span>！
		此时你又可以启动进行救援的工作了！只是救援完毕后，你得要使用『 reboot 』重新启动一次才行！</p>
	</div>

	<hr><a name="solution_hd"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">BIOS 磁碟对应的问题 (device.map)</span><br>
	<div class="block2">
		<p>由於目前硬盘很便宜啊，所以很多朋友就想说：『那我能不能将 Windows 安装在 /dev/hda 而 Linux 安装在 /dev/hdb ，
		然后调整 BIOS 的启动装置顺序，如此则两套系统各有各的 loader 安装在个别硬盘的 MBR 当中了！』。
		这个想法非常好，如此一来两者就不会互相干扰，因为每颗磁碟的 MBR 个别有不同操作系统的 loader 嘛！
		问题是，<span class="text_import2">grub 对磁碟的装置代号使用的是侦测到的顺序</span>啊！
		也就是说，你调整了 BIOS 磁碟启动顺序后，你的 menu.lst 内的装置代号就可能会对应到错误的磁碟上了！啊！真想哭！</p>

		<p>没关系的，我们可以透过 /boot/grub/device.map 这个文件来写死每个装置对 grub 磁碟代号的对应喔！
		举例来说，鸟哥的这个文件内容如下：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">cat /boot/grub/device.map</span>
(fd0)   /dev/fd0
(hd0)   /dev/hda
</pre></td></tr></tbody></table>

		<p>如果你不清楚如何处理的话，也可以利用 grub-install 的功能喔！例如：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">grub-install --recheck /dev/hda1</span>
</pre></td></tr></tbody></table>

		<p>这样 device.map 就会主动的被升级了！这样了解乎？</p>
	</div>

	<hr><a name="solution_config"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">因文件系统错误而无法启动</span><br>
	<div class="block2">
		<p>如果因为配置错误导致无法启动时，要怎么办啊？这就更简单了！最容易出错的配置而导致无法顺利启动的步骤，通常就是 
		/etc/fstab 这个文件了，尤其是使用者在<a href="0420quota.html">实作 Quota</a> 时，最容易写错参数，
		又没有经过 mount -a 来测试挂载，就立刻直接重新启动，真要命！无法启动成功怎么办？
		这种情况的问题大多如下面的画面所示：</p>

		<center><img src="0510osloader_files/grub-06.jpg" alt="文件系统错误的示意图" title="文件系统错误的示意图" border="1"><br>
		图 4.4.1、 文件系统错误的示意图<br></center>

		<p>看到最后两行，他说可以输入 root 的口令继续加以救援喔！那请输入 root 的口令来取得 bash 并以
		mount -o remount,rw / 将根目录挂载成可读写后，继续处理吧！其实会造成上述画面可能的原因除了 /etc/fstab
		编辑错误之外，如果你曾经不正常关机后，也可能导致文件系统不一致 (Inconsistent) 的情况，
		也有可能会出现相同的问题啊！如果是磁区错乱的情况，请看到上图中的第二行处， fsck 告知其实是 /dev/md0 出错，
		此时你就应该要利用 fsck 去检测 /dev/md0 才是！等到系统发现错误，并且出现『clear [Y/N]』时，输入『 y 』吧！</p>

		<p>这个 fsck 的过程可能会很长，而且如果你的 partition 上面的 filesystem 有过多的数据损毁时，
		即使 fsck 完成后，可能因为伤到系统槽，导致某些关键系统文件数据的损毁，那么依旧是无法进入 Linux 
		的。此时，就好就是将系统当中的重要数据复制出来，然后重新安装，并且检验一下，
		是否实体硬盘有损伤的现象才好！不过一般来说，不太可能会这样啦～
		通常都是 fsck 处理完毕后，就能够顺利再次进入 Linux 了。</p>
	</div>

	<hr><a name="solution_chroot"></a><img src="../image/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">利用 chroot 
	切换到另一颗硬盘工作</span><br>
	<div class="block2">
		<p>仔细检查一下，你的 Linux 里面应该会有一个名为 chroot 的命令才对！这是啥？
		这是『 change root directory 』的意思啦！意思就是说，可以暂时将根目录移动到某个目录下，
		然后去处理某个问题，最后再离开该 root 而回到原本的系统当中。</p>

		<p>举例来说，补习班中心最容易有两三个 Linux 系统在同一个主机上面，假设我的第一个 Linux
		无法进入了，那么我可以使用第二个 Linux 启动，然后在第二个 Linux 系统下将第一个 Linux 挂载起来，
		最后用 chroot 变换到第一个 Linux ，就能够进入到第一个 Linux 的环境当中去处理工作了。</p>

		<p>你同样也可以将你的 Linux 硬盘拔到另一个 Linux 主机上面去，然后用这个 chroot 来切换，
		以处理你的硬盘问题啊！那怎么做啊？粉简单啦！</p>

		<ol>
		<li>用尽任何方法，进入一个完整的 Linux 系统 ( run level 3 或 5 )；<br><br></li>

		<li>假设有问题的 Linux 磁碟在 /dev/hdb1 上面，且他整个系统的排列是：<br>
<pre>	挂载点   装置档名
	/     → /dev/hdb1
	/var  → /dev/hdb2
	/home → /dev/hdb3
	/usr  → /dev/hdb5</pre>
		若如此的话，那么在我目前的这个 Linux 底下，我可以创建一个目录，然后可以这样做：<br>
<pre>	挂载点           装置档名
	/chroot/      → /dev/hdb1
	/chroot/var/  → /dev/hdb2
	/chroot/home/ → /dev/hdb3
	/chroot/usr/  → /dev/hdb5</pre></li>

		<li>全部挂载完毕后，再输入『 chroot /chroot 』嘿嘿！你就会发现，怎么根目录 (/) 
		变成那个 /dev/hdb1 的环境啦！这样说明，了了吗？ ^_^</li>
		</ol>
	</div>
</div>
<hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</td></tr>
</tbody></table>

<div style="padding-top: 0px; text-align: center;">
<span style="font-size: 80%;">
	<a href="http://linux.vbird.org/" target="_top" title="前往鸟哥的首页">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="联络鸟哥(我不要广告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
         ﻿<div id="apDiv4">
      <p>本网页主要以Firefox配合解析度 1024x768 作为设计依据&nbsp;&nbsp;&nbsp;&nbsp; 鸟哥自由软件整合应用研究室</p></div></div>
</div>
</center>
</body></html>
